
# Redis
## ä¸€. ç¼“å­˜
### 1. ç¼“å­˜å‡»ç©¿
#### åŸå› 
æŸ¥è¯¢ä¸€ä¸ªç¼“å­˜å’Œæ•°æ®åº“éƒ½æ²¡æœ‰çš„æ•°æ®æ—¶ï¼Œä¼šç©¿è¿‡ç¼“å­˜ç›´æ¥æŸ¥è¯¢æ•°æ®åº“ï¼Œä¸”ä¸ä¼šå†™å›åˆ°ç¼“å­˜ä¸­
#### è§£å†³
ï¼ˆ1ï¼‰ å…è®¸ç¼“å­˜å­˜å‚¨nullå€¼ï¼Œè‹¥ä¸å­˜åœ¨æ•°æ®çš„keyè¿‡å¤šä¼šå¯¼è‡´ç¼“å­˜å†…å­˜å ç”¨è¾ƒå¤§
ï¼ˆ2ï¼‰æ·»åŠ å¸ƒéš†è¿‡æ»¤å™¨ï¼Œåˆ¤æ–­ä¸€ä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨äºé›†åˆä¸­ï¼Œå®ç°åŸç†æ˜¯ï¼Œå¸ƒéš†è¿‡æ»¤å™¨æ˜¯ä¸€ä¸ªbitmapï¼Œå­˜å‚¨äºŒè¿›åˆ¶çš„æ•°ç»„ï¼ŒåŠ è½½æ•°æ®åˆ°ç¼“å­˜ä¸­æ—¶ï¼Œå¯¹keyè¿›è¡Œå¤šæ¬¡hashå‡½æ•°è¿ç®—å°†å¾—åˆ°çš„ç´¢å¼•å¯¹åº”çš„å…ƒç´ ç½®ä¸º1ï¼Œå½“è¿›è¡ŒæŸ¥è¯¢ç¼“å­˜æ—¶ï¼Œä¼šå¯¹keyè¿›è¡Œç›¸åŒçš„hashè¿ç®—åˆ¤æ–­ç»“æœç´¢å¼•å¤„çš„å€¼æ˜¯å¦éƒ½æ˜¯1ï¼Œå¦‚æœä¸æ˜¯åˆ™ç›´æ¥è¿”å›ç¼“å­˜ä¸­æ²¡æœ‰è¿™ä¸ªkeyçš„æ•°æ®ï¼Œä½†æ˜¯æŸ¥è¯¢çš„keyè¿›è¡Œhashè¿ç®—çš„ç»“æœä¼šå’Œå…¶ä»–keyçš„è¿ç®—ç»“æœæœ‰é‡å¤ï¼Œå¯¼è‡´ä¸å­˜åœ¨æ•°æ®çš„keyè¯¯åˆ¤ä¸ºæœ‰æ•°æ®ï¼Œäº§ç”Ÿè¯¯å·®
### 2. ç¼“å­˜ç©¿é€
#### åŸå› 
çƒ­ç‚¹keyåˆšå¥½è¿‡æœŸï¼Œä¸”æœ‰å¤§é‡è¯·æ±‚è¿›å…¥æŸ¥è¯¢è¿™ä¸ªkeyçš„æ•°æ®ï¼Œå¯¼è‡´æ•°æ®åº“å‹åŠ›è¿‡å¤§å®•æœº
#### è§£å†³
ï¼ˆ1ï¼‰æ·»åŠ äº’æ–¥é”ï¼ˆåˆ†å¸ƒå¼é”ï¼‰ çº¿ç¨‹ä¸€---->ç¼“å­˜ä¸­keyè¿‡æœŸ---->æ·»åŠ äº’æ–¥é”---->æŸ¥è¯¢æ•°æ®åº“å¹¶å†™å›ç¼“å­˜---->é‡Šæ”¾é”
å…¶ä»–çº¿ç¨‹åªèƒ½ä¸æ–­é‡è¯•  > æŸ¥è¯¢ç¼“å­˜+å°è¯•æŠ¢å¤ºäº’æ–¥é”  è¿™ä¸ªè¿‡ç¨‹
ä½å¯ç”¨ï¼Œé«˜ä¸€è‡´
ï¼ˆ2ï¼‰é€»è¾‘åˆ é™¤  ç»´æŠ¤ç¼“å­˜æ•°æ®ä¸­çš„è¿‡æœŸå­—æ®µï¼Œå½“çº¿ç¨‹å‘ç°ç¼“å­˜æ•°æ®å·²ç»è¿‡æœŸä¼šæ·»åŠ äº’æ–¥é”ï¼Œå¹¶å¼€å¯å¼‚æ­¥çº¿ç¨‹è¿›è¡Œæ•°æ®åº“çš„æŸ¥è¯¢ï¼Œå†™å›ç¼“å­˜å¹¶é‡ç½®è¿‡æœŸæ—¶é—´ï¼Œé‡Šæ”¾é”ï¼Œçº¿ç¨‹åœ¨å¼€å¯å¼‚æ­¥çº¿ç¨‹ä¹‹åä¼šç›´æ¥è¿”å›æ—§æ•°æ®ï¼Œå…¶ä»–çº¿ç¨‹è‹¥æ²¡æœ‰æŠ¢å åˆ°äº’æ–¥é”ä¹Ÿä¼šç›´æ¥è¿”å›æ—§æ•°æ®ï¼Œé«˜å¯ç”¨ï¼Œä½ä¸€è‡´
### 3. ç¼“å­˜é›ªå´©æˆ–æœåŠ¡å™¨å®•æœº
#### åŸå› 
å¤§é‡keyåœ¨åŒä¸€æ—¶é—´åŒæ—¶è¿‡æœŸï¼Œå¤§é‡è¯·æ±‚æ¶Œå…¥ï¼Œå¯¼è‡´æ•°æ®åº“å‹åŠ›è¿‡å¤§å®•æœº
#### è§£å†³
ï¼ˆ1ï¼‰ç»™ä¸åŒçš„keyè®¾ç½®éšæœºçš„TTL
ï¼ˆ2ï¼‰è®¾è®¡å¤šçº§ç¼“å­˜
ï¼ˆ3ï¼‰é™çº§é™æµï¼Œæµé‡å‰Šå³°ï¼Œå‡å°‘æœåŠ¡å™¨å‹åŠ›
ï¼ˆ4ï¼‰éƒ¨ç½²é›†ç¾¤ï¼Œæé«˜æœåŠ¡é«˜å¯ç”¨æ€§
### 4. åŒå†™ä¸€è‡´æ€§
#### åŸå› 
ç¼“å­˜æ•°æ®å’Œæ•°æ®åº“æ•°æ®ä¸ä¸€è‡´
#### è§£å†³
å¼ºä¸€è‡´ï¼šï¼ˆ1ï¼‰å»¶è¿ŸåŒåˆ    å…ˆåˆ ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“ï¼Œå»¶è¿Ÿä¸€å®šæ—¶é—´åå†æ¬¡åˆ é™¤ç¼“å­˜ï¼Œæœ‰å»¶è¿Ÿæ—¶é—´æ˜¯å› ä¸ºä¸»ä»åº“æ•°æ®åŒæ­¥éœ€è¦ä¸€å®šæ—¶é—´ï¼Œä¿è¯äºŒæ¬¡åˆ é™¤ç¼“å­˜åè¿›å…¥æ•°æ®åº“æŸ¥è¯¢çš„æ•°æ®æ˜¯æœ€æ–°çš„ï¼Œå› ä¸ºå»¶è¿Ÿçš„æ—¶é—´ä¸å¥½æŠŠæ¡ï¼Œæ‰€ä»¥ä»ç„¶ä¼šæœ‰ä¸€å®šçš„ä¸ä¸€è‡´
		å…ˆåˆ ç¼“å­˜å†æ›´æ–°æ•°æ®åº“  çº¿ç¨‹ ä¸€åœ¨åˆ é™¤å®Œç¼“å­˜åï¼Œæ•°æ®åº“æ›´æ–°æœªå®Œæˆï¼Œçº¿ç¨‹äºŒè¿›å…¥ï¼Œä¼šå› ç¼“å­˜è¢«åˆ è¿›å…¥æ•°æ®åº“æŸ¥è¯¢å‡ºæ—§æ•°æ®å¹¶å†™å›ç¼“å­˜ï¼Œäº§ç”Ÿè„æ•°æ®
		å…ˆæ›´æ–°å†åˆ ç¼“å­˜  çº¿ç¨‹ä¸€æ›´æ–°çš„æ•°æ®æ°å¥½åœ¨ç¼“å­˜ä¸­å·²ç»è¿‡æœŸï¼Œåœ¨çº¿ç¨‹ä¸€æ›´æ–°æ•°æ®å®Œæˆä¹‹å‰ï¼Œçº¿ç¨‹äºŒè¿›å…¥ï¼Œä¼šå› ç¼“å­˜è¿‡æœŸè¿›å…¥æ•°æ®åº“æŸ¥è¯¢å¾—åˆ°æ—§æ•°æ®ï¼Œåœ¨å°†æ•°æ®å†™å›ç¼“å­˜ä¹‹å‰ï¼Œçº¿ç¨‹ä¸€å®Œæˆæ›´æ–°å¹¶åˆ é™¤äº†ç¼“å­˜ï¼Œå­˜å…¥ç¼“å­˜çš„ä»ç„¶æ˜¯æ—§çš„ï¼Œäº§ç”Ÿè„æ•°æ®
	ï¼ˆ2ï¼‰æ·»åŠ è¯»å†™é”  é€šè¿‡redissonè·å¾—åŒä¸€ä¸ªè¯»å†™é”ï¼Œè¯»é”å¯ä»¥å…±äº«è¯»ï¼Œä½†æ˜¯ä¸èƒ½å†™ï¼Œå†™é”æ—¢ä¸èƒ½è¯»ä¹Ÿä¸èƒ½å†™ï¼Œä¿è¯å¼ºä¸€è‡´
	
å»¶è¿Ÿä¸€è‡´ï¼šï¼ˆ1ï¼‰æ·»åŠ æ¶ˆæ¯ä¸­é—´ä»¶  å½“æ•°æ®åœ¨ä¸šåŠ¡å±‚è¿›è¡Œä¿®æ”¹ï¼Œå‘é€æ¶ˆæ¯åˆ°MQï¼Œå¹¶ç”±ç›‘å¬ä¿®æ”¹æ¶ˆæ¯é˜Ÿåˆ—çš„ä¸šåŠ¡æ›´æ–°ç¼“å­˜
		ï¼ˆ2ï¼‰Canal  ä½¿ç”¨Canalç›‘å¬æ•°æ®åº“çš„binglogæ—¥å¿—ï¼Œå¹¶å°†æ›´æ–°æ•°æ®å‘é€ç»™ä¸šåŠ¡ï¼Œç”±ä¸šåŠ¡è¿›è¡Œæ›´æ–°ç¼“å­˜	

### 5.  æŒä¹…åŒ–
#### RDB
å®šæ—¶å¯¹å†…å­˜æ•°æ®è¿›è¡Œå¿«ç…§ä¿å­˜åˆ°ç£ç›˜ä¸­ï¼ˆåœ¨redis.confæ–‡ä»¶ä¸­é…ç½®ä¸ºå¤šå°‘æ—¶é—´æœ‰å¤šå°‘ä¸ªkeyè¢«ä¿®æ”¹å°±ä¿å­˜ä¸€æ¬¡ï¼‰ï¼Œæ•°æ®å­˜å‚¨åœ¨ç‰©ç†å†…å­˜ä¸­ï¼Œä¸»è¿›ç¨‹æ“ä½œçš„æ˜¯è™šæ‹Ÿå†…å­˜ï¼Œç”±é¡µè¡¨å°†è™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜è¿›è¡Œæ˜ å°„ï¼Œå½“è¿›è¡Œbgsaveæ—¶ï¼Œå­è¿›ç¨‹ä¼šæ‹·è´ä¸€ä»½ä¸»è¿›ç¨‹çš„é¡µè¡¨ï¼Œå¾—åˆ°æ˜ å°„å…³ç³»ï¼Œè¯»å–ç‰©ç†å†…å­˜çš„æ•°æ®å¹¶å†™è¿›ç£ç›˜ä¸­ï¼Œå½“ä¸»è¿›ç¨‹è¿›è¡Œå†™æ“ä½œæ—¶ï¼Œä¼šå°†ç‰©ç†å†…å­˜ çš„æ•°æ®çš„çŠ¶æ€æ”¹ä¸ºreadonlyï¼Œå¹¶å°†è¦ä¿®æ”¹çš„æ•°æ®æ‹·è´ä¸€ä»½ï¼Œä¸»è¿›ç¨‹å°†å¯¹æ‹·è´çš„æ•°æ®è¿›è¡Œè¯»å†™ï¼Œé¿å…è„æ•°æ®
ä½“ç§¯å°ï¼Œæ¢å¤é€Ÿåº¦å¿«
#### AOF
å°†å†™å‘½ä»¤ç›´æ¥ä¿å­˜åœ¨aofæ–‡ä»¶ä¸­ï¼ˆåœ¨redis.confä¸­è¿›è¡Œé…ç½®å¼€å¯ï¼Œé…ç½®ä¸ºç«‹å³è®°å½•å†™å‘½ä»¤/æ¯ç§’è®°å½•ä¸€æ¬¡/ç”±æ“ä½œç³»ç»Ÿå†³å®šè®°å½•æ—¶é—´ï¼‰ï¼Œç”±äºåªæœ‰æœ€åä¸€æ¬¡çš„å†™å‘½ä»¤æ‰æœ‰æ•ˆï¼Œæ‰€ä»¥æœ‰aofæ–‡ä»¶é‡å†™æœºåˆ¶ï¼Œä¿å­˜æœ€æœ‰æ•ˆçš„å†™å‘½ä»¤ï¼Œè§¦å‘æœºåˆ¶æœ‰å½“å‰aofæ–‡ä»¶ç›¸æ¯”ä¹‹å‰å¢é•¿äº†ç™¾åˆ†ä¹‹å¤šå°‘/ç›¸æ¯”äºä¹‹å‰å¢é•¿äº†å¤šå¤§ä½“ç§¯
ä½“ç§¯å¤§ï¼Œæ¢å¤é€Ÿåº¦æ…¢
### 6. æ•°æ®è¿‡æœŸç­–ç•¥
#### æƒ°æ€§åˆ é™¤
keyè¿‡æœŸåå…ˆä¸è¿›è¡Œåˆ é™¤ï¼Œåªæœ‰å½“æŸ¥è¯¢è¿™ä¸ªkeyæ—¶æ‰è¿›è¡Œè¿‡æœŸåˆ¤æ–­ï¼Œå¦‚æœè¿‡æœŸç›´æ¥åˆ é™¤ï¼Œæ²¡æœ‰è¿‡æœŸåˆ™è¿”å›å€¼
#### å®šæœŸåˆ é™¤
å®šæ—¶éå†ä¸€äº›keyè¿›è¡Œè¿‡æœŸæ£€æŸ¥ï¼Œåˆ é™¤å…¶ä¸­è¿‡æœŸçš„
slowæ¨¡å¼ï¼Œé»˜è®¤æ˜¯10HZï¼Œæ¯æ¬¡æ¸…ç†è€—æ—¶ä¸è¶…è¿‡25msï¼Œå°½é‡å°‘å»å½±å“ä¸»è¿›ç¨‹æ“ä½œï¼ˆåœ¨é…ç½®æ–‡ä»¶ä¸­è°ƒæ•´hzé€‰é¡¹è¿›è¡Œè°ƒæ•´ï¼‰
fastæ¨¡å¼ï¼Œä¸¤æ¬¡é—´éš”å¤§äº2msï¼Œæ¯æ¬¡ä¸è¶…è¿‡1ms
### 7. æ•°æ®æ·˜æ±°ç­–ç•¥

å½“Rediså†…å­˜å·²ç»è¾¾åˆ°ä¸Šé™ï¼Œè¿›è¡Œçš„æ•°æ®åˆ é™¤çš„ç­–ç•¥
LRUï¼šä¼˜å…ˆåˆ é™¤æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ•°æ®ã€‚ç”¨å½“å‰æ—¶é—´å‡å»æœ€è¿‘ä¸€æ¬¡ä½¿ç”¨çš„æ—¶é—´ï¼Œå€¼è¶Šå¤§è¶Šå®¹æ˜“è¢«æ·˜æ±°
LFUï¼šä¼˜å…ˆåˆ é™¤è®¿é—®é¢‘ç‡æœ€å°çš„æ•°æ®
é»˜è®¤ä½¿ç”¨çš„æ˜¯ä¸æ¥å—æ–°çš„keyï¼Œå½“å†…å­˜å·²ç»è¾¾åˆ°ä¸Šé™ï¼Œå­˜å…¥æ–°æ•°æ®ä¼šç›´æ¥æŠ¥é”™
ä¸€èˆ¬ä½¿ç”¨çš„æ˜¯allkeys-lruï¼Œåˆ é™¤æœ€è¿‘æœ€å°‘è®¿é—®çš„keyï¼Œä¿ç•™çƒ­ç‚¹æ•°æ®
## äºŒ. åˆ†å¸ƒå¼é”
### 1.  setnx
```java
set lock value NX EX 10;
```
é€šè¿‡rediså‘½ä»¤å­˜å€¼è®¾ç½®é”å¹¶è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œä¿è¯åŸå­æ€§å’Œé”ä¼šæœ€ç»ˆé‡Šæ”¾
ä¼šå› ä¸šåŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿å¯¼è‡´æå‰è§£é”ï¼Œé€šè¿‡æ ¹æ®ä¸šåŠ¡å’Œæ‰‹åŠ¨ç»­é”æ¥è§£å†³
### 2. redisson
#### è·å–é”
é€šè¿‡redissionæ·»åŠ åˆ†å¸ƒå¼é”ï¼Œåº•å±‚æ˜¯setnxå’Œluaè„šæœ¬æ‰§è¡Œrediså‘½ä»¤ä¿è¯åŸå­æ€§
```java
Rlock lock=redissonClient.getLock("lt");
boolen isLock=lock.tryLock(10,30,TimeUnit.SECOND);
boolen isLock=lock.tryLock(10,TimeUnit.SECOND);
boolen isLock=lock.tryLock();
```
æ²¡æœ‰æŠ¢å åˆ°é”çš„çº¿ç¨‹ä¼šå¾ªç¯ä¸æ–­å°è¯•è·å–é”
ä¼šæœ‰ä¸€ä¸ªwatch dogçº¿ç¨‹ç›‘å¬å½“å‰æŠ¢å åˆ°é”çš„çº¿ç¨‹ï¼Œå¹¶ä¸æ–­ç»™é”ç»­æœŸï¼ˆé»˜è®¤æ˜¯10ç§’ç»­æœŸä¸€æ¬¡ï¼‰ï¼Œç›´åˆ°æ‰‹åŠ¨é‡Šæ”¾é”

æ–¹æ³•ä¸€ï¼šå‚æ•°10æ˜¯å…¶ä»–çº¿ç¨‹å°è¯•è·å–é”çš„æœ€å¤§å¾ªç¯æ—¶é—´ï¼Œå‚æ•°30æ˜¯æœ€ç»ˆé”çš„è¿‡æœŸè‡ªåŠ¨é‡Šæ”¾æ—¶é—´ï¼Œä¸ä¼šè‡ªåŠ¨ç»­æœŸï¼Œåˆ°æœŸç›´æ¥é‡Šæ”¾
æ–¹æ³•äºŒï¼šåŒä¸Šï¼Œå› ä¸ºæ²¡æœ‰è‡ªåŠ¨é‡Šæ”¾æ—¶é—´ä¼šè‡ªåŠ¨ç»­æœŸ
æ–¹æ³•ä¸‰ï¼šé»˜è®¤æ˜¯æ¯éš”10ç§’ç»™é”é‡æ–°ç»­æœŸåˆ°30ç§’
#### é”çš„å¯é‡å…¥
```java
add1(){
	getLock("lt");
	add2();
	...
	unlock();
}
add2(){
	getLock("lt");
	...
	unlock();
}
```
redisé‡Œé€šè¿‡hashç»“æ„å­˜å‚¨å½“å‰çº¿ç¨‹å æœ‰é”çš„æƒ…å†µ
Lock | Tread | value
lt |    tr1    | 2
redisä¼šæ ¹æ®å½“å‰ç«™æœ‰é”çš„çº¿ç¨‹ï¼Œå¯¹é”çš„é‡å…¥ç´¯åŠ valueå€¼ï¼Œæ¯å½“æœ‰ä¸€ä¸ªé‡å…¥çš„é”è¿›è¡Œé‡Šæ”¾valueå€¼å‡ä¸€
#### ä¸»ä»ä¸€è‡´æ€§
å½“çº¿ç¨‹å æœ‰é”ä¹‹åï¼Œä¸»èŠ‚ç‚¹ä¼šå°†é”çš„ä¿¡æ¯åŒæ­¥ç»™ä»èŠ‚ç‚¹ï¼Œä½†æ˜¯å¦‚æœå®ŒæˆåŒæ­¥ä¹‹å‰ï¼Œä¸»èŠ‚ç‚¹å®•æœºï¼Œä»èŠ‚ç‚¹å½“é€‰ä¸»èŠ‚ç‚¹æ²¡æœ‰é”çš„ä¿¡æ¯ï¼Œå…¶ä»–çº¿ç¨‹ä¹Ÿä¼šæŠ¢å åˆ°é”ï¼Œå¯¼è‡´ä¸¤ä¸ªçº¿ç¨‹éƒ½æŒæœ‰é”
redissonæ— æ³•è§£å†³ä¸»ä»ä¸€è‡´æ€§
RedLockå¯ä»¥ã€‚é€šè¿‡å°†é”çš„ä¿¡æ¯åŒæ—¶å­˜åˆ°ä¸€åŠæ•°é‡ä»¥ä¸Šçš„èŠ‚ç‚¹ä¿è¯é”çš„ä¿¡æ¯ä¸ä¼šä¸¢å¤±ï¼Œæ€§èƒ½ä¼šå¾ˆå·®
zookeeperå¯ä»¥ä¿æŒå¼ºä¸€è‡´
## ä¸‰. å…¶ä»–

### 1. ä¸»ä»å¤åˆ¶
å•ç‚¹rediså¹¶å‘èƒ½åŠ›æœ‰é™ï¼Œé€šè¿‡æ­å»ºä¸»ä»é›†ç¾¤å®ç°è¯»å†™åˆ†ç¦»ï¼Œä¸»èŠ‚ç‚¹è´Ÿè´£å†™æ“ä½œï¼Œä»èŠ‚ç‚¹è´Ÿè´£è¯»ï¼Œä¸»èŠ‚ç‚¹å°†æ•°æ®ä¿®æ”¹åŒæ­¥ç»™ä»èŠ‚ç‚¹

Replication Idï¼šåˆ¤æ–­æ•°æ®é›†æ˜¯å¦ä¸€è‡´ï¼Œæ¯ä¸ªä¸»èŠ‚ç‚¹æœ‰è‡ªå·±å”¯ä¸€çš„idï¼Œä»èŠ‚ç‚¹ç»§æ‰¿ä¸»èŠ‚ç‚¹çš„id
offsetï¼šåç§»é‡ï¼Œè®°å½•å·²ç»æ‰§è¡Œåˆ°æˆ–æ›´æ–°åˆ°çš„repl baklog æ–‡ä»¶çš„ä½ç½®
#### å…¨é‡åŒæ­¥
ä»èŠ‚ç‚¹è¯·æ±‚è¿æ¥ä¸»èŠ‚ç‚¹å¹¶å‘é€rpidå’Œoffsetï¼Œä¸»èŠ‚ç‚¹æ ¹æ®rpidåˆ¤æ–­ä»èŠ‚ç‚¹æ˜¯ä¸æ˜¯ç¬¬ä¸€æ¬¡åŒæ­¥ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿›è¡Œbgsaveï¼Œç”ŸæˆRDBæ–‡ä»¶ï¼Œå¹¶åœ¨ç”Ÿæˆæ–‡ä»¶æœŸé—´å°†è¿›è¡Œæ“ä½œçš„å‘½ä»¤è®°å½•åœ¨repl baklogæ–‡ä»¶ä¸­ï¼Œä¹‹åä¸»èŠ‚ç‚¹å°†RDBæ–‡ä»¶å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œä»èŠ‚ç‚¹æ¸…é™¤æœ¬åœ°æ•°æ®ï¼ŒåŠ è½½RDBæ–‡ä»¶ï¼Œä¹‹åä¸»èŠ‚ç‚¹å‘é€repl baklogçš„å‘½ä»¤ï¼Œä»èŠ‚ç‚¹æ‰§è¡Œå‘½ä»¤
#### å¢é‡åŒæ­¥
å¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡åŒæ­¥ï¼Œåˆ™ä¸»èŠ‚ç‚¹ä¼šæ ¹æ®å‘é€offsetå’Œè‡ªå·±çš„offsetæ¯”è¾ƒï¼Œå‘é€ä¸¤è€…ç›¸å·®çš„å‘½ä»¤ç»™ä»èŠ‚ç‚¹ï¼Œè®©ä»èŠ‚ç‚¹è¿›è¡Œæ‰§è¡Œ
### 2. å“¨å…µæœºåˆ¶
åœ¨ä¸»ä»å¤åˆ¶çš„åŸºç¡€ä¸Šæ·»åŠ å“¨å…µé›†ç¾¤ç›‘æ§èŠ‚ç‚¹æƒ…å†µï¼Œæé«˜å¯ç”¨æ€§
#### é€‰ä¸»åŸç†
å“¨å…µä¼šå®šæ—¶å‘èŠ‚ç‚¹å‘é€pingå‘½ä»¤ï¼Œå¦‚æœèŠ‚ç‚¹è¿”å›pangè¯´æ˜èŠ‚ç‚¹å¥åº·
å¦‚æœæŸä¸ªå“¨å…µå‘ä¸»èŠ‚ç‚¹å‘é€å‘½ä»¤æ²¡æœ‰å“åº”ï¼Œå±äºä¸»è§‚ä¸»èŠ‚ç‚¹å®•æœºï¼Œå¦‚æœå³è¶…è¿‡ä¸€åŠæ•°é‡ä»¥ä¸Šçš„å“¨å…µè®¤ä¸ºä¸»èŠ‚ç‚¹ä¸»è§‚å®•æœºï¼Œåˆ™ä¸»èŠ‚ç‚¹å®¢è§‚å®•æœºï¼Œå“¨å…µä¼šé€šçŸ¥å®¢æˆ·ç«¯æ–°çš„ä¸»èŠ‚ç‚¹æ›´æ”¹çš„æ¶ˆæ¯
å’Œä¸»èŠ‚ç‚¹æ–­å¼€è¿æ¥æ—¶é—´è¶ŠçŸ­çš„ä»èŠ‚ç‚¹ï¼Œoffsetè¶Šå¤§çš„ä»èŠ‚ç‚¹è¶Šå®¹æ˜“å½“é€‰ä¸»èŠ‚ç‚¹ï¼Œå½“æ—§ ä¸»èŠ‚ç‚¹æ¢å¤ä¼šæˆä¸ºå½“å‰ä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹
#### è„‘è£‚
å½“ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹å’Œå“¨å…µå¤„äºä¸åŒç½‘ç»œä¸‹æ—¶ï¼Œå®¢æˆ·ç«¯ä»ç„¶èƒ½è¿æ¥åˆ°æ—§ä¸»èŠ‚ç‚¹ï¼Œå“¨å…µè®¤ä¸ºä¸»èŠ‚ç‚¹å®•æœºï¼Œä¼šä»ä»èŠ‚ç‚¹ä¸­é‡æ–°é€‰ä¸¾ä¸»èŠ‚ç‚¹ï¼Œæ—§ä¸»èŠ‚ç‚¹æ”¶åˆ°çš„æ•°æ®æ— æ³•åŒæ­¥åˆ°å…¶ä»–èŠ‚ç‚¹ï¼Œå½“ç½‘ç»œæ¢å¤ï¼Œæ—§ä¸»èŠ‚ç‚¹é™çº§ä¸ºæ–°ä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹ï¼Œå’Œæ–°ä¸»èŠ‚ç‚¹è¿›è¡Œæ•°æ®åŒæ­¥ï¼Œæ¸…ç©ºäº†æœ¬åœ°æ•°æ®ï¼Œä¸¢å¤±äº†ç½‘ç»œä¸­æ–­æ—¶å®¢æˆ·ç«¯çš„æ•°æ®
å¯ä»¥é€šè¿‡é…ç½®æœ€å°ä»èŠ‚ç‚¹æ•°é‡å’Œä¸»ä»åŒæ­¥æœ€å¤§å»¶è¿Ÿæ—¶é—´æ¥è®©ä¿®æ”¹æ•°æ®å‘½ä»¤ç›´æ¥æ‹’ç»è§£å†³
### 3. åˆ†ç‰‡é›†ç¾¤
#### åŸç†
é›†ç¾¤ä¸­æœ‰å¤šä¸ªä¸»èŠ‚ç‚¹ï¼Œæ¯ä¸ªä¸»èŠ‚ç‚¹æœ‰å¤šä¸ªä»èŠ‚ç‚¹ï¼Œä¸»èŠ‚ç‚¹ä¹‹é—´äº’ç›¸è¿›è¡Œå¿ƒè·³æ£€æµ‹å……å½“å“¨å…µä½œç”¨
æ¯ä¸ªä¸»èŠ‚ç‚¹å­˜å‚¨ä¸åŒçš„æ•°æ®ï¼Œé€šè¿‡å°†ä¸€ä¸‡å¤šä¸ªhashæ§½åˆ†é…ç»™é›†ç¾¤ä¸­çš„ä¸»èŠ‚ç‚¹ï¼Œå¹¶å¯¹è¯·æ±‚çš„keyè¿›è¡Œæœ‰æ•ˆå€¼çš„hashè¿ç®—ï¼Œå°†å®¢æˆ·ç«¯çš„è¯·æ±‚è·¯ç”±åˆ°ç›¸åº”çš„ä¸»èŠ‚ç‚¹
```java
set name value lt;
set {aaa}name value lt;
```
{ }å†…çš„å€¼å°±æ˜¯è®¡ç®—hashå€¼çš„æœ‰æ•ˆå€¼ï¼Œå¦‚æœæ²¡æœ‰ï¼Œkeyå°±æ˜¯æœ‰æ•ˆå€¼
### 4. æ‰§è¡Œé€Ÿåº¦
#### åŸå› 
redisæ˜¯åŸºäºå†…å­˜å­˜å‚¨çš„ï¼Œè¯»å†™é€Ÿåº¦å¾ˆå¿«
redisæ˜¯å•çº¿ç¨‹çš„ï¼Œé¿å…äº†ä¸å¿…è¦çš„ä¸Šä¸‹æ–‡åˆ‡æ¢
é‡‡ç”¨äº†I/Oå¤šè·¯å¤ç”¨çš„æ¨¡å‹
#### I/Oæ¨¡å‹
Liunxç³»ç»Ÿå°†ä¸€ä¸ªè¿›ç¨‹åˆ†ä¸ºäº†ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ï¼Œç”¨æˆ·ç©ºé—´åªèƒ½æ‰§è¡Œå—é™çš„å‘½ä»¤ï¼Œé€šè¿‡è°ƒç”¨å†…æ ¸ç©ºé—´çš„æ¥å£è°ƒç”¨ç³»ç»Ÿèµ„æºï¼Œå†…æ ¸ç©ºé—´å¯ä»¥ç›´æ¥è°ƒç”¨ç³»ç»Ÿèµ„æºï¼Œä¸ºäº†æé«˜æ€§èƒ½ä¼šåœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´å†…åŠ å…¥ç¼“å†²åŒº
ç”¨æˆ·è¿›ç¨‹åœ¨å†™æ•°æ®æ—¶ä¼šå°†è‡ªèº«æ•°æ®æ‹·è´ä¸€ä»½åˆ°å†…æ ¸è¿›ç¨‹çš„ç¼“å†²åŒºï¼Œç„¶åå†™å…¥ç¡¬ä»¶
åœ¨è¿›è¡Œè¯»æ•°æ®æ—¶ä¼šå°†ç¡¬ä»¶æ•°æ®åŠ è½½åˆ°å†…æ ¸è¿›ç¨‹çš„ç¼“å†²åŒºï¼Œç„¶åå°†æ•°æ®æ‹·è´åˆ°ç”¨æˆ·è¿›ç¨‹ç¼“å†²åŒº
æ‰€ä»¥å½±å“redisé€Ÿåº¦çš„æ˜¯ç½‘ç»œä¼ è¾“ï¼Œè€Œä¸æ˜¯æ‰§è¡Œæ•ˆç‡
##### é˜»å¡å¼I/O
```txt
ç”¨æˆ·è¿›ç¨‹-----------è°ƒç”¨recvfromå‡½æ•°------------>å†…æ ¸è¿›ç¨‹
												|
												|
											  ç­‰å¾…æ•°æ®
											    |
											    |
   <-------------å†™å…¥ç”¨æˆ·è¿›ç¨‹ç¼“å†²----------------æ•°æ®å°±ç»ª
```
é˜¶æ®µä¸€ï¼šç”¨æˆ·è¿›ç¨‹è°ƒç”¨recvfromå‡½æ•°ï¼Œè¯·æ±‚å†…æ ¸è¿›ç¨‹è¯»å–æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰åˆ™å†…æ ¸è¿›ç¨‹ç­‰å¾…æ•°æ®ï¼Œæ­¤æ—¶ç”¨æˆ·è¿›ç¨‹å¤„äºé˜»å¡çŠ¶æ€
é˜¶æ®µäºŒï¼šå½“æ•°æ®å‡†å¤‡å°±ç»ªåï¼Œç”¨æˆ·è¿›ç¨‹ä¼šç­‰å¾…å†…æ ¸è¿›ç¨‹å°†æ•°æ®æ‹·è´åˆ°è‡ªå·±çš„ç¼“å†²åŒºï¼Œæ­¤æ—¶ç”¨æˆ·è¿›ç¨‹ä¾ç„¶æ˜¯é˜»å¡çŠ¶æ€
##### éé˜»å¡å¼I/O
```txt
ç”¨æˆ·è¿›ç¨‹-----------è°ƒç”¨recvfromå‡½æ•°------------>å†…æ ¸è¿›ç¨‹
												|     å¾ªç¯æ­¤è¿‡ç¨‹
												|
	  <-------------è¿”å›error-----------------ç­‰å¾…æ•°æ®
											    |
											    |
   <-------------å†™å…¥ç”¨æˆ·è¿›ç¨‹ç¼“å†²----------------æ•°æ®å°±ç»ª
```
é˜¶æ®µä¸€ï¼šç”¨æˆ·è¿›ç¨‹è°ƒç”¨recvfromå‡½æ•°ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®ï¼Œå†…æ ¸ä¼šç›´æ¥è¿”å›errorï¼Œç”¨æˆ·è¿›ç¨‹ä¼šä¸€ç›´å¾ªç¯å°è¯•è¯·æ±‚æ•°æ®ï¼Œç›´åˆ°æ•°æ®å‡†å¤‡å°±ç»ªï¼Œæ­¤æ—¶ç”¨æˆ·è¿›ç¨‹å¤„äºéé˜»å¡çŠ¶æ€
é˜¶æ®µäºŒï¼šå½“æ•°æ®å‡†å¤‡å°±ç»ªåï¼Œç”¨æˆ·è¿›ç¨‹ç­‰å¾…æ•°æ®æ‹·è´ï¼Œæ­¤æ—¶ç”¨æˆ·è¿›ç¨‹å¤„äºé˜»å¡çŠ¶æ€
##### I/Oå¤šè·¯å¤ç”¨
```txt
ç”¨æˆ·è¿›ç¨‹-----------è°ƒç”¨selectå‡½æ•°-------------->å†…æ ¸è¿›ç¨‹
												|      
												|
											  ç­‰å¾…æ•°æ®   ä¸€æ—¦æŸä¸ªsocketæ•°æ®å°±ç»ª
											    |
											    |
   <-----------------readable----------------æ•°æ®å°±ç»ª
												|
												|
   <-------------å†™å…¥ç”¨æˆ·è¿›ç¨‹ç¼“å†²--------------æ•°æ®å°±ç»ª
```
é˜¶æ®µä¸€ï¼šç”¨æˆ·è¿›ç¨‹è°ƒç”¨selectå‡½æ•°ï¼Œå‘é€è¦ç›‘å¬çš„socketé›†åˆï¼Œå†…æ ¸ç›‘å¬æŒ‡å®šçš„socketé›†åˆï¼Œä¸€ä¸ªæˆ–è€…å¤šä¸ªsocketå¯è¯»å¯å†™æ—¶ï¼Œå†…æ ¸ä¼šè¿”å›readableï¼Œæ­¤é˜¶æ®µç”¨æˆ·è¿›ç¨‹æ˜¯é˜»å¡çŠ¶æ€
é˜¶æ®µäºŒï¼šç”¨æˆ·è¿›ç¨‹å¾ªç¯éå†socketé›†åˆæ‰¾åˆ°å·²ç»å°±ç»ªçš„ï¼Œå¹¶ä¾æ¬¡è°ƒç”¨recvfromå‡½æ•°è¯»å–æ•°æ®ï¼Œå†…æ ¸å°†æ•°æ®æ‹·è´åˆ°ç”¨æˆ·è¿›ç¨‹ç¼“å†²åŒº
###### å®ç°æ–¹å¼
selectï¼Œpollï¼Œepoll
å‰ä¸¤è€…ç”¨æˆ·è¿›ç¨‹æ˜¯ä¸çŸ¥é“å“ªä¸ªsocketå°±ç»ªçš„ï¼Œéœ€è¦éå†å¯»æ‰¾ï¼Œåè€…åœ¨è¿”å›readableæ—¶ä¼šå°†socketä¿¡æ¯å†™å…¥ç”¨æˆ·è¿›ç¨‹ç¼“å†²åŒº
#### redisçš„I/Oæ¨¡å‹
é€šè¿‡I/Oå¤šè·¯å¤ç”¨å’Œäº‹ä»¶æ´¾å‘æœºåˆ¶ï¼Œè¿˜æœ‰è¿æ¥åº”ç­”å¤„ç†å™¨ï¼Œå‘½ä»¤å›å¤å¤„ç†å™¨ï¼Œå‘½ä»¤è¯·æ±‚å¤„ç†å™¨å®Œæˆ
6.0ç‰ˆæœ¬ä¹‹åredisåŠ å…¥äº†å¤šçº¿ç¨‹åœ¨å‘½ä»¤å›å¤å¤„ç†å™¨å’Œå‘½ä»¤è¯·æ±‚å¤„ç†å™¨çš„æ¥æ”¶å‚æ•°å’Œå‘½ä»¤è½¬åŒ–éƒ¨åˆ†ï¼Œæ‰§è¡Œéƒ¨åˆ†ä¾ç„¶æ˜¯å•çº¿ç¨‹çš„
# MySQL
## ä¸€. ä¼˜åŒ–
### 1. å®šä½æ…¢æŸ¥è¯¢
#### å¸¸è§æ…¢æŸ¥è¯¢
èšåˆæŸ¥è¯¢ï¼šèšåˆå‡½æ•°æ— æ³•ä½¿ç”¨ç´¢å¼•
å¤šè¡¨è”æŸ¥ï¼šjoinå­—æ®µå¦‚æœæ²¡æœ‰ç´¢å¼•æˆ–è€…ç´¢å¼•è¦†ç›–ä¸å®Œå…¨ä¼šè§¦å‘å›è¡¨æŸ¥è¯¢
æ•°æ®é‡è¿‡å¤§
åˆ†é¡µè¿‡æ·±ï¼šä¾‹å¦‚
```sql
SELECT * FROM table 
ORDER BY xxx
LIMIT 1000000, 10;

```
å®é™…ä¸Šæ˜¯å¯¹å‰1000010æ¡æ•°æ®è¿›è¡Œé¡ºåºæ‰«æåŠ æ’åºï¼Œç„¶åä¸¢æ‰å‰1000000æ¡æ•°æ®åªä¿ç•™10æ¡ï¼Œåˆ†é¡µè¶Šæ·±æ’åºçš„æ•°æ®å°±è¶Šå¤šï¼Œorder byå­—æ®µå¦‚æœæœ‰ç´¢å¼•å¯ä»¥ä¼˜åŒ–æ’åº
#### è§£å†³
##### ä½¿ç”¨è¿ç»´å·¥å…·
å¦‚æ™®ç½—ç±³ä¿®æ–¯ï¼Œskywalkingï¼Œç›‘æ§æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´å’Œå„é˜¶æ®µè€—æ—¶
##### å¼€å¯æ…¢æŸ¥è¯¢
åœ¨/etc/my.cnfä¸­è¿›è¡Œé…ç½®
```config
slow_query_log=1 # å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—
slow_query_time=2 # æŒ‡å®šè¶…æ—¶æ—¶é—´ï¼Œè¶…è¿‡æŒ‡å®šæ—¶é—´è®°å½•ä¸ºæ…¢æŸ¥è¯¢
```
### 2. åˆ†ææ…¢æŸ¥è¯¢
é€šè¿‡explainå…³é”®å­—æŸ¥çœ‹è¯­å¥çš„æ‰§è¡Œæƒ…å†µ
possible_keyï¼šå¯èƒ½ç”¨åˆ°çš„ç´¢å¼•
keyå’Œkey_lenï¼šå®é™…ç”¨åˆ°çš„ç´¢å¼•å’Œç´¢å¼•çš„é•¿åº¦
typeï¼šè¯­å¥çš„ç±»å‹ï¼Œå¯ä»¥é€šè¿‡å®ƒåˆ¤æ–­è¯­å¥æ˜¯å¦æœ‰ä¼˜åŒ–ç©ºé—´ï¼Œconsté€šè¿‡ä¸»é”®æŸ¥è¯¢ï¼Œrefå…¨ç´¢å¼•æ‰«æï¼Œallå…¨ç›˜æ‰«æ
extraï¼šä¼˜åŒ–å»ºè®®ï¼Œå¦‚æœæ˜¯å›è¡¨æŸ¥è¯¢ï¼Œå¯ä»¥æ·»åŠ ç´¢å¼•æˆ–è€…ä¿®æ”¹è¿”å›å­—æ®µ
### 3. ç´¢å¼•
#### ä»€ä¹ˆæ˜¯ç´¢å¼•
å¸®åŠ©MySQLè·å–æ•°æ®çš„æ•°æ®ç»“æ„ï¼Œåœ¨innodbå­˜å‚¨å¼•æ“ä¸­ç”¨B+æ ‘å­˜å‚¨ç´¢å¼•
æé«˜æŸ¥è¯¢æ•ˆç‡ï¼Œå‡å°‘IOæ¶ˆè€—
é€šè¿‡ç´¢å¼•å¯¹æ•°æ®è¿›è¡Œæ’åºï¼Œé™ä½æ’åºæˆæœ¬
#### B+æ ‘ä¼˜åŠ¿
æ¯ä¸ªçˆ¶èŠ‚ç‚¹å¯ä»¥æ‹¥æœ‰å¤šä¸ªå­èŠ‚ç‚¹ï¼Œåˆ†æ”¯æ›´å¤šåˆ™å±‚çº§æ›´å°‘ï¼ŒæŸ¥è¯¢è·¯å¾„æ›´çŸ­
ç£ç›˜è¯»å†™ä»£ä»·æ›´å°‘ï¼ŒB+æ ‘çš„éå¶å­èŠ‚ç‚¹åªå­˜å‚¨ç´¢å¼•ï¼Œå¶å­èŠ‚ç‚¹å­˜å‚¨æ•°æ®ï¼Œä¸”å¶å­èŠ‚ç‚¹æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œé€‚åˆè¿›è¡ŒèŒƒå›´æŸ¥è¯¢å’Œå…¨åº“æ‰«æ
B+æ ‘çš„èŠ‚ç‚¹å¤§å°é€šå¸¸ä¸ä¸€ä¸ªç£ç›˜é¡µå¯¹å…¶ï¼ˆ4kbï¼‰ï¼Œä¸€ä¸ªç£ç›˜é¡µå¯ä»¥ä¸€æ¬¡æ€§è¯»å…¥å¤šä¸ª key å’ŒæŒ‡é’ˆï¼Œå¿«é€Ÿå®šä½keyçš„ä½ç½®ï¼Œæœ€å¤§åŒ–åˆ©ç”¨ç£ç›˜å¸¦å®½ï¼Œè¿™ä½¿å¾—æ¯æ¬¡ç£ç›˜ I/O èƒ½è¯»å–æ›´å¤šå†…å®¹ï¼Œä»è€Œ**æ˜¾è‘—å‡å°‘è®¿é—®æ¬¡æ•°å’Œç­‰å¾…æ—¶é—´**
#### èšé›†ç´¢å¼•
åˆç§°èšç°‡ç´¢å¼•ï¼Œæ¯å¼ è¡¨åªèƒ½æœ‰ä¸€ä¸ªï¼Œç‰¹ç‚¹æ˜¯å¶å­èŠ‚ç‚¹æŒ‚ç€çš„æ˜¯è¿™ä¸€è¡Œçš„æ•´è¡Œæ•°æ®ï¼Œå¦‚æœè¡¨æœ‰ä¸»é”®ï¼Œä¸»é”®ç´¢å¼•å°±æ˜¯èšé›†ç´¢å¼•ï¼Œå¦‚æœæ²¡æœ‰ä¸»é”®ï¼Œç¬¬ä¸€ä¸ªå”¯ä¸€ç´¢å¼•å°±æ˜¯èšé›†ç´¢å¼•ï¼Œå¦‚æœæ²¡æœ‰åˆé€‚çš„å”¯ä¸€ç´¢å¼•ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªéšè—çš„rowidå­—æ®µä½œä¸ºèšé›†ç´¢å¼•
#### äºŒçº§ç´¢å¼•
åˆç§°éèšé›†ç´¢å¼•ï¼Œæ¯å¼ è¡¨æœ‰å¤šä¸ªï¼Œå¶å­èŠ‚ç‚¹æŒ‚ç€çš„æ˜¯å¯¹åº”çš„ä¸»é”®
#### å›è¡¨æŸ¥è¯¢
å¦‚æœäºŒçº§ç´¢å¼•æ²¡æœ‰éœ€è¦æŸ¥è¯¢çš„æ‰€æœ‰æ•°æ®ï¼Œéœ€è¦é€šè¿‡å¶å­ç»“ç‚¹çš„idåˆ°èšç°‡ç´¢å¼•æŸ¥è¯¢éœ€è¦çš„æ•°æ®ï¼Œé€šè¿‡åˆ›å»ºè¦†ç›–ç´¢å¼•æ¥è§£å†³
#### è¦†ç›–ç´¢å¼•
åœ¨æŸ¥è¯¢ä½¿ç”¨çš„ç´¢å¼•ä¸­å¯ä»¥è·å¾—æ‰€æœ‰éœ€è¦çš„å­—æ®µ
#### è¶…å¤§åˆ†é¡µæŸ¥è¯¢
```sql
select * from sku a,(select id from sku order by id limit 9000000 10) b
where a.id=b.id;
```
é€šè¿‡è¦†ç›–ç´¢å¼•åŠ å­æŸ¥è¯¢è¿›è¡Œä¼˜åŒ–
#### åˆ›å»ºç´¢å¼•åŸåˆ™
1.å¯¹äºæ•°æ®é‡å¤§çš„è¡¨åˆ›å»ºç´¢å¼•
2.æœ‰ä¸€äº›å­—æ®µé¢‘ç¹ç”¨äºæŸ¥è¯¢æ¡ä»¶ï¼Œå¦‚whereï¼Œorder by
3.å°½é‡ä½¿ç”¨åŒºåˆ†åº¦é«˜ï¼Œå”¯ä¸€çš„å­—æ®µåˆ›å»ºç´¢å¼•ï¼Œå¦‚æ€§åˆ«å°±ä¸é€‚åˆåˆ›å»ºç´¢å¼•
4.å¯¹äºè¾ƒé•¿çš„stringå­—æ®µåˆ›å»ºå‰ç¼€ç´¢å¼•
5.å°½é‡åˆ›å»ºè”åˆç´¢å¼•ï¼Œå‡å°‘å•åˆ—ç´¢å¼•ï¼Œé¿å…å›è¡¨æŸ¥è¯¢
6.æ§åˆ¶æ•°é‡
#### ç´¢å¼•å¤±æ•ˆ
1.è¿æ³•æœ€å·¦å‰ç¼€æ³•åˆ™ï¼ŒæŸ¥è¯¢æ¡ä»¶å­—æ®µè·³è¿‡äº†è”åˆç´¢å¼•ä»å·¦å¾€å³çš„æŸä¸ªå­—æ®µ
2.èŒƒå›´æŸ¥è¯¢æ¡ä»¶å­—æ®µå³è¾¹çš„æŸ¥è¯¢æ¡ä»¶å­—æ®µæ— æ³•ä½¿ç”¨ç´¢å¼•
3.æŸ¥è¯¢æ¡ä»¶å­—æ®µä¸Šè¿›è¡Œäº†è¿ç®—ï¼Œå­—æ®µçš„å€¼æ”¹å˜æ— æ³•ä½¿ç”¨ç´¢å¼•
4.æŸ¥è¯¢çš„å­—ç¬¦ä¸²æ²¡åŠ å•å¼•å·ï¼Œå‘ç”Ÿç±»å‹è½¬æ¢ï¼ŒåŸç´¢å¼•æ— æ³•æ¯”è¾ƒ
5.ä»¥%å¼€å¤´çš„æ¨¡ç³ŠæŸ¥è¯¢ä¼šä½¿ç´¢å¼•å¤±æ•ˆ
### 4.sqlä¼˜åŒ–
#### è¡¨çš„è®¾è®¡ä¼˜åŒ–
é€‰æ‹©åˆé€‚çš„å­—æ®µæ•°æ®ç±»å‹
#### sqlè¯­å¥ä¼˜åŒ–
æŒ‡å®šselectçš„å­—æ®µåç§°ï¼Œé¿å…ä½¿ç”¨ * å¯¼è‡´å›è¡¨æŸ¥è¯¢
é¿å…ç´¢å¼•å¤±æ•ˆçš„å†™æ³•
ç”¨union allæ›¿æ¢unionï¼Œunionä¼šå¤šä¸€æ¬¡è¿‡æ»¤æ“ä½œ
å°½é‡ä½¿ç”¨inner joinä¸ç”¨left/right joinï¼Œå¦‚æœå¿…é¡»ä½¿ç”¨ï¼Œè¦ä½¿ç”¨å°è¡¨ä½œä¸ºé©±åŠ¨ï¼ˆå¤–è¡¨ï¼‰ï¼Œå‡å°‘å†…å¤–è¡¨çš„è¿æ¥æ¬¡æ•°
ä¸è¦åœ¨whereå­å¥ä½¿ç”¨è¡¨è¾¾å¼
#### ä¸»ä»å¤åˆ¶ï¼Œè¯»å†™åˆ†ç¦»
#### åˆ†åº“åˆ†è¡¨
## äºŒ. å…¶ä»–
### 1. äº‹åŠ¡
åŸå­æ€§ï¼šä¸å¯åˆ†å‰²ï¼Œæœ€å°å•ä½ï¼Œå…¨éƒ¨æˆåŠŸæˆ–å…¨éƒ¨å¤±è´¥
ä¸€è‡´æ€§ï¼šäº‹åŠ¡å®Œæˆåï¼Œæ‰€æœ‰æ•°æ®å¿…é¡»ä¿æŒä¸€è‡´
éš”ç¦»æ€§ï¼šäº‹åŠ¡åœ¨ä¸å—å¤–ç•Œç¯å¢ƒå½±å“ä¸‹å¹¶å‘æ‰§è¡Œ
æŒç»­æ€§ï¼šå¯¹æ•°æ®åº“çš„ä¿®æ”¹æ˜¯æ°¸ä¹…çš„
#### å¹¶å‘é—®é¢˜
è„è¯»ï¼šä¸€ä¸ªäº‹åŠ¡è¯»åˆ°äº†å¦ä¸€ä¸ªäº‹åŠ¡çš„æœªæäº¤çš„æ•°æ®
ä¸å¯é‡å¤è¯»ï¼šä¸€ä¸ªäº‹åŠ¡ä¸¤æ¬¡è¯»å–åŒä¸€æ¡è®°å½•ï¼Œä½†ä¸¤æ¬¡æ•°æ®ä¸ä¸€è‡´
å¹»è¯»ï¼šäº‹åŠ¡åœ¨æŸ¥è¯¢ä¸€æ¡è®°å½•æ—¶ï¼Œæ²¡æœ‰å¯¹åº”çš„æ•°æ®ï¼Œä½†æ˜¯æ’å…¥çš„æ—¶å€™å´å‘ç°è¯¥æ¡è®°å½•å·²ç»å­˜åœ¨
#### éš”ç¦»çº§åˆ«
è¯»æœªæäº¤
è¯»å·²æäº¤ï¼šè§£å†³è„è¯»
å¯é‡å¤è¯»ï¼ˆé»˜è®¤ï¼‰ï¼šè§£å†³è„è¯»å’Œä¸å¯é‡å¤è¯»
ä¸²è¡ŒåŒ–ï¼šå¯è§£å†³æ‰€æœ‰é—®é¢˜ï¼Œä¸€ä¸ªäº‹åŠ¡å®Œæˆä¹‹åå†æ‰§è¡Œå…¶ä»–äº‹åŠ¡
#### undo logå’Œredo log
ç¼“å†²æ± ï¼šä¸»å†…å­˜ä¸­çš„ä¸€ä¸ªåŒºåŸŸï¼Œé‡Œé¢å¯ä»¥å­˜å‚¨ç£ç›˜ä¸Šç»å¸¸å¢åˆ æ”¹æŸ¥çš„æ•°æ®ï¼Œåœ¨è¿›è¡Œæ“ä½œæ—¶ï¼Œå…ˆæ“ä½œç¼“å†²æ± é‡Œé¢çš„æ•°æ®ï¼Œç„¶åä»¥ä¸€å®šé¢‘ç‡åˆ·æ–°åˆ°ç£ç›˜å‡å°‘IOæ¶ˆè€—ï¼ŒåŠ å¿«å¤„ç†é€Ÿåº¦
æ•°æ®é¡µï¼šinnodbå¼•æ“ä¸­æœ€å°çš„ç®¡ç†å•å…ƒï¼Œæ¯ä¸ªé¡µ16kbï¼Œé‡Œé¢å­˜å‚¨çš„æ˜¯è¡Œæ•°æ®
##### redo log
ç”±é‡åšæ—¥å¿—ç¼“å†²å’Œé‡åšæ—¥å¿—æ–‡ä»¶ç»„æˆï¼Œå‰è€…åœ¨ä¸»å†…å­˜ä¸­åè€…åœ¨ç£ç›˜ä¸­ï¼Œè®°å½•çš„æ˜¯äº‹åŠ¡æäº¤äº§ç”Ÿçš„æ•°æ®é¡µçš„ç‰©ç†ä¿®æ”¹ï¼Œå½“é‡å†™æ—¥å¿—ç¼“å†²åŒºå†…å®¹å‘ç”Ÿå˜åŒ–ä¼šå°†å†…å®¹åŒæ­¥åˆ°æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œå½“è„é¡µåˆ·æ–°åˆ°ç£ç›˜å‘ç”Ÿé”™è¯¯æ—¶ï¼Œå¯ä»¥ç”¨æ¥æ•°æ®æ¢å¤
##### undo log
è®°å½•é€»è¾‘æ—¥å¿—ï¼Œæä¾›å›æ»šå’ŒMVCCï¼Œå½“äº‹åŠ¡å›æ»šæ—¶ï¼Œå¯ä»¥é€šè¿‡é€†æ“ä½œæ¢å¤åˆ°åŸæ¥çš„æ•°æ®
#### MVCC
MySQLçš„å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ã€‚æŒ‡çš„æ˜¯ç»´æŠ¤æ•°æ®çš„å¤šä¸ªç‰ˆæœ¬ï¼Œä½¿è¯»å†™æ“ä½œæ²¡æœ‰å†²çª
##### éšè—å­—æ®µ
æ¯å¼ è¡¨æœ‰ä¸¤ä¸ªéšè—å­—æ®µ
äº‹åŠ¡idï¼šè®°å½•æ¯ä¸€æ¬¡æ“ä½œçš„äº‹åŠ¡idï¼Œæ˜¯è‡ªå¢çš„
å›æ»šæŒ‡é’ˆï¼šæŒ‡å‘ä¸Šä¸€ä¸ªæ•°æ®ç‰ˆæœ¬çš„äº‹åŠ¡ç‰ˆæœ¬è®°å½•åœ°å€
##### undo log
å½“æ•°æ®è¢«ä¿®æ”¹æ—¶ï¼Œä¼šå°†å½“å‰æ•°æ®è®°å½•åœ¨undo logæ—¥å¿—æ–‡ä»¶ä¸­ï¼Œä¿®æ”¹åçš„æ•°æ®çš„å›æ»šæŒ‡é’ˆå°±ä¼šæŒ‡å‘æ–‡ä»¶ä¸­ä¸Šä¸€ç‰ˆæœ¬çš„æ•°æ®åœ°å€ï¼Œå½¢æˆç‰ˆæœ¬æ§åˆ¶é“¾è¡¨ï¼ŒåŒæ—¶ä¿®æ”¹åæ•°æ®çš„äº‹åŠ¡idä¼šåŠ 1
##### readView
è§£å†³äº‹åŠ¡æŸ¥è¯¢çš„æ•°æ®ç‰ˆæœ¬é—®é¢˜
åŒ…å«å››ä¸ªå­—æ®µï¼šåˆ›å»ºreadviewçš„äº‹åŠ¡idï¼Œå½“å‰æ´»è·ƒçš„äº‹åŠ¡ï¼ˆæœªæäº¤çš„äº‹åŠ¡ï¼‰çš„idé›†åˆï¼Œæœ€å°æ´»è·ƒäº‹åŠ¡idï¼Œé¢„åˆ¶äº‹åŠ¡idï¼ˆæœ€å¤§æ´»è·ƒäº‹åŠ¡idåŠ 1ï¼‰
ä¼šæ ¹æ®å››æ¡è§„åˆ™å’Œreadviewå»ç‰ˆæœ¬æ§åˆ¶é“¾ä¸­æŸ¥æ‰¾å¯¹åº”ç‰ˆæœ¬çš„æ•°æ®
åœ¨è¯»å·²æäº¤äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸‹ï¼Œäº‹åŠ¡çš„æ¯æ¬¡æŸ¥è¯¢éƒ½ä¼šæ ¹æ®å½“å‰äº‹åŠ¡æƒ…å†µé‡æ–°ç”Ÿæˆreadview
åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œå„ä¸ªäº‹åŠ¡å†…éƒ¨çš„readviewéƒ½æ˜¯é‡ç”¨ç¬¬ä¸€æ¬¡ç”Ÿæˆçš„ï¼Œä½†æ˜¯ä½¿ç”¨æ—¶è¿˜æ˜¯è¦æ ¹æ®è§„åˆ™æ¯”è¾ƒæ¥è·å–ç‰ˆæœ¬æ•°æ®
### 2. ä¸»ä»å¤åˆ¶åŸç†
ä¸»ä»å¤åˆ¶çš„æ ¸å¿ƒæ˜¯binlogäºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶
å½“ä¸»åº“çš„æ•°æ®å‘ç”Ÿäº†ä¿®æ”¹ï¼Œä¼šä¸“é—¨æœ‰ä¸€ä¸ªçº¿ç¨‹å°†ä¿®æ”¹çš„sqlè¯­å¥æˆ–è€…ä¿®æ”¹çš„æ•°æ®è®°å½•åœ¨binlogæ—¥å¿—æ–‡ä»¶ä¸­ï¼Œä»åº“æœ‰ä¸€ä¸ªIOçº¿ç¨‹è¿æ¥ä¸»åº“ï¼Œå¹¶å‘èµ·è¯·æ±‚æ¥æ”¶binlogæ–‡ä»¶å†…å®¹ï¼Œå¹¶å°†æ¥æ”¶çš„å†…å®¹å†™å…¥è‡ªå·±çš„ä¸­ç»§æ–‡ä»¶relay logä¸­ï¼Œç„¶åæœ‰ä¸€ä¸ªsqlçº¿ç¨‹æ¥é‡åšä¸­ç»§æ–‡ä»¶çš„å†…å®¹ï¼Œå®ç°æ•°æ®åŒæ­¥ï¼Œå¦‚æœä¸»ä»å¤åˆ¶æ˜¯è¡Œæ¨¡å¼ï¼Œé‚£ä¹ˆäºŒè¿›åˆ¶æ–‡ä»¶å­˜å‚¨å¾—å°±æ˜¯å¯¹åº”è¡Œå‘ç”Ÿçš„æ•°æ®å˜æ›´ï¼Œå¦‚æœæ˜¯sqlæ¨¡å¼è®°å½•çš„æ˜¯ä½¿æ•°æ®å‘ç”Ÿå˜åŒ–çš„sqlè¯­å¥
åŒæ—¶ä»åº“ä¼šè®°å½•ä¸»åº“çš„binlogæ–‡ä»¶åç§°å’Œæ–‡ä»¶å†…åç§»é‡ï¼Œä»¥ä¾¿å‘ç”Ÿç½‘ç»œæ³¢åŠ¨åèƒ½å¤Ÿå®šä½binlogæ–‡ä»¶è¯»å–åˆ°çš„ä½ç½®
### 3. åˆ†åº“åˆ†è¡¨
#### å‚ç›´åˆ†åº“
æ ¹æ®ä¸åŒçš„ä¸šåŠ¡å°†ä¸åŒçš„è¡¨å­˜å‚¨åˆ°ä¸åŒçš„åº“
#### å‚ç›´åˆ†è¡¨
ä»¥å­—æ®µä¸ºä¾æ®ï¼Œæ ¹æ®å­—æ®µå±æ€§å°†ä¸åŒå­—æ®µæ‹†åˆ†åˆ°ä¸åŒçš„è¡¨ä¸­ï¼ŒæŠŠä¸å¸¸ç”¨çš„æˆ–å¤§å­—æ®µæ‹†åˆ†åˆ°å•ç‹¬çš„ä¸€å¼ è¡¨
#### æ°´å¹³åˆ†åº“
å°†ä¸€ä¸ªåº“çš„æ•°æ®æ‹†åˆ†åˆ°å¤šä¸ªåº“ä¸­ï¼Œæ¯ä¸ªåº“éƒ½æœ‰ç›¸åŒçš„è¡¨ä½†æ˜¯å­˜å‚¨çš„æ•°æ®ä¸ä¸€æ ·ï¼Œåˆèµ·æ¥æ‰æ˜¯å®Œæ•´çš„æ•°æ®
æ ¹æ®idå–æ¨¡æ‰¾åˆ°å¯¹åº”æ•°æ®å­˜å‚¨çš„æ•°æ®åº“ï¼Œhashè¿ç®—å–æ¨¡åˆ†åº“ï¼ŒèŒƒå›´åˆ†åº“ï¼ˆä¸€ä¸ªåº“å­˜åˆ°äº†ä¸Šé™å†å­˜åˆ°ä¸‹ä¸€ä¸ªåº“ï¼‰ï¼Œæ—¶é—´åˆ†åº“ï¼ˆæ¯ä¸ªæœˆçš„æ•°æ®å­˜åˆ°å¯¹åº”çš„ä¸€ä¸ªæ•°æ®åº“é‡Œï¼‰
```xml
<?xml version="1.0" encoding="UTF-8"?>
<mycat:schema xmlns:mycat="http://io.mycat/">

    <!-- å®šä¹‰é€»è¾‘åº“ -->
    <schema name="order_db" checkSQLschema="false" sqlMaxLimit="1000">
        <!-- é€»è¾‘è¡¨ -->
        <table name="order" dataNode="dn0,dn1,dn2,dn3"
               rule="sharding_rule" />
    </schema>

    <!-- å®šä¹‰ç‰©ç†åº“å’Œæ•°æ®èŠ‚ç‚¹ -->
    <dataNode name="dn0" dataHost="ds0" database="order_db_0" />
    <dataNode name="dn1" dataHost="ds0" database="order_db_0" />
    <dataNode name="dn2" dataHost="ds1" database="order_db_1" />
    <dataNode name="dn3" dataHost="ds1" database="order_db_1" />

    <!-- æ•°æ®æºé…ç½® -->
    <dataHost name="ds0" maxCon="1000" minCon="10" balance="0"
              writeType="0" dbType="mysql" dbDriver="native">
        <heartbeat>select 1</heartbeat>
        <writeHost host="hostM1" url="127.0.0.1:3306" user="root" password="123456" />
    </dataHost>

    <dataHost name="ds1" maxCon="1000" minCon="10" balance="0"
              writeType="0" dbType="mysql" dbDriver="native">
        <heartbeat>select 1</heartbeat>
        <writeHost host="hostM2" url="127.0.0.2:3306" user="root" password="123456" />
    </dataHost>

</mycat:schema>
```
åœ¨ä»£ç å±‚é¢é€šè¿‡ä½¿ç”¨mycatä¸­é—´ä»¶ï¼Œåœ¨mycatä¸­é…ç½®ç‰©ç†åº“çš„é€»è¾‘åº“å’Œåº“ä¸­çš„é€»è¾‘è¡¨ï¼ˆé€»è¾‘è¡¨å’Œç‰©ç†è¡¨çš„ç»“æ„ä¸€æ ·ï¼‰ï¼Œä»£ç é¢å¯¹é€»è¾‘è¡¨æ“ä½œï¼Œè¯·æ±‚å®é™…ä¸Šç”±mycatæ ¹æ®é€»è¾‘è¡¨çš„è·¯ç”±è§„åˆ™è¿›è¡Œè·¯ç”±åˆ°å¯¹åº”çš„åº“ä¸­çš„ç‰©ç†è¡¨ï¼Œç»“æœç”±mycatè¿›è¡Œæ•´åˆè¿”å›ç»™åº”ç”¨
#### æ°´å¹³åˆ†è¡¨
å°†ä¸€å¼ è¡¨çš„æ•°æ®æ‹†åˆ†åˆ°å¤šä¸ªè¡¨ä¸­ï¼ˆå¯ä»¥åœ¨åŒä¸€ä¸ªåº“é‡Œï¼‰
å‡å°‘é”è¡¨çš„å‡ ç‡
### 4. ä¸»é”®é—®é¢˜
ä¸æ¨èä½¿ç”¨ä¸»é”®è‡ªå¢
#### åŸå› 
è‡ªå¢ä¸»é”®æ˜¯é¡ºåºçš„ï¼Œå®¹æ˜“è¢«çŒœåˆ°ï¼Œé­åˆ°æ”»å‡»
ä¼šå‘B+æ ‘çš„æœ€åä¸€é¡µæ·»åŠ æ•°æ®ï¼Œé¡µåˆ†è£‚ï¼Œé”ç«äº‰ï¼Œä¸»å†…å­˜çš„ç¼“å†²åŒºæ•°æ®åˆ·è„å‹åŠ›å…¨åœ¨æœ«å°¾æ•°æ®
å¯¹äºåˆ†åº“åˆ†è¡¨ï¼Œæ¯ä¸ªåº“éƒ½æœ‰è‡ªå¢ä¸»é”®å¾ˆå®¹æ˜“å‡ºç°ä¸»é”®é‡å¤çš„æƒ…å†µ
åœ¨æ•°æ®è¿ç§»æˆ–åˆå¹¶çš„æ—¶å€™ï¼Œå› ä¸ºidå†²çªéœ€è¦é‡æ–°æ˜ å°„ä¸»é”®
# Spring
## ä¸€. Bean
### 1. IOCå®¹å™¨
#### åŸç†åŠæµç¨‹
åŸºæœ¬æ€æƒ³æ˜¯æ§åˆ¶åè½¬ï¼Œå°†å¯¹è±¡çš„åˆ›å»ºå’Œç®¡ç†ç”±ç¨‹åºå‘˜å˜æˆäº†IOCå®¹å™¨ï¼Œç”±å®ƒæ¥åˆ›å»ºå¯¹è±¡ï¼Œæ³¨å…¥ä¾èµ–ï¼Œç®¡ç†ç”Ÿå‘½å‘¨æœŸï¼Œbeançš„åˆ›å»ºå’Œåˆå§‹åŒ–æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼Œä¸€ä¸ªbeanå®Œæˆå…¨éƒ¨æµç¨‹æ‰ä¼šç»§ç»­ä¸‹ä¸€ä¸ª
##### å®¹å™¨å¯åŠ¨
```java
public void refresh() throws BeansException, IllegalStateException {
    // 1. é¢„å¤„ç†
    prepareRefresh();
    // 2. è·å– BeanFactoryï¼ˆæ ¸å¿ƒå®¹å™¨ï¼‰
    ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();
    // 3. BeanFactory çš„å‡†å¤‡å·¥ä½œ
    prepareBeanFactory(beanFactory);
    // 4. æ³¨å†ŒBeanDefinitionï¼ˆæ ¸å¿ƒï¼‰
    invokeBeanFactoryPostProcessors(beanFactory);
    // 5. æ³¨å†ŒBeanPostProcessor
    registerBeanPostProcessors(beanFactory);
    // 6. å®ä¾‹åŒ–å•ä¾‹Bean
    finishBeanFactoryInitialization(beanFactory);
    // 7. å®Œæˆ refresh
    finishRefresh();
}

```
##### BeanDefinition è§£æ
```java
//æ³¨å†Œ
beanDefinitionRegistry.registerBeanDefinition(beanName, beanDefinition);
//å­˜å‚¨åˆ°å®¹å™¨
Map<String, BeanDefinition> beanDefinitionMap;
```
é€šè¿‡@ComponentScanæ‰«æåŒ…
è§£æåˆ°@Componentã€@Beanç­‰æ³¨è§£
å°†å…¶è½¬æ¢æˆBeanDefinitionï¼Œå¹¶æ³¨å†Œåˆ°å®¹å™¨é‡Œï¼ˆæ­¤æ—¶è¿˜æ²¡æœ‰ç«‹å³åˆ›å»ºå¯¹è±¡ï¼‰
##### å®ä¾‹åŒ– Bean
```java
Object beanInstance = doCreateBean(beanName, mbd, args);
```
Springæ ¹æ®æŒ‰éœ€åˆ›å»º + æ‡’åŠ è½½åŸåˆ™ï¼ˆ`@Component`ã€`@Service`ã€`@Controller`è¿™äº›é»˜è®¤å•ä¾‹ï¼Œåœ¨å®¹å™¨åˆå§‹åŒ–æ—¶åˆ›å»ºï¼Œå…¶ä»– scopeå‚æ•°ï¼Œæ¯”å¦‚`prototype`æ˜¯å¤šä¾‹ï¼Œæ˜¯ç”¨åˆ°æ—¶æ‰åˆ›å»ºï¼‰ï¼Œé€šè¿‡åå°„åˆ›å»ºå‡ºå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯beançš„å®ä¾‹ï¼Œæ³¨æ„æ­¤æ—¶beançš„å†…éƒ¨çš„å±æ€§æ˜¯æ²¡æœ‰å€¼çš„ï¼Œç›¸å½“äºä½¿ç”¨æ— å‚æ„é€ å™¨åˆ›å»ºå‡ºæ¥çš„å®ä¾‹
##### ä¾èµ–æ³¨å…¥ï¼ˆDIæ ¸å¿ƒï¼‰
```java
protected void populateBean(String beanName, RootBeanDefinition mbd, @Nullable BeanWrapper bw) {
    // å¤„ç† @Autowiredã€@Resource
    for (InjectionElement element : injectionMetadata.getInjectedElements()) {
        element.inject(bean, beanName, pvs);
    }
}
```
é€šè¿‡åå°„å°†è¿™ä¸ªä¾èµ–beanä½œä¸ºå±æ€§çš„å€¼æ³¨å…¥åˆ°ä½¿ç”¨äº†è¿™ä¸ªbeançš„å¯¹è±¡é‡Œ
```java
field.setAccessible(true);
field.set(beanInstance, injectedValue);
```
##### BeanPostProcessor æ‰©å±•ï¼ˆAOPé’©å­ï¼‰
```java
//applyBeanPostProcessorsBeforeInitializationè´Ÿè´£è°ƒç”¨æ‰€æœ‰å®ç°äº†`BeanPostProcessor`æ¥å£çš„`postProcessBeforeInitialization`æ–¹æ³•
Object wrappedBean = applyBeanPostProcessorsBeforeInitialization(bean, beanName);
//æœ€åçš„åˆå§‹åŒ–ï¼Œè°ƒç”¨beançš„åˆå§‹åŒ–æ–¹æ³•
invokeInitMethods(beanName, wrappedBean, mbd);
//å¦‚æœbeanå®ç°äº†postProcessAfterInitializationæ–¹æ³•ï¼Œ`applyBeanPostProcessorsAfterInitialization` è´Ÿè´£è°ƒç”¨æ‰€æœ‰å®ç°äº†`BeanPostProcessor`æ¥å£çš„`postProcessAfterInitialization`æ–¹æ³•
applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);
```
æ‰§è¡Œbeanå†…éƒ¨çš„`@PostConstruct` / @afterPropertiesSetè¿™ç±»initæ–¹æ³•ï¼Œå¯¹beanè¿›è¡Œæœ€åçš„åˆå§‹åŒ–ï¼Œå¦‚æœbeanæ²¡æœ‰å®ç°postProcessAfterInitializationæ–¹æ³•ï¼Œspringçš„AOPç»„ä»¶å…¶å®å·²ç»å®ç°äº†ï¼Œå®ƒä¼šåˆ¤æ–­æ˜¯å¦è¦ä¸ºè¿™ä¸ªbeanç”Ÿæˆä»£ç†å¯¹è±¡ï¼Œä¾‹å¦‚æ˜¯å¦ä½¿ç”¨äº†äº‹åŠ¡æ³¨è§£
```java
// springçš„aopç»„ä»¶é»˜è®¤postProcessAfterInitializationæ–¹æ³•å®ç°æºç 
@Override
public Object postProcessAfterInitialization(Object bean, String beanName) {
    // 1. è·³è¿‡åŸºç¡€ç±»å‹ã€è‡ªå·±ä¸ä»£ç†è‡ªå·±ç­‰åˆ¤æ–­
    if (shouldSkip(bean, beanName)) {
        return bean;
    }
    // 2. æ ¹æ®é…ç½®åˆ›å»ºä»£ç†
    Object cacheKey = getCacheKey(bean.getClass(), beanName);
    Object proxy = this.cachedProxy(cacheKey);
    if (proxy == null) {
        proxy = createProxy(bean, beanName);
        cacheProxy(cacheKey, proxy);
    }
    return proxy;
}
protected Object createProxy(Object bean, String beanName) {
    Class<?> beanClass = bean.getClass();
    // 1. å…ˆè·å–æ‰€æœ‰è¦ç»‡å…¥çš„åˆ‡é¢ï¼ˆAdvisorï¼‰
    List<Advisor> advisors = findEligibleAdvisors(beanClass, beanName);

    if (advisors.isEmpty()) {
        return bean;
    }

    // 2. æ ¹æ®ä»£ç†ç­–ç•¥åˆ›å»ºä»£ç†
    ProxyFactory proxyFactory = new ProxyFactory();
    proxyFactory.copyFrom(this);
    proxyFactory.setTarget(bean);
    proxyFactory.setInterfaces(beanClass.getInterfaces());
    proxyFactory.addAdvisors(advisors);
    proxyFactory.setProxyTargetClass(isProxyTargetClass());

    // 3. ç”Ÿæˆä»£ç†å¯¹è±¡ï¼ˆJDKåŠ¨æ€ä»£ç†æˆ–CGLIBä»£ç†ï¼‰
    return proxyFactory.getProxy(getProxyClassLoader());
}
```
```java
for (BeanPostProcessor processor : postProcessors) {
    currentBean = processor.postProcessAfterInitialization(currentBean, beanName);
}
```
æ ¹æ®springçš„è´£ä»»é“¾æ¨¡å¼ï¼Œè¿”å›çš„ä¸œè¥¿ä¼šç»§ç»­è¢«å¤„ç†ï¼Œå¦‚æœbeanå®ç°çš„æ–¹æ³•è¿”å›çš„æ˜¯ä»£ç†å¯¹è±¡ï¼Œspringå°±ä¸ä¼šç»§ç»­ä¸ºè¿™ä¸ªbeanä»£ç†ï¼Œæ‰€ä»¥å¦‚æœç”Ÿæˆä»£ç†çš„é€»è¾‘æœ‰é—®é¢˜ä¼šå¯¼è‡´é€»è¾‘é‡å¤ï¼Œä»£ç†åµŒå¥—æˆ–ç»ˆæ­¢springè‡ªå¸¦çš„äº‹åŠ¡ä»£ç†
##### å•ä¾‹æ± ç®¡ç†
`singletonObjects` æ˜¯ Spring çš„å•ä¾‹æ± ï¼š
```java
Map<String, Object> singletonObjects;
```
æ‰€æœ‰åˆ›å»ºå¥½çš„ Bean ä¼šæ”¾è¿›å»ï¼Œåç»­ç›´æ¥å–ï¼š
```java
getSingleton(beanName);
```
å°†beanå­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œåç»­éœ€è¦ç›´æ¥ä»å†…å­˜é‡Œå–å‡º
### 2. å•ä¾‹beançº¿ç¨‹å®‰å…¨
å¯¹äºbeanä¸­çš„æ— çŠ¶æ€æˆå‘˜å±æ€§ï¼ˆæ— æ³•ä¿®æ”¹çŠ¶æ€çš„å±æ€§ï¼‰æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯ä»¥ä¿®æ”¹çš„æˆå‘˜å±æ€§ï¼Œåœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹ä¼šæœ‰çº¿ç¨‹å®‰å…¨
### 3. ä¸‰çº§ç¼“å­˜
Spring IOC å®¹å™¨é‡Œç”¨äºç®¡ç† Bean çš„ç¼“å­˜ï¼Œä¸»è¦æœ‰**ä¸‰çº§ç¼“å­˜**ï¼Œå½“éœ€è¦ä¾èµ–æ³¨å…¥æ—¶ä»ä¸€çº§å¼€å§‹å¯»æ‰¾
éœ€è¦æ³¨æ„åˆ°ï¼Œä¸‰çº§ç¼“å­˜åªèƒ½è§£å†³beanåˆå§‹åŒ–çš„å¾ªç¯ä¾èµ–é—®é¢˜ï¼Œåœ¨åˆ›å»ºbeanæ—¶ï¼Œå¦‚æœæœ‰**æœ‰å‚æ„é€ å™¨**æ˜¯æ— æ³•è§£å†³çš„ï¼Œå› ä¸ºåœ¨åˆ›å»ºå®ä¾‹é˜¶æ®µç¼“å­˜é‡Œæ˜¯æ²¡æœ‰ä¸œè¥¿çš„ï¼Œæ— æ³•æ³¨å…¥ä¾èµ–ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡æ‡’åŠ è½½ï¼Œä¹Ÿå°±æ˜¯éœ€è¦çš„æ—¶å€™å†å»æ³¨å…¥ï¼Œå¯ä»¥å°†beançš„åˆ›å»ºå»¶è¿Ÿåˆ°åˆå§‹åŒ–æ—¶ç”¨ä¸‰çº§ç¼“å­˜çš„å‡½æ•°å’Œä¸€äºŒçº§çš„ç¼“å­˜beanè§£å†³
```java
// ä¸€çº§ç¼“å­˜ï¼šçœŸæ­£åˆå§‹åŒ–å®Œçš„å•ä¾‹
private final Map<String, Object> singletonObjects = new ConcurrentHashMap<>();

// äºŒçº§ç¼“å­˜ï¼šåŠæˆå“å¯¹è±¡ï¼ˆå·²ç»æå‰æš´éœ²çš„å¼•ç”¨ï¼‰
private final Map<String, Object> earlySingletonObjects = new HashMap<>();

// ä¸‰çº§ç¼“å­˜ï¼šObjectFactoryï¼ˆå»¶è¿Ÿç”Ÿæˆä»£ç†çš„å·¥å‚ï¼‰
private final Map<String, ObjectFactory<?>> singletonFactories = new HashMap<>();
```
```java
public class A{
	privite B b;
	public A(@lazy B b){
		this.b=b;
	}
}
```
#### ä¸€çº§ç¼“å­˜
singletonObjectsï¼šå­˜å‚¨çœŸæ­£**å®Œæˆäº†åˆå§‹åŒ–ï¼ˆå†…éƒ¨ä¾èµ–å·²ç»æ³¨å…¥ï¼‰çš„beanå®ä¾‹**
#### äºŒçº§ç¼“å­˜
earlySingletonObjectsï¼š**æ²¡æœ‰å®Œæˆåˆå§‹åŒ–çš„beanå®ä¾‹**ï¼Œè¿™ç§æ˜¯ä¸èƒ½æ‹¿æ¥ç›´æ¥ç”¨çš„ï¼ˆä¸èƒ½ä½œä¸ºä¾èµ–ç›´æ¥æ³¨å…¥åˆ°å…¶ä»–beané‡Œï¼‰ï¼Œåªèƒ½æå‰æš´éœ²å¼•ç”¨ï¼Œè§£å†³å¾ªç¯ä¾èµ–é—®é¢˜
æš´éœ²å¼•ç”¨ï¼Œè¿™ä¸ªå¼•ç”¨å¯èƒ½æ˜¯åŸå§‹å¯¹è±¡æˆ–ä»£ç†å¯¹è±¡ï¼Œå¯èƒ½æ˜¯ç”±ä¸‰çº§ç¼“å­˜çš„å‡½æ•°ç”Ÿäº§çš„
#### ä¸‰çº§ç¼“å­˜
```java
// æå‰æš´éœ²å¼•ç”¨ï¼ˆä¸‰çº§ç¼“å­˜ï¼‰
if (mbd.isSingleton()) {
	//getEarlyBeanReferenceå»¶è¿Ÿè°ƒç”¨çš„å‡½æ•°ï¼Œç”Ÿæˆå¯¹è±¡å¼•ç”¨ï¼ˆå¯èƒ½æ˜¯ä»£ç†å¯¹è±¡æˆ–è€…åŸå§‹å¯¹è±¡ï¼‰
    addSingletonFactory(beanName, () -> getEarlyBeanReference(beanName, bean));
}
```
singletonFactoriesï¼šObjectFactoryï¼Œæä¾›åˆ›å»º Bean çš„å·¥å‚ï¼Œç”¨äº**äº§ç”Ÿ**æå‰æš´éœ²å¯¹è±¡ï¼ˆå¦‚ä»£ç†ï¼‰

### 4. AOP
é¢å‘åˆ‡é¢ç¼–ç¨‹ï¼Œç”¨äºå°†é‚£äº›ä¸ä¸šåŠ¡æ— å…³çš„ï¼Œä½†å¯¹å¤šä¸ªå¯¹è±¡äº§ç”Ÿå½±å“çš„ä»£ç ï¼ŒæŠ½å–æˆå…¬å…±å—å¤ç”¨ï¼Œé™ä½ä»£ç è€¦åˆ
å¯ä»¥é€šè¿‡ç¯ç»•é€šçŸ¥è®°å½•æ—¥å¿—ç­‰
Springçš„å£°æ˜å¼äº‹åŠ¡å°±æ˜¯ä½¿ç”¨AOPå¯¹æ–¹æ³•è¿›è¡Œäº†æ‹¦æˆªï¼Œæ¥å¼€å¯äº‹åŠ¡ï¼Œæäº¤æˆ–å›æ»šäº‹åŠ¡
### 5. äº‹åŠ¡å¤±æ•ˆ
#### å¼‚å¸¸æ•è·å¤„ç†
å¦‚æœåœ¨æ–¹æ³•å†…éƒ¨å°†å¼‚å¸¸æ•è·åï¼Œ**è‡ªè¡Œå¤„ç†ä¸”æ²¡æœ‰ç»§ç»­å‘å¤–æŠ›å‡º**ï¼Œé‚£ä¹ˆåœ¨å‘ç”Ÿå¼‚å¸¸åï¼Œä»£ç†å¯¹è±¡çš„catchéƒ¨åˆ†æ˜¯æ— æ³•è¢«è§¦å‘çš„ï¼Œå¯¼è‡´äº‹åŠ¡å¤±æ•ˆ
#### æŠ›å‡ºæ£€æŸ¥å¼‚å¸¸
äº‹åŠ¡é»˜è®¤æ˜¯catchè¿è¡Œæ—¶å¼‚å¸¸ï¼Œå¦‚æœ**æŠ›å‡ºçš„æ˜¯æ£€æŸ¥æ—¶å¼‚å¸¸**ï¼Œå°±æ— æ³•æ­£å¸¸æ£€æµ‹
#### épublicæ–¹æ³•
**åªæœ‰æ–¹æ³•æ˜¯publicæ–¹æ³•ï¼Œäº‹åŠ¡æ‰èƒ½ç”Ÿæ•ˆ**ï¼ŒAOPæœ¬èº«åªèƒ½æ‹¦æˆªpublicæ–¹æ³•ï¼Œå› ä¸ºjdkåŠ¨æ€ä»£ç†çš„æ˜¯æ¥å£ï¼Œè€Œæ¥å£é‡Œçš„æ–¹æ³•éƒ½æ˜¯publicï¼ŒCGLIBä»£ç†è™½ç„¶å¯ä»¥ä»£ç†ç±»ï¼Œä½†é»˜è®¤ä¹Ÿåªæ‹¦æˆª public æ–¹æ³•ï¼Œå› ä¸º Spring è§„èŒƒé‡Œäº‹åŠ¡æ³¨è§£æ˜¯ç”¨äºä¸šåŠ¡é€»è¾‘å±‚ï¼ˆService å±‚ï¼‰å…¬å…± API çš„äº‹åŠ¡æ§åˆ¶ã€‚
### 6. @Componentå’Œ@Beançš„åŒºåˆ«
| æ–¹å¼                            | é»˜è®¤ä½œç”¨åŸŸ                   | è¯´æ˜                               |
| ----------------------------- | ----------------------- | -------------------------------- |
| `@Component`                  | å•ä¾‹ï¼ˆsingletonï¼‰           | è¢«æ‰«æåè‡ªåŠ¨æ³¨å…¥å®¹å™¨ï¼Œé»˜è®¤å°±æ˜¯å•ä¾‹                |
| `@Bean`ï¼ˆåœ¨ `@Configuration` é‡Œï¼‰ | å•ä¾‹ï¼ˆsingletonï¼‰           | è¿”å›çš„å¯¹è±¡åŒæ ·æ˜¯å•ä¾‹                       |
| `@Bean`ï¼ˆåœ¨ **æ™®é€šç±»** é‡Œï¼‰          | çœ‹èµ·æ¥æ˜¯å•ä¾‹ï¼Œå…¶å®æ¯æ¬¡è°ƒç”¨éƒ½ä¼š newï¼ˆâš ï¸ï¼‰ | å› ä¸ºæ²¡èµ° **CGLIB å¢å¼ºä»£ç†**ï¼Œæ–¹æ³•ä¹‹é—´ä¸å…±äº«åŒä¸€ä¸ªå®ä¾‹ |
- Componentç”¨åœ¨ç±»ä¸Šï¼Œ@Beanç”¨åœ¨æ–¹æ³•ä¸Šï¼Œå°†è¿”å›å€¼æ³¨å…¥åˆ°ioc
- å®šä¹‰åœ¨Configurationé‡Œçš„beanæ˜¯å•ä¾‹çš„ï¼Œæ— è®ºæ˜¯æ³¨å…¥è¿˜æ˜¯è°ƒç”¨æ–¹æ³•å¾—åˆ°éƒ½æ˜¯åŒä¸€ä¸ª
- å®šä¹‰åœ¨Componenté‡Œçš„beanï¼Œæ³¨å…¥æ—¶æ˜¯å•ä¾‹ï¼Œè°ƒç”¨æ–¹æ³•è¿”å›çš„æ˜¯æ–°çš„
### 7. JDKåŠ¨æ€ä»£ç†å’ŒCGLIBä»£ç†
| å¯¹æ¯”ç»´åº¦                   | JDK åŠ¨æ€ä»£ç†                                 | CGLIB åŠ¨æ€ä»£ç†                                            |
| ---------------------- | ---------------------------------------- | ----------------------------------------------------- |
| ğŸ“Œ **ä»£ç†åŸç†**            | åŸºäº Java åå°„ç”Ÿæˆå®ç°æ¥å£çš„ä»£ç†ç±»                     | åŸºäº ASM å­—èŠ‚ç æŠ€æœ¯ç”Ÿæˆç›®æ ‡ç±»çš„å­ç±»ï¼ˆç»§æ‰¿ï¼‰                              |
| ğŸ¯ **æ˜¯å¦éœ€è¦æ¥å£**          | âœ… æ˜¯ï¼Œå¿…é¡»å®ç°æ¥å£                               | âŒ å¦ï¼Œå¯ä»¥æ˜¯æ™®é€šç±»                                            |
| ğŸ§± **ä»£ç†ç±»ç»“æ„**           | åŠ¨æ€åˆ›å»ºçš„å®ç°æ¥å£çš„ç±»ï¼ˆå¦‚ `$Proxy0`ï¼‰                 | åŠ¨æ€åˆ›å»ºçš„å­ç±»ï¼Œç»§æ‰¿äº†åŸç±»ï¼ˆå¦‚ `UserService$$EnhancerByCGLIB$$xxxx`ï¼‰ |
| ğŸ” **æ–¹æ³•è°ƒç”¨åŸç†**          | å°†æ–¹æ³•è°ƒç”¨è½¬å‘åˆ° `InvocationHandler.invoke(...)` | é‡å†™æ–¹æ³•ï¼Œé€šè¿‡ `MethodProxy.invokeSuper(...)` è°ƒç”¨çˆ¶ç±»æ–¹æ³•         |
| ğŸ” **è°ƒç”¨çœŸå®æ–¹æ³•æ–¹å¼**        | ä½¿ç”¨åå°„è°ƒç”¨ï¼ˆæ€§èƒ½ç¨æ…¢ï¼‰                             | ç›´æ¥è°ƒç”¨ `super.åŸæ–¹æ³•()`ï¼ˆæ¯”åå°„å¿«ï¼‰                              |
| âš ï¸ **final æ”¯æŒæƒ…å†µ**      | âœ… å¯ä»¥ä»£ç† final ç±»çš„æ–¹æ³•ï¼ˆå› ä¸ºæ˜¯åå°„ï¼‰                 | âŒ ä¸èƒ½ä»£ç† final ç±»æˆ– final æ–¹æ³•ï¼ˆä¸èƒ½è¢«ç»§æ‰¿ï¼‰                       |
| ğŸ§± **ç”Ÿæˆç±»ç»§æ‰¿ç»“æ„**         | ä¸ç»§æ‰¿ç›®æ ‡ç±»                                   | ç»§æ‰¿ç›®æ ‡ç±»ï¼ˆç›®æ ‡ç±»ä¸èƒ½æ˜¯ finalï¼‰                                   |
| ğŸ§± **ç›®æ ‡ç±»å­—æ®µç»§æ‰¿æƒ…å†µ**       | ä¸å¯è®¿é—®ç›®æ ‡ç±»å­—æ®µ                                | å¯ç»§æ‰¿å­—æ®µï¼ˆå¯ä»¥è®¿é—®çˆ¶ç±»protected/publicå­—æ®µï¼‰                       |
| ğŸ’¥ **ç±»åŠ è½½æœºåˆ¶**           | ä½¿ç”¨ Java è‡ªå¸¦çš„ `ProxyGenerator` åˆ›å»ºç±»å­—èŠ‚ç       | ä½¿ç”¨ CGLIB + ASM æ“ä½œå­—èŠ‚ç åˆ›å»ºç±»                               |
| ğŸ”¥ **æ€§èƒ½ï¼ˆJDK >= 1.8ï¼‰**  | å¿«ï¼ˆJDK 1.8ä¹‹åä¼˜åŒ–äº†åå°„æœºåˆ¶ï¼‰                      | æ›´å¿«ï¼ˆä½¿ç”¨çš„æ˜¯å­—èŠ‚ç ç›´æ¥è°ƒç”¨ï¼‰                                       |
| ğŸ§ª **Spring AOP é»˜è®¤ç­–ç•¥** | Spring é»˜è®¤ä½¿ç”¨ JDK ä»£ç†ï¼ˆå¦‚æœç›®æ ‡ç±»å®ç°äº†æ¥å£ï¼‰           | å¦‚æœç›®æ ‡ç±»æ²¡æœ‰å®ç°æ¥å£ï¼Œåˆ™è‡ªåŠ¨é™çº§ä¸º CGLIB                              |
| âš™ï¸ **æ˜¯å¦æ”¯æŒæ³¨è§£ä»£ç†**        | æ”¯æŒï¼ˆé€šè¿‡æ¥å£å®ç°è°ƒç”¨ï¼‰                             | æ”¯æŒï¼ˆå¯ä»¥ä»£ç†ç±»ä¸Šçš„æ³¨è§£ï¼‰                                         |
| ğŸ› ï¸ **æ˜¯å¦æ”¯æŒç±»æ³¨å…¥å­—æ®µ**      | ä¸æ”¯æŒï¼ˆä»£ç†ç±»ä¸ç›®æ ‡ç±»æ— ç»§æ‰¿å…³ç³»ï¼‰                        | æ”¯æŒï¼Œå› å…¶æ˜¯ç›®æ ‡ç±»çš„å­ç±»                                          |
| ğŸ“š **å¸¸è§åº”ç”¨æ¡†æ¶æ”¯æŒ**        | Javaæ ‡å‡†ã€Spring AOPã€MyBatis Mapper åŠ¨æ€ä»£ç†    | Spring AOPã€Hibernateæ‡’åŠ è½½ã€AspectJ ç­‰                     |
#### JDKåŠ¨æ€ä»£ç†ï¼ˆä»£ç†çš„ç›®æ ‡å¿…é¡»å®ç°äº†æŸä¸ªæ¥å£ï¼‰
```java
public interface IUserService {
    void login(String username);
}

public class UserService implements IUserService {
    @Override
    public void login(String username) {
        System.out.println(username + " ç™»å½•ç³»ç»Ÿ");
    }
}

//ç”Ÿæˆä»£ç†å¯¹è±¡é€»è¾‘
public class JdkProxyFactory {
    public static Object getProxy(Object target) {
        return Proxy.newProxyInstance(
		        //åŸç±»çš„ç±»åŠ è½½å™¨ï¼Œç”¨äºç”Ÿæˆä»£ç†å¯¹è±¡çš„å­—èŠ‚ç ï¼Œé€šè¿‡å­—èŠ‚ç åˆ©ç”¨åå°„åˆ›å»ºå‡ºçœŸæ­£çš„ä»£ç†å¯¹è±¡
                target.getClass().getClassLoader(),
                //ç›®æ ‡ç±»å®ç°çš„æ¥å£ç±»
                target.getClass().getInterfaces(),
                //ä»£ç†å¯¹è±¡å†…æ–¹æ³•é€»è¾‘çš„ç”Ÿæˆå™¨
                new InvocationHandler() {
                    @Override
                    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
                        System.out.println("[JDKå‰ç½®] æ–¹æ³•ï¼š" + method.getName());
                        Object result = method.invoke(target, args);
                        System.out.println("[JDKåç½®]");
                        return result;
                    }
                }
        );
    }
}
```
ç›®æ ‡è¦ä»£ç†çš„ç±»ï¼Œå¿…é¡»å®ç°ä¸€ä¸ªæ¥å£
JDKåŠ¨æ€ä»£ç†çš„æœ¬è´¨å°±æ˜¯ç”Ÿæˆä¸€ä¸ªåŒæ ·**å®ç°äº†ç›¸åŒæ¥å£**çš„å¯¹è±¡ï¼Œå¯¹è±¡å†…éƒ¨æœ‰ç›®æ ‡ç±»çš„å¯¹è±¡ï¼Œè¿™ä¸ªä»£ç†å¯¹è±¡å®ç°çš„æ–¹æ³•é€»è¾‘é‡Œè°ƒç”¨äº†åŸç±»çš„æ–¹æ³•ï¼Œå¹¶åŠ ä¸Šäº†å‰åç¯ç»•
#### CGLIBä»£ç†
```java
public class CglibProxyFactory {
    public static Object getProxy(Object target) {
        Enhancer enhancer = new Enhancer();
        enhancer.setSuperclass(target.getClass()); // ç»§æ‰¿ç›®æ ‡ç±»
        enhancer.setCallback(new MethodInterceptor() {
	        //é‡å†™æ–¹æ³•é€»è¾‘
            @Override
            public Object intercept(Object obj, Method method, Object[] args, MethodProxy proxy) throws Throwable {
                System.out.println("[CGLIBå‰ç½®] æ–¹æ³•ï¼š" + method.getName());
                //æ‰§è¡ŒåŸç±»æ–¹æ³•
                Object result = proxy.invokeSuper(obj, args); // æ³¨æ„ï¼šè°ƒç”¨çš„æ˜¯ super è€Œä¸æ˜¯åå°„
                System.out.println("[CGLIBåç½®]");
                return result;
            }
        });
        return enhancer.create();
    }
}
```
CGLIBä»£ç†æœ¬è´¨å°±æ˜¯ï¼Œç”Ÿæˆä¸€ä¸ª**ç»§æ‰¿äº†ç›®æ ‡å¯¹è±¡**çš„ä»£ç†å¯¹è±¡ï¼Œé‡å†™ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•ï¼Œåœ¨æ–¹æ³•é‡ŒåŠ ä¸Šå‰åç¯ç»•ï¼Œç„¶åæ‰§è¡Œç›®æ ‡å¯¹è±¡çš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯çˆ¶ç±»æ–¹æ³•

## äºŒ. SpringMVC
### 1. æ‰§è¡Œæµç¨‹
#### è§†å›¾é˜¶æ®µï¼ˆJSPï¼‰
```txt
è¯·æ±‚ -> DispatcherServlet -> HandlerMapping -> HandlerExecutionChain
       -> HandlerAdapter -> Controller -> ModelAndView -> ViewResolver
       -> View -> æ¸²æŸ“ HTML -> è¿”å›ç»™å®¢æˆ·ç«¯
```
1. ç”¨æˆ·å‘å‡ºè¯·æ±‚ä¼šå…ˆåˆ°è¾¾å‰ç«¯æ§åˆ¶å™¨
2. å‰ç«¯æ§åˆ¶å™¨ä¼šè°ƒç”¨ä¸€ä¸ªæˆ–å¤šä¸ªå¤„ç†å™¨æ˜ å°„å™¨
	1. æ ¹æ®è¯·æ±‚è·¯å¾„æ‰¾åˆ°å¯¹åº”çš„å¤„ç†å™¨ï¼ˆcontrollerä¸­çš„æŸä¸ªæ–¹æ³•ï¼‰
	2. åŒæ—¶å¤„ç†å™¨æ˜ å°„å™¨ä¼šè¿”å›å¤„ç†å™¨æ‰§è¡Œé“¾HandlerExecutionChainï¼Œå…¶åŒ…å«ï¼šhandlerï¼Œæ‰€æœ‰çš„æ‹¦æˆªå™¨
	3. **éšåå‰ç«¯æ§åˆ¶å™¨é¡ºåºæ‰§è¡Œä¸€æ¬¡æ‹¦æˆªå™¨ï¼Œå‡ºç°falseç›´æ¥æ‹’ç»è¯·æ±‚**
3. å‰ç«¯æ§åˆ¶å™¨è°ƒç”¨å¤„ç†å™¨é€‚é…å™¨
	1. å‰ç«¯æ§åˆ¶å™¨ä¼ å…¥HandlerExecutionChain
	2. è°ƒç”¨å¯¹åº”çš„å¤„ç†å™¨é€‚é…å™¨æ‰§è¡Œhandler
	3. å¤„ç†å™¨é€‚é…å™¨è¿›è¡Œå‚æ•°è§£æï¼Œè°ƒç”¨controlleræ–¹æ³•ï¼Œè¿”å›ModelAndViewç»™å‰ç«¯æ§åˆ¶å™¨ï¼ŒåŒ…å«è§†å›¾åç§°å’Œæ¨¡å‹æ•°æ®
	4. **å‰ç«¯æ§åˆ¶å™¨é€†åºæ‰§è¡Œä¸€éæ‹¦æˆªå™¨**
4. è§†å›¾è§£æ
	1. å‰ç«¯æ§åˆ¶å™¨å°†ModelAndViewä¼ å…¥è§†å›¾è§£æå™¨ï¼Œ
	2. æ ¹æ®è§†å›¾åç§°æ‰¾åˆ°å¯¹åº”çš„jspæ–‡ä»¶ï¼Œè¿”å›ä¸€ä¸ªviewå¯¹è±¡
5. è§†å›¾æ¸²æŸ“
	1. å‰ç«¯æ§åˆ¶å™¨è°ƒç”¨view.renderæ–¹æ³•
	2. å°†æ¨¡å‹æ•°æ®å’Œjspæ¨¡æ¿è¿›è¡Œåˆå¹¶ã€æ¸²æŸ“ï¼ˆå¦‚ELè¡¨è¾¾å¼ï¼‰
	3. æœ€ç»ˆç”ŸæˆHTMLè¿”å›ç»™æµè§ˆå™¨

#### å‰åç«¯åˆ†ç¦»é˜¶æ®µ
```txt
        æµè§ˆå™¨/å‰ç«¯JS
             â†“
      DispatcherServlet
             â†“
     HandlerMapping  â€” æ‰¾åˆ°Controlleræ–¹æ³•
             â†“
     HandlerAdapter   â€” è°ƒç”¨ç›®æ ‡æ–¹æ³•
             â†“
     HttpMessageConverter
     ï¼ˆæ¯”å¦‚è¿”å› JSONï¼‰
             â†“
     å“åº”å†™å›ç»™å‰ç«¯
```
å‰é¢æ­¥éª¤éƒ½ä¸€è‡´ï¼Œåœ¨adaptorè°ƒç”¨å®Œcontrolleræ–¹æ³•ä¹‹åä¼šè¿›è¡Œè¿”å›å€¼å¤„ç†ï¼Œè½¬æ¢æˆjsonï¼Œå°è£…è¿›responseï¼Œé€šè¿‡ç½‘ç»œè¿”å›ç»™å‰ç«¯
## ä¸‰. Springboot
### 1. è‡ªåŠ¨è£…é…
```java
@Configuration
@EnableAutoConfiguration
@ComponentScan
public @interface SpringBootApplication { }
```
```java
@Target({ElementType.TYPE})  
@Retention(RetentionPolicy.RUNTIME)  
@Documented  
@Inherited  
@AutoConfigurationPackage  
@Import({AutoConfigurationImportSelector.class})  
public @interface EnableAutoConfiguration { }
```
1. å…³é”®æ³¨è§£åœ¨äºå¯åŠ¨æ³¨è§£å†…çš„@**EnableAutoConfiguration**ï¼Œå®ƒä¼šè§¦å‘è‡ªåŠ¨è£…é…æµç¨‹
2. å®ƒçš„@**Import({AutoConfigurationImportSelector.class})** å‘springå®¹å™¨ä¸­å¯¼å…¥ä¸€ä¸ªç»„ä»¶ï¼ˆconfigurationç±»ï¼‰
3. springé€šè¿‡è°ƒç”¨AutoConfigurationImportSelectorçš„selectImportsæ–¹æ³•ï¼Œè¯»å–META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.importsè‡ªåŠ¨è£…é…æ–‡ä»¶
4. é€ä¸ªåˆ¤æ–­è¿™ä¸ªè‡ªåŠ¨è£…é…ç±»æ˜¯å¦æ»¡è¶³è£…é…æ¡ä»¶:
```java
@AutoConfiguration  //xxxAutoConfigurationè‡ªåŠ¨è£…é…ç±»çš„ç‰¹å¾
@ConditionalOnClass({OllamaApi.class})  
@EnableConfigurationProperties({OllamaConnectionProperties.class}) //å¯¼å…¥é…ç½®å±æ€§ç±»
```
```java
@ConfigurationProperties("spring.ai.ollama.chat") //é…ç½®å±æ€§ç±»ç‰¹å¾ï¼Œå®šä¹‰é…ç½®å‰ç¼€
```
```java
@ConditionalOnClassï¼šclasspath ä¸­æœ‰è¯¥ç±»æ‰ç”Ÿæ•ˆ
@ConditionalOnMissingBeanï¼šå¦‚æœæ²¡æœ‰ç”¨æˆ·å®šä¹‰çš„ Beanï¼Œæ‰æ³¨å…¥é»˜è®¤ Bean
@ConditionalOnPropertyï¼šé…ç½®äº†æŸä¸ªå±æ€§æ‰ç”Ÿæ•ˆ
@ConditionalOnBeanï¼šå­˜åœ¨æŸä¸ª Bean æ‰ç”Ÿæ•ˆ
```
5. å¦‚æœæŸä¸ªxxxAutoconfigurationæ»¡è¶³æ‰€æœ‰æ¡ä»¶å°±ä¼šå°†å…¶å†…éƒ¨å®šä¹‰çš„beanæ³¨å…¥åˆ°iocå®¹å™¨ä¸­
# Mybatis/Mybatis-plus
## ä¸€ . Mybatis
### 1. æ‰§è¡Œæµç¨‹
```txt
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ SpringBoot  â”‚ï¼ˆæ³¨å…¥ Mapperã€é…ç½®ï¼‰
     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
            â†“
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ MapperProxy   â”‚ï¼ˆåŠ¨æ€ä»£ç† Mapper æ¥å£ï¼‰
     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ DefaultSqlSessionâ”‚ï¼ˆçœŸæ­£æ‰§è¡Œ SQL çš„ç±»ï¼‰
     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Executorï¼ˆæ‰§è¡Œå™¨ï¼‰â”‚
     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ StatementHandler â”‚ï¼ˆé¢„ç¼–è¯‘ SQLï¼‰
     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ ParameterHandler â”‚ï¼ˆè®¾ç½®å‚æ•°ï¼‰
     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ ResultSetHandler â”‚ï¼ˆå¤„ç†ç»“æœï¼‰
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
- springbootå¯åŠ¨åï¼Œmybatisçš„è‡ªåŠ¨é…ç½®ç±»ä¼šå…ˆè¯»å–mybatis.configæ–‡ä»¶é…ç½®ï¼ŒåŒ…æ‹¬Mapperæ¥å£å’ŒMapperæ–‡ä»¶çš„æ˜ å°„ï¼Œæ•°æ®åº“çš„è¿æ¥ä¿¡æ¯
- Mapperæ¥å£åœ¨å¯åŠ¨æ—¶è¢«MapperScannerRegistraræ‰«æï¼Œåˆ›å»ºå‡ºMapperFactoryBeanï¼Œå¹¶ç”±MapperFactoryBeanç”Ÿæˆä¸€ä¸ªä»£ç†å¯¹è±¡MapperProxyï¼Œè°ƒç”¨æ¥å£æ–¹æ³•å®é™…ä¸Šæ˜¯MapperProxy#invoke()æ–¹æ³•æ‰§è¡Œsqlï¼š
```java
public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
    MapperMethod mapperMethod = cachedMapperMethod(method);
    return mapperMethod.execute(sqlSession, args);
}
```
- MapperProxyä¸­ä¼šç¼“å­˜æ¯ä¸ªMapperçš„æ–¹æ³•çš„æ–¹æ³•åå’Œå‚æ•°
```java
public <T> T selectOne(String statement, Object parameter) {
    List<T> list = this.selectList(statement, parameter);
    return list.size() == 1 ? list.get(0) : null;
}
```
- åœ¨executeä¸­è°ƒç”¨å…¨å±€çš„sqlsessionå¯¹è±¡çš„selectOneæ–¹æ³•ï¼Œåœ¨selectListå†…éƒ¨è°ƒç”¨åº•å±‚çš„Executoræ‰§è¡Œsql
- æ ¹æ®æ–¹æ³•ç­¾åæ‰¾åˆ°å¯¹åº”çš„MappedStatementï¼ˆxmlæ–‡ä»¶ä¸­çš„sqlæ ‡ç­¾ï¼‰
- åˆ›å»ºPreparedStatementHandlerå¯¹è±¡è¿›è¡Œé¢„ç¼–è¯‘sql
- è°ƒç”¨ParameterHandlerè®¾ç½®sqlå‚æ•°ï¼Œå°†Javaå¯¹è±¡è½¬æ¢æˆsqlæ•°æ®
- æ‰§è¡Œsql
- è°ƒç”¨ResultSetHandlerè§£æç»“æœé›†ï¼Œå°è£…æˆJavaå¯¹è±¡
## äºŒ. Mybatis-plus
### 1. æ‰§è¡Œæµç¨‹
```java
public interface BaseMapper<T> {
    T selectById(Serializable id);
    int insert(T entity);
    ...
}
```
- æ‰˜ç®¡äº†BaseMapperçš„åŠ¨æ€ä»£ç†ï¼Œå°è£…äº†å¤§é‡çš„CURDæ–¹æ³•
- é¡¹ç›®å¯åŠ¨æ—¶ä¼šå°†é€šç”¨CURDæ–¹æ³•æ³¨å…¥åˆ°Mapperçš„ä»£ç†å¯¹è±¡ä¸­
- è‡ªå®šä¹‰ Wrapper æ„é€ å™¨ï¼ˆQueryWrapperã€UpdateWrapperï¼‰
## ä¸‰. æ³¨æ„ç‚¹
### 1. sqlæ ‡ç­¾å†…$ã€#çš„åŒºåˆ«
åœ¨æ‰§è¡Œmapperæ¥å£æ–¹æ³•æ—¶ï¼Œæœ€åä¼šåˆ›å»ºPreparedStatementHandlerå¯¹è±¡è¿›è¡Œé¢„ç¼–è¯‘sqlï¼Œè¿™æ—¶å¦‚æœsqlæ ‡ç­¾å†…å‚æ•°çš„å ä½ç¬¦æ˜¯$ï¼Œä¼šå°†æ–¹æ³•ä¼ å…¥çš„å‚æ•°ç›´æ¥æ‹¼æ¥è¿›sqlè¯­å¥é‡Œä¸ä¼šè¿›è¡Œé¢„ç¼–è¯‘ï¼Œè¿™ç§æ–¹å¼ä¼šå¯¼è‡´sqlæ³¨å…¥
å¦‚æœä½¿ç”¨çš„æ˜¯#ï¼Œä¼šå°†åŸå§‹sqlçš„å‚æ•°å ä½ç¬¦æ›¿æ¢æˆï¼Ÿå ä½ç¬¦ï¼Œç„¶åè¿›è¡Œé¢„ç¼–è¯‘ï¼Œä¹‹åå†è¿›è¡Œå‚æ•°è®¾ç½®ï¼Œç›¸å½“äºä½¿ç”¨jdbcåº•å±‚çš„prepareStatementæ–¹æ³•è¿›è¡Œå‚æ•°ä¼ å…¥ï¼Œå¯ä»¥æœ‰æ•ˆé˜²æ­¢sqlæ³¨å…¥
### 2. å»¶è¿ŸåŠ è½½
```xml
<resultMap id="userMap" type="User">
    <id property="id" column="id"/>
    <result property="name" column="name"/>
    
    <!-- collection è®¾ç½®å»¶è¿ŸåŠ è½½,fetchTypeå»¶è¿ŸåŠ è½½å­—æ®µï¼Œselectå»¶è¿ŸåŠ è½½æ–¹æ³•ï¼Œå¯æ¥è‡ªå¦å¤–çš„æ¥å£ -->
    <collection property="orders"
                ofType="Order"
                select="selectOrdersByUserId"
                column="id"
	            å»¶è¿ŸåŠ è½½å­—æ®µ
                fetchType="lazy"/>
</resultMap>

<select id="selectUserById" resultMap="userMap">
    SELECT * FROM user WHERE id = #{id}
</select>

<select id="selectOrdersByUserId" resultType="Order">
    SELECT * FROM orders WHERE user_id = #{id}
</select>
```
å…³é—­æ—¶ï¼Œä¼šå°†resulté‡Œçš„é¢å¤–å­—æ®µä¸€èµ·åŠ è½½ï¼Œå¼€å¯ååªæœ‰åœ¨è°ƒç”¨ç›®æ ‡ç»“æœçš„getæ–¹æ³•æ—¶æ‰ä¼šè°ƒç”¨å»¶è¿Ÿæ–¹æ³•è¿›è¡ŒæŸ¥è¯¢ï¼Œç„¶åé€šè¿‡setæ–¹æ³•å†™å…¥
### 3. ä¸€ã€äºŒçº§ç¼“å­˜
#### ä¸€çº§ç¼“å­˜
```java
Sqlsession sqlsession =new Sqlsession();
UserMapper1 u1=sqlsession.getMapper(UserMapper.class);
UserMapper1 u2=sqlsession.getMapper(UserMapper.class);
u1.getbyid(1);
//ç¬¬äºŒä¸ªæŸ¥è¯¢å’Œç¬¬ä¸€ä¸ªç›¸åŒï¼Œå› ä¸ºåœ¨åŒä¸€ä¸ªsqlsessionä¸‹ï¼Œæ˜¯ä¸ä¼šé‡å¤æŸ¥è¯¢è€Œæ˜¯ä»ä¸€çº§ç¼“å­˜é‡Œé¢å–
u1.getbyid(1);
```
é»˜è®¤å¼€å¯
æœ¬è´¨æ˜¯HashMap
ä½œç”¨åŸŸæ˜¯sqlsessionï¼Œåœ¨åŒä¸€ä¸ªsqlsessionä¸‹çš„ç¼“å­˜æ•°æ®å°±æ˜¯ä¸€çº§ç¼“å­˜ï¼Œç›¸åŒçš„æŸ¥è¯¢è¯­å¥ä¼šä¼˜å…ˆå»ä¸€çº§ç¼“å­˜é‡Œé¢æ‰¾ï¼Œå½“sqlsessionè¿›è¡Œflushæˆ–è€…closeåï¼Œé‡Œé¢çš„ç¼“å­˜å°±ä¼šè¢«æ¸…ç©º
#### äºŒçº§ç¼“å­˜
é»˜è®¤å…³é—­ï¼Œé™¤äº†è¦åœ¨é…ç½®æ–‡ä»¶é…ç½®å¤–ï¼Œè¿˜è¦ç»™mapperæ–‡ä»¶æ·»åŠ  **<cache/>** ï¼Œæ ‡è®°æ­¤mapperæ¥å£å¼€å¯äºŒçº§ç¼“å­˜
ä½œç”¨åŸŸæ˜¯mapperï¼Œå’Œsessionæ— å…³ï¼ŒåŒä¸€ä¸ªæ¥å£çš„ä¸åŒå¯¹è±¡ä¼šåœ¨æ‰€å±çš„sessionæäº¤æˆ–å…³é—­åå°†ä¸€çº§ç¼“å­˜æ•°æ®ç¼“å­˜åœ¨äºŒçº§ç¼“å­˜é‡Œï¼ŒäºŒçº§ç¼“å­˜çš„æ•°æ®å¿…é¡»å®ç°åºåˆ—åŒ–æ¥å£
#### æ¸…é™¤
åœ¨æŸä¸€ä¸ªä½œç”¨åŸŸï¼ˆsessionä½œç”¨åŸŸæˆ–è€…mapperä½œç”¨åŸŸï¼‰çš„æ•°æ®å‘ç”Ÿå¢åˆ æ”¹ï¼Œä¹‹åä¼šå°†å¯¹åº”ä½œç”¨åŸŸçš„ç¼“å­˜æ•°æ®æ¸…é™¤
# å¾®æœåŠ¡

**äº”å¤§ç»„ä»¶ï¼šæ³¨å†Œä¸­å¿ƒï¼Œè´Ÿè½½å‡è¡¡ï¼Œè¿œç¨‹è°ƒç”¨ï¼ŒæœåŠ¡ç†”æ–­ï¼Œç½‘å…³**
## ä¸€. æ³¨å†Œä¸­å¿ƒ
### 1. Nacos
##### æœåŠ¡æ³¨å†Œè¡¨ç»“æ„
å¾®æœåŠ¡å°†è‡ªå·±æ³¨å†Œåˆ°Nacosåï¼Œä¼šå°†è‡ªå·±çš„ä¿¡æ¯ä¿å­˜åˆ°æ³¨å†Œè¡¨ä¸­ï¼Œé€šè¿‡å¤šçº§çš„mapç»“æ„å®ç°
```yaml
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Nacos æ³¨å†Œè¡¨                         â”‚
â”‚      registry: Map<namespaceId, Map<group@@service, Service>> â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Namespace: publicï¼ˆæˆ–è‡ªå®šä¹‰ï¼‰ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Service: DEFAULT_GROUP@@user-service â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ClusterMap:                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ Cluster: DEFAULT   å¯ä»¥é…ç½®å¤š   â”‚   â”‚
â”‚   â”‚  â”œâ”€ metadata: {...}            â”‚   â”‚
â”‚   â”‚  â”œâ”€ HealthChecker: {...}       â”‚   â”‚
â”‚   â”‚  â””â”€ instances: List<Instance>  â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Instance:                                           â”‚
â”‚  â”œâ”€ ip: 192.168.1.100                               â”‚
â”‚  â”œâ”€ port: 8080                                      â”‚
â”‚  â”œâ”€ healthy: true                                   â”‚
â”‚  â”œâ”€ ephemeral: true                                 â”‚
â”‚  â”œâ”€ metadata: {version=1.0, env=prod}               â”‚
â”‚  â””â”€ weight: 1.0                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```
- namespaceï¼šç¯å¢ƒéš”ç¦»ï¼ˆtestã€proï¼Œdevï¼‰ï¼ŒåŒ…å«å¤šä¸ªserviceï¼Œä¸åŒnamespaceçš„æœåŠ¡å®ä¾‹ä¸èƒ½äº’ç›¸å‘ç°
- serviceï¼šä¸€ä¸ªå¾®æœåŠ¡åœ¨ä¸€ä¸ªnamespaceä¸‹çš„æŠ½è±¡è¡¨ç¤ºï¼Œserviceä¸­å¤šä¸ªæœåŠ¡å®ä¾‹æŒ‚åœ¨å®ƒçš„é›†ç¾¤Clusterä¸­
- Clusterï¼šæ¯ä¸ªserviceé»˜è®¤åªæœ‰ä¸€ä¸ªï¼Œå¯ä»¥æ‰‹åŠ¨æ‰©å±•ä¸ºå¤šä¸ªï¼Œæ¯ä¸ªClusteræ‰¿è½½å¯¹åº”é›†ç¾¤çš„å®ä¾‹
- Instanceï¼šæœåŠ¡å®ä¾‹ï¼Œæ¯ä¸ªèŠ‚ç‚¹ï¼ˆip+ç«¯å£ï¼‰å¯¹åº”ä¸€ä¸ªå®ä¾‹ï¼Œå¯ä»¥å°†å…¶åˆ†é…åœ¨åŒä¸€serviceä¸‹çš„ä¸åŒClusterä¸­
#### æ”¯æ’‘å¤§é‡æ³¨å†Œå‹åŠ›
```txt
[å®¢æˆ·ç«¯å‘èµ·æ³¨å†Œè¯·æ±‚]
           â”‚
           â–¼
[æœåŠ¡ç«¯æ¥æ”¶ï¼ˆå¦‚ ServerAï¼‰]
  â”œâ”€ è§£æå‚æ•°ï¼Œæ„å»º Instance
  â”œâ”€ æœ¬åœ°æ³¨å†Œè¡¨å†…å­˜ä¸­æ·»åŠ  Instance
  â”‚    â””â”€â”€ registry.put(serviceKey, instance)
  â””â”€ åˆ›å»ºä¸€ä¸ªã€åŒæ­¥ä»»åŠ¡ SyncTaskã€‘

           â–¼
[å°† SyncTask æ”¾å…¥ä»»åŠ¡é˜»å¡é˜Ÿåˆ—ä¸­]
           â”‚
           â–¼
ã€çº¿ç¨‹æ± ï¼ˆå¦‚ DistroTaskEngineï¼‰**å¼‚æ­¥å•çº¿ç¨‹**æ¶ˆè´¹ä»»åŠ¡ã€‘
  â”œâ”€ ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡
  â”œâ”€ åˆ¤æ–­ä»»åŠ¡ç±»å‹ï¼ˆDistro / Raftï¼‰
  |- æ›´æ–°æœ¬åœ°æ³¨å†Œè¡¨
  â””â”€ æ‰§è¡Œé›†ç¾¤æ³¨å†Œè¡¨åŒæ­¥é€»è¾‘ï¼š
        â”œâ”€ æ„é€ åŒæ­¥æ•°æ®åŒ…
        â”œâ”€ HTTP/gRPC æ¨é€ç»™å…¶ä»–èŠ‚ç‚¹
        â””â”€ å…¶ä»–èŠ‚ç‚¹æ›´æ–°è‡ªèº«å†…å­˜æ³¨å†Œè¡¨

           â–¼
[åŒæ—¶ï¼šå°†ä»»åŠ¡æ”¾å…¥é˜»å¡é˜Ÿåˆ—åä¸»çº¿ç¨‹ç«‹å³å“åº”å®¢æˆ·ç«¯æ³¨å†ŒæˆåŠŸ âœ…]
```
ä¸ºäº†åº”å¯¹æ³¨å†Œå‹åŠ›ï¼Œè®¾ç½®nacosé›†ç¾¤ï¼ŒæŸä¸ªèŠ‚ç‚¹çš„serviceå®ä¾‹è¿›è¡Œæ³¨å†Œåï¼Œä¸ä¼šç«‹å³æ›´æ–°ï¼Œä¼šå…ˆå°†æœ¬åœ°çš„æ—§çš„serviceå®ä¾‹å’Œæ–°æ³¨å†Œçš„å®ä¾‹è¿›è¡Œåˆå¹¶ï¼Œæ”¾å…¥ç¼“å­˜ä¸­ï¼Œä¹‹åç›´æ¥å“åº”å®¢æˆ·ç«¯ï¼Œå®é™…ä¸Šæ”¾å…¥ç¼“å­˜ä¹‹åä¼šå¼€å¯å¼‚æ­¥ä»»åŠ¡ï¼Œå°†æ›´æ–°ä»»åŠ¡æ”¾å…¥é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œåˆ©ç”¨çº¿ç¨‹æ± è¯»å–ä»»åŠ¡ï¼Œå¼‚æ­¥å•çº¿ç¨‹æ›´æ–°æœ¬åœ°å’Œå…¶ä»–nacosèŠ‚ç‚¹çš„æ³¨å†Œè¡¨
#### å¹¶å‘è¯»å†™å¤„ç†
copyOnwrite
```txt
[å®¢æˆ·ç«¯æ³¨å†Œ / æ³¨é”€ / ä¿®æ”¹å®ä¾‹]
           â”‚
           â–¼
[ServiceManager æ¥å£å±‚]
  â”œâ”€ æ£€æŸ¥æ˜¯å¦å­˜åœ¨å¯¹åº” Service / Cluster
  â”œâ”€ **ä½¿ç”¨åŒæ­¥é”ä¿æŠ¤å…³é”®æ³¨å†Œæµç¨‹**
  â”‚     â””â”€â”€ synchronized (Service.class) æˆ– ReentrantLock
  â””â”€ ä¿®æ”¹æ³¨å†Œè¡¨ï¼šæ·»åŠ /åˆ é™¤/æ›´æ–° Instance
           â”‚
           â–¼
	    åŠ å…¥é˜»å¡é˜Ÿåˆ—ä¸­
		   â”‚
           â–¼
[ä»»åŠ¡çº¿ç¨‹è·å–ä¸€ä¸ªåŒæ­¥ä»»åŠ¡ï¼Œè¿›è¡Œå•çº¿ç¨‹å¼‚æ­¥å¤„ç† SyncTask]
           â”‚
           â–¼
ã€é˜¶æ®µ1ï¼šè¯»å–æœ¬åœ°æ³¨å†Œè¡¨ã€‘
  â””â”€ å–å‡ºå½“å‰ Service / Cluster çš„ instances åˆ—è¡¨ï¼ˆæ—§è§†å›¾ï¼‰

           â”‚
           â–¼
ã€é˜¶æ®µ2ï¼šå¤åˆ¶æ—§åˆ—è¡¨ + åˆå¹¶æ–°æ•°æ®ã€‘
  â”œâ”€ å°†æ—§åˆ—è¡¨ deep copy ä¸€ä»½ï¼ˆä¸ºäº†å¹¶å‘è¯»å†™éš”ç¦»ï¼‰
  â”œâ”€ æŠŠæ–°åŒæ­¥æ¥çš„ instances ä¸æœ¬åœ°è¿›è¡Œåˆå¹¶ï¼š
  â”‚     â”œâ”€ æ‰¾å‡ºéœ€è¦åˆ é™¤çš„ï¼ˆæ—§æœ‰ä½†æ–°æ•°æ®ä¸­ä¸å­˜åœ¨ï¼‰
  â”‚     â”œâ”€ æ‰¾å‡ºéœ€è¦æ›´æ–°çš„ï¼ˆIPç›¸åŒï¼ŒçŠ¶æ€/metadataä¸åŒï¼‰
  â”‚     â””â”€ æ‰¾å‡ºéœ€è¦æ–°å¢çš„ï¼ˆæ–°æ•°æ®ä¸­æœ‰ä½†æœ¬åœ°æ²¡æœ‰ï¼‰
  â””â”€ æ„é€ ä¸€ä¸ªâ€œæ–°ç‰ˆæœ¬çš„ instances åˆ—è¡¨â€

           â”‚
           â–¼
ã€é˜¶æ®µ3ï¼šå°† Cluster å®ä¾‹åˆ—è¡¨æ›¿æ¢ä¸ºæ–°åˆ—è¡¨ã€‘
  â””â”€ `cluster.setInstances(newInstanceList);`
           â”‚
           â–¼
ã€æ­¤æ“ä½œä¸ºåŸå­æ€§å†™å…¥ï¼Œæ›¿æ¢æ‰æ—§è§†å›¾ã€‘
  â†’ å†…å­˜ä¸­æ³¨å†Œè¡¨æ­£å¼æ›´æ–°
  â†’ å¯¹å¤–æš´éœ²è¯»æ¥å£æ—¶ï¼Œè¯»åˆ°çš„å°±æ˜¯åˆå¹¶ä¹‹åçš„æ•°æ®
```
æ¥å–ä»»åŠ¡åå…ˆå°†æœ¬åœ°çš„ã€å…¶ä»–nacosèŠ‚ç‚¹åŒæ­¥è¿‡æ¥çš„å®ä¾‹ä¿¡æ¯è¿›è¡Œcopyå¹¶åˆå¹¶æˆä¸€ä¸ªæ–°çš„å‰¯æœ¬ï¼Œå¯¹å…¶ä¸­ç›¸è¾ƒäºåŸæ¥å‡å°‘çš„è¿›è¡Œåˆ é™¤ã€çŠ¶æ€æ”¹å˜çš„ä¿®æ­£çŠ¶æ€ã€ä¸å˜çš„ä¿æŒä¸å˜ã€æ–°å¢çš„è¿›è¡Œæ·»åŠ ã€‚åœ¨æ­¤æœŸé—´ï¼Œå®¢æˆ·ç«¯è¿›è¡Œè¯»ï¼Œè¯»åˆ°çš„æ˜¯æ—§çš„æ³¨å†Œè¡¨ï¼Œåœ¨å®Œæˆå‰¯æœ¬çš„å¤„ç†åç›´æ¥å°†æ—§çš„cluster/serviceè¿›è¡Œæ›¿æ¢ï¼Œæ³¨æ„åˆ°å¼‚æ­¥ä»»åŠ¡æ˜¯å•çº¿ç¨‹å¤„ç†çš„ï¼Œé¿å…å¹¶å‘æ‰§è¡Œå‡ºç°è„æ•°æ®
æ­¤æ–¹æ³•åœ¨æ²¡æœ‰åŠ å¤§ç²’åº¦é”çš„æƒ…å†µä¸‹ï¼Œè§£å†³äº†è¯»å†™å†²çªé—®é¢˜ï¼Œä¹Ÿæ²¡æœ‰å½±å“æ€§èƒ½
#### Nacoså’ŒEurekaçš„åŒºåˆ«
##### å®ä¾‹ç±»å‹
nacosæœ‰ä¸´æ—¶å®ä¾‹å’Œæ°¸ä¹…å®ä¾‹ï¼Œeurekaåªæœ‰ä¸´æ—¶å®ä¾‹
##### å¥åº·æ£€æµ‹
nacosä¼šå°†ä¸´æ—¶å®ä¾‹å’Œæ°¸ä¹…å®ä¾‹æ³¨å†Œåˆ°ä¸¤ä¸ªä¸åŒçš„åˆ—è¡¨ä¸­
ä¸´æ—¶å®ä¾‹å®¢æˆ·ç«¯ä¼šæœ‰ä¸€ä¸ªå‘nacoså‘é€å¿ƒè·³çš„ä»»åŠ¡ï¼Œnacosåˆ¤æ–­å½“å‰å‘é€å¿ƒè·³çš„æ—¶é—´æˆ³å’Œä¸Šä¸€æ¬¡å‘é€å¿ƒè·³çš„æ—¶é—´æˆ³é—´éš”ï¼Œå¦‚æœè¶…è¿‡äº†æ­£å¸¸å®ä¾‹å‘é€å¿ƒè·³ä»»åŠ¡è§„å®šçš„æ—¶é—´ï¼ˆæ­£å¸¸å¿ƒè·³å‘¨æœŸï¼‰ï¼Œå°±ä¼šå°†å…¶æ ‡è®°ä¸ºä¸å¥åº·å®ä¾‹ï¼Œæ­¤å¤–nacosä¹Ÿæœ‰ä¸€ä¸ªå®šæ—¶çš„è½®è¯¢ä»»åŠ¡ï¼Œéå†ä¸´æ—¶åˆ—è¡¨çš„å®ä¾‹ï¼Œåˆ¤æ–­å½“å‰æ—¶é—´æˆ³å’Œæœ€è¿‘ä¸€æ¬¡å‘é€å¿ƒè·³çš„æ—¶é—´æˆ³ä¹‹é—´çš„é—´éš”ï¼Œå¦‚æœè¶…è¿‡äº†å…è®¸å‘é€å¿ƒè·³çš„æœ€å¤§æ—¶é—´ï¼ˆæœ€å¤§å¿ƒè·³è¶…è¿‡æ—¶é—´ï¼‰ï¼Œå°±ä¼šå°†å…¶æ ‡è®°ä¸ºå¼‚å¸¸ï¼Œå¯¹äºå¼‚å¸¸çš„ä¸´æ—¶å®ä¾‹ï¼Œnacosä¼šç›´æ¥å‰”é™¤
å¯¹äºæ°¸ä¹…å®ä¾‹ï¼Œnacosä¸­çš„ä¸€ä¸ªçº¿ç¨‹æ± ä¼šè½®è¯¢æ°¸ä¹…å®ä¾‹åˆ—è¡¨å¹¶ä¸»åŠ¨å‘èµ·è¯·æ±‚è¯¢é—®å®ä¾‹æ˜¯å¦å­˜æ´»ï¼Œå¦‚æœåœ¨è§„å®šæ—¶é—´è¿”å›å“åº”è¯´æ˜å°±æ˜¯å¥åº·çš„ï¼Œå¦‚æœè¶…è¿‡äº†è§„å®šæ—¶é—´å°±ä¼šè¢«æ ‡è®°ä¼šä¸å¥åº·ï¼Œå¦‚æœæ²¡æœ‰å“åº”ä¼šæ ‡è®°ä¸ºå¼‚å¸¸ï¼Œå¯¹äºå¼‚å¸¸çš„æ°¸ä¹…å®ä¾‹ï¼Œnacosä¸ä¼šç›´æ¥å‰”é™¤

eurekaåªæ”¯æŒå®ä¾‹çš„å¿ƒè·³æœºåˆ¶
##### æœåŠ¡æ‹‰å–
nacosæ”¯æŒå®šæ—¶æ‹‰å–å’Œè®¢é˜…æ¨é€ä¸¤ç§æ¨¡å¼
å®šæ—¶æ‹‰å–æ˜¯æŒ‡ï¼Œå®¢æˆ·ç«¯å®šæ—¶å‘æœåŠ¡ç«¯å‘é€è¯·æ±‚è·å–æœ€æ–°çš„æœåŠ¡ä¿¡æ¯ï¼Œè®¢é˜…æ¨é€æ˜¯åœ¨æœåŠ¡ä¿¡æ¯å‘ç”Ÿå˜æ›´æ—¶nacosä¼šç”¨udpå¥—æ¥å­—å’Œå®¢æˆ·ç«¯å»ºç«‹è¿æ¥ï¼Œå°†å˜æ›´çš„ä¿¡æ¯å¹¿æ’­ç»™æ‰€æœ‰è®¢é˜…çš„å¾®æœåŠ¡ï¼Œå¾®æœåŠ¡ä¼šå°†å˜æ›´çš„æœåŠ¡ä¿¡æ¯ç¼“å­˜åˆ°æœ¬åœ°æœåŠ¡åˆ—è¡¨ï¼Œä¸‹ä¸€æ¬¡å°±ä¼šä¼˜å…ˆä»ç¼“å­˜è¯»å–ï¼Œç¼“å­˜æ²¡æœ‰ï¼Œå†å»nacosæ‹‰å–

eurekaåªä¼šè¿›è¡Œå®šæ—¶æ‹‰å–
## äºŒ. è´Ÿè½½å‡è¡¡
åœ¨å®¢æˆ·ç«¯æ‹‰å–åˆ°è¦è°ƒç”¨çš„æœåŠ¡åˆ—è¡¨ä¿¡æ¯åï¼Œä¼šä½¿ç”¨è´Ÿè½½å‡è¡¡ç»„ä»¶é€‰æ‹©ä¸€ä¸ªæœåŠ¡è°ƒç”¨
æ³¨æ„åœ¨ç‰ˆæœ¬çš„spring bootå·²ç»å¼ƒç”¨äº†ribbonï¼Œå»ºè®®ä½¿ç”¨loadbalance
### 1. Ribbon
#### è´Ÿè½½å‡è¡¡ç­–ç•¥
- ç®€å•è½®è¯¢ï¼Œå¯¹æ‹‰å–åˆ°çš„æœåŠ¡æŒ¨ä¸ªè¿›è¡Œè°ƒç”¨
- æŒ‰æƒé‡é€‰æ‹©ï¼Œå“åº”æ—¶é—´è¶Šé•¿çš„ï¼Œæƒé‡è¶Šä½
- éšæœºè°ƒç”¨
- ä»¥åŒºåŸŸå¯ç”¨çš„æœåŠ¡å™¨ä¸ºåŸºç¡€è¿›è¡Œé€‰æ‹©ï¼Œä½¿ç”¨Zoneå¯¹æœåŠ¡å™¨è¿›è¡Œåˆ†åŒºï¼ŒZoneå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæœºæˆ¿ã€ä¸€ä¸ªæœºæ¶ï¼Œç„¶åå¯¹Zoneå†…å¤šä¸ªæœåŠ¡è¿›è¡Œè½®è¯¢è°ƒç”¨ï¼ˆé»˜è®¤ï¼‰
- å¿½ç•¥çŸ­è·¯çš„æœåŠ¡ï¼Œé€‰æ‹©å¹¶å‘æ•°è¾ƒä½çš„æœåŠ¡
- é’ˆå¯¹ä¸€ä¸ªæœåŠ¡è¿›è¡Œé‡è¯•æœºåˆ¶ï¼Œç›´åˆ°è°ƒç”¨æˆåŠŸ
- å¯ç”¨æ€§æ•æ„Ÿç­–ç•¥ï¼Œå…ˆè¿‡æ»¤éå¥åº·çš„ï¼Œé€‰æ‹©è¿æ¥æ•°è¾ƒå°çš„
#### è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥
##### Beané…ç½®
```java
@Configuration
public class RibbonClientConfig {

    @Bean
    public IRule ribbonRule() {
        return new CustomWeightRule();  // è‡ªå®šä¹‰ç­–ç•¥
    }
}
```
##### é…ç½®æ–‡ä»¶é…ç½®
```yml
my-service: # ä½ æƒ³é…ç½®çš„æœåŠ¡åï¼Œå¿…é¡»å’Œ @LoadBalanced ä¸­ä½¿ç”¨çš„åç§°ä¸€è‡´
  ribbon:
    NFLoadBalancerRuleClassName: com.example.ribbon.rule.CustomWeightRule
```
### 2. LoadBalancer
#### è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥
##### beané…ç½®
```java
public class RandomLoadBalancer implements ReactorServiceInstanceLoadBalancer {

    private final String serviceId;
    private final ServiceInstanceListSupplier supplier;
    private final Random random = new Random();

    public RandomLoadBalancer(ServiceInstanceListSupplier supplier, String serviceId) {
        this.serviceId = serviceId;
        this.supplier = supplier;
    }

    @Override
    public Mono<Response<ServiceInstance>> choose(Request request) {
        return this.supplier.get().map(instances -> {
            if (instances.isEmpty()) return new EmptyResponse();
            int index = random.nextInt(instances.size());
            return new DefaultResponse(instances.get(index));
        });
    }
}
```
```java
@Configuration
public class LoadBalancerConfig {

    @Bean
    public ReactorServiceInstanceLoadBalancer randomLoadBalancer(
            ObjectProvider<ServiceInstanceListSupplier> supplier) {
        // æ³¨æ„è¿™é‡Œçš„ serviceId å¿…é¡»ä¸ä½ è®¿é—®çš„æœåŠ¡åä¸€è‡´
        return new RandomLoadBalancer(supplier.getIfAvailable(), "my-service");
    }
}
```
##### é…ç½®æ–‡ä»¶é…ç½®
```yaml
spring:
  cloud:
    loadbalancer:
      ribbon:
        enabled: false  # ç¡®ä¿ç¦ç”¨ Ribbon
    loadbalancer:
      retry:
        enabled: true
    loadbalancer:
      hint: # è‹¥ä½¿ç”¨ç°åº¦/æ ‡ç­¾ï¼Œå¯æ‰©å±•
        my-service: version=beta
```
### 3. æ³¨æ„ç‚¹
#### feignè°ƒç”¨
feignè°ƒç”¨å®é™…ä¸Šæ˜¯newå‡ºä¸€ä¸ªå®¢æˆ·ç«¯å‘è¿œç¨‹æœåŠ¡å‘èµ·è¯·æ±‚ï¼Œä½†æ˜¯newå‡ºæ¥çš„requestTemplateï¼ˆè¯·æ±‚æ¨¡æ¿ï¼‰å¯¹è±¡æ˜¯åªæœ‰å‚æ•°æ²¡æœ‰è¯·æ±‚ä¸Šä¸‹æ–‡çš„è¯·æ±‚å¤´çš„ï¼Œæ‰€ä»¥ä¸šåŠ¡ä¸­ä¼šå‡ºç°è¯·æ±‚å¤´ä¸¢å¤±æ— æ³•é€šè¿‡è¿œç¨‹æœåŠ¡æ‹¦æˆªå™¨çš„æƒ…å†µ
```java
@Component  
public class FeignRequestInterceptor implements RequestInterceptor {  
    @Override  
    public void apply(RequestTemplate requestTemplate) {  
  
        // ä»å½“å‰è¯·æ±‚ä¸Šä¸‹æ–‡è·å–è¯·æ±‚å¤´  
        ServletRequestAttributes attributes =  
                (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();  
  
        //è·å–æµè§ˆå™¨å‘æœåŠ¡å™¨å‘é€çš„è¯·æ±‚ï¼Œå¹¶è·å–è¯·æ±‚å¤´ä¿¡æ¯  
        if (attributes != null) {  
            HttpServletRequest request = attributes.getRequest();  
            requestTemplate.header("Cookie",request.getHeader("Cookie"));  
        }  
  
        //é…ç½®seataåˆ†å¸ƒå¼äº‹åŠ¡çš„xidï¼Œç”¨äºåˆ†å¸ƒå¼äº‹åŠ¡çš„ä¼ é€’ï¼Œå…¨å±€äº‹åŠ¡çš„åˆ†æ”¯äº‹åŠ¡éœ€è¦xidæ‰èƒ½æ³¨å†Œåˆ°TC  
        String xid = RootContext.getXID();  
        requestTemplate.header(RootContext.KEY_XID, xid);  
    }  

```
åœ¨feignçš„ä»£ç†å¯¹è±¡å‘é€requestè¯·æ±‚ä¹‹å‰ä¼šè¿‡æ»¤ä¸€éRequestInterceptorçš„applyæ–¹æ³•ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡å®ç°RequestInterceptoræ¥å£çš„applyæ–¹æ³•ï¼Œä»ä¸Šä¸‹æ–‡ä¸­è·å–è¯·æ±‚å¤´è®¾ç½®è¿›requestTemplateå¯¹è±¡ä¸­
## ä¸‰. æœåŠ¡é™çº§/ç†”æ–­
### 1. Hystrix
#### æœåŠ¡é›ªå´©
ä¸€ä¸ªæœåŠ¡çš„å¼‚å¸¸å¯¼è‡´æ•´ä¸ªæœåŠ¡é“¾è·¯çš„è°ƒç”¨å¤±è´¥
#### æœåŠ¡é™çº§
æœåŠ¡è‡ªæˆ‘ä¿æŠ¤æˆ–ä¿æŠ¤ä¸‹æ¸¸æœåŠ¡çš„é€»è¾‘ï¼Œä¸€èˆ¬ç”¨äºä¸‹æ¸¸æœåŠ¡å“åº”æ…¢ã€ä¸å¯ç”¨ã€é”™è¯¯é¢‘å‘ç­‰æƒ…å†µï¼Œé€šè¿‡é™çº§ç­–ç•¥é¿å…ç³»ç»Ÿè°ƒç”¨é“¾è·¯é›ªå´©
é’ˆå¯¹çš„æ˜¯æŸä¸ªæœåŠ¡çš„æ¥å£
```java
@FeignClient(
    name = "user-service",              // æœåŠ¡å
    fallback = UserClientFallback.class // é™çº§å¤„ç†ç±»
)
public interface UserClient {

    @GetMapping("/user/info")
    String getUserInfo();
}
```
```java
@Component
public class UserClientFallback implements UserClient {

    @Override
    public String getUserInfo() {
        return "ã€æœåŠ¡é™çº§ã€‘ç”¨æˆ·æœåŠ¡ä¸å¯ç”¨ï¼Œç¨åé‡è¯•";
    }
}
```
```yml
feign:
  hystrix:
    enabled: true # å¼€å¯ Feign çš„ Hystrix é™çº§æ”¯æŒ

hystrix:
  command:
    default:
      execution:
        isolation:
          thread:
            timeoutInMilliseconds: 3000
```
#### ç†”æ–­
é˜²æ­¢æŸä¸ªæœåŠ¡é¢‘ç¹è°ƒç”¨å¤±è´¥å¯¼è‡´ç³»ç»Ÿè°ƒç”¨é›ªå´©
é’ˆå¯¹çš„æ˜¯æ•´ä¸ªæœåŠ¡
```java
@SpringBootApplication
@EnableFeignClients
@EnableCircuitBreaker // å¼€å¯ Hystrix ç†”æ–­ï¼ˆSpring Cloud Netflixï¼‰
public class Application {
    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }
}
```
é»˜è®¤å…³é—­éœ€è¦æ‰‹åŠ¨æ‰“å¼€ï¼Œå¦‚æœæ£€æµ‹åˆ°10ç§’å†…è¯·æ±‚å¤±è´¥è¶…è¿‡50%ï¼Œå°±ä¼šè§¦å‘ç†”æ–­æœºåˆ¶ï¼Œä¼šç«‹å³çŸ­è·¯è°ƒç”¨ï¼Œä¸å†æ‰§è¡ŒåŸè°ƒç”¨æ–¹æ³•ï¼Œè€Œæ˜¯æ‰§è¡Œé™çº§é€»è¾‘ï¼Œæ¯éš”5ç§’ä¼šå°è¯•æ”¾è¡Œä¸€ä¸ªè¯·æ±‚ï¼Œå¦‚æœæœåŠ¡ä»ç„¶ä¸èƒ½å“åº”ï¼Œåˆ™ç»§ç»­ç†”æ–­ï¼Œå¦åˆ™å…³é—­ç†”æ–­ï¼Œæ¢å¤æ­£å¸¸è¯·æ±‚
## å››. æœåŠ¡é™æµ
### 1. nginxæ¼æ¡¶ç®—æ³•é™æµ
æ¡¶ä¸­å­˜å‚¨çš„æ˜¯è¯·æ±‚ï¼Œä¸ç®¡è¯·æ±‚è¿›å…¥çš„æµé‡æ˜¯å¤šå°‘ï¼Œå§‹ç»ˆæŒ‰ç…§ä¸€å®šçš„é€Ÿç‡è¿›è¡Œå¤„ç†ï¼Œå¦‚æ¯ç§’å¤„ç†5ä¸ªï¼Œæœªè¢«å¤„ç†åˆ°çš„è¯·æ±‚ä¼šåœ¨æ¡¶é‡Œç­‰å¾…ï¼Œè¶…è¿‡å®¹é‡çš„è¯·æ±‚ä¼šè¢«èˆå¼ƒæˆ–ç­‰å¾…ï¼Œå¤„ç†é€Ÿåº¦å¹³æ»‘
```nginx
# nginx.config
http {
    # 1. å®šä¹‰ä¸€ä¸ªåä¸º one çš„é™é€ŸåŒºåŸŸï¼Œè¿™ç§é™æµé…ç½®å¿…é¡»åœ¨æ€»é…ç½®æ–‡ä»¶é…ç½®
    limit_req_zone $binary_remote_addr zone=one:10m rate=5r/s;
    # åŒ…å«æ‰€æœ‰å­é…ç½®
    include /etc/nginx/conf.d/*.conf;
}
```
```nginx
# gulimall.conf
	# éšåä¾¿å¯ä»¥åœ¨gulimall.confè¿™ç§é’ˆå¯¹äºæœåŠ¡çš„åå‘ä»£ç†æ–‡ä»¶é‡Œçš„serveré‡Œä½¿ç”¨oneè¿™ä¸ªé™æµé…ç½®
	# ä»¥ä¸‹æ˜¯ä½¿ç”¨å®ä¾‹
    server {
        listen 80;
        server_name gulimall.com;

		# è·¯ç”±åŒ¹é…
        location /api/ {
            # 2. åº”ç”¨é™é€Ÿè§„åˆ™
            limit_req zone=one burst=10 nodelay;
            proxy_set_header Host $host;
			# åå‘ä»£ç†çš„æœåŠ¡å™¨ip
            proxy_pass http://gulimall.com;
        }
    }
```
- binary_remote_addrï¼šåŸºäºå®¢æˆ·ç«¯çš„IPé™æµ
- Zoneå®šä¹‰ä¸€ä¸ªå…±äº«å­˜å‚¨åŒºå­˜å‚¨è®¿é—®ä¿¡æ¯
- rateï¼šæœ€å¤§è®¿é—®é€Ÿç‡ï¼Œæ¯ç§’åªå¤„ç†5ä¸ªè¯·æ±‚
- burstï¼šæ¡¶çš„å¤§å°ï¼Œè¶…è¿‡å®¹é‡ä¹‹åï¼Œå¤šä½™çš„è¯·æ±‚ä¼šç­‰å¾…æˆ–ç›´æ¥æ‹’ç»
### 2. ç½‘å…³ä»¤ç‰Œæ¡¶é™æµ
æ¡¶ä¸­å­˜å‚¨çš„æ˜¯ä»¤ç‰Œï¼Œä»¥ä¸€å®šé€Ÿç‡ç”Ÿæˆä»¤ç‰Œï¼Œè¯·æ±‚è¿›å…¥æ—¶å…ˆç”³è¯·è·å–ä»¤ç‰Œæ‰èƒ½è¢«å¤„ç†ï¼Œé€Ÿåº¦è¾ƒä¸ºæ³¢åŠ¨ï¼Œé»˜è®¤ä½¿ç”¨rediså­˜å‚¨ä»¤ç‰Œ
```pom
<!-- Spring Cloud Gateway -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-gateway</artifactId>
</dependency>

<!-- Redis æ”¯æŒ -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis-reactive</artifactId>
</dependency>
```
```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: user-api
          uri: http://localhost:8081 # æˆ–æ³¨å†Œä¸­å¿ƒçš„æœåŠ¡åç§°
          predicates:
            - Path=/api/user/**
          filters:
            - name: RequestRateLimiter
              args:
                key-resolver: '#{@ipKeyResolver}'  # æŒ‰è¯·æ±‚æ¥æºçš„IPé™æµï¼ˆè‡ªå®šä¹‰ Beanï¼‰
                redis-rate-limiter.replenishRate: 5  # æ¯ç§’å¡«å……5ä¸ªä»¤ç‰Œ
                redis-rate-limiter.burstCapacity: 10 # æ¡¶æœ€å¤§å®¹é‡10ä¸ªä»¤ç‰Œ
```
```java
@Configuration
public class RateLimiterConfig {
    @Bean
    public KeyResolver ipKeyResolver() {
        return exchange -> {
            String ip = exchange.getRequest()
                                 .getHeaders()
                                 .getFirst("X-Forwarded-For");
            if (ip == null) {
                ip = exchange.getRequest().getRemoteAddress().getAddress().getHostAddress();
            }
            return Mono.just(ip);
        };
    }
}
```
## äº”. æœåŠ¡å®‰å…¨æ ¡éªŒ
### å®¢æˆ·ç«¯é…ç½®
```pom
å®¢æˆ·ç«¯ä¾èµ–å¯¼å…¥
<!-- Spring Security -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-oauth2-resource-server</artifactId>
</dependency>

<!-- Spring Security OAuth2 Client -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-oauth2-client</artifactId>
</dependency>

<!-- Spring Cloud OpenFeign -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
```
```java
//å®¢æˆ·ç«¯æ³¨å†Œ
@Configuration
public class AuthorizationServerConfig {

    @Bean
    public RegisteredClientRepository registeredClientRepository() {
        RegisteredClient registeredClient = RegisteredClient.withId(UUID.randomUUID().toString())
            .clientId("product-service")                          // å®¢æˆ·ç«¯ID
            .clientSecret("{noop}s3cr3tK3y!")                    // å®¢æˆ·ç«¯å¯†é’¥ï¼Œ{noop}è¡¨ç¤ºä¸ç¼–ç 
            .authorizationGrantType(AuthorizationGrantType.CLIENT_CREDENTIALS) // æˆæƒæ¨¡å¼
            .scope("read")                                        // æˆæƒèŒƒå›´
            .build();

        // è¿™é‡Œä½¿ç”¨å†…å­˜å­˜å‚¨ï¼Œä¹Ÿå¯ä»¥ç”¨æ•°æ®åº“å­˜å‚¨
        return new InMemoryRegisteredClientRepository(registeredClient);
    }
}
```
```yaml
é…ç½®æ–‡ä»¶é…ç½®å®¢æˆ·ç«¯ä¿¡æ¯
spring:
  security:
    oauth2:
      client:
        registration:
          product-service:
            client-id: product-service
            client-secret: s3cr3tK3y!
            authorization-grant-type: client_credentials
            scope: read
            provider: auth-server 
        provider:
          auth-server:
            token-uri: http://localhost:9000/oauth2/token


```
```java
//é…ç½®OAuth2AccessTokenInterceptorï¼Œå‘è¯·æ±‚å¤´ä¸­æ·»åŠ tokençš„è¿‡æ»¤å™¨
@Configuration
public class FeignOAuth2Config {

	@Bean
    public OAuth2AuthorizedClientManager authorizedClientManager(
            ClientRegistrationRepository registrations,
            OAuth2AuthorizedClientRepository clients) {

        OAuth2AuthorizedClientProvider provider =
                OAuth2AuthorizedClientProviderBuilder.builder()
                        .clientCredentials()
                        .build();

        DefaultOAuth2AuthorizedClientManager manager =
                new DefaultOAuth2AuthorizedClientManager(registrations, clients);

        manager.setAuthorizedClientProvider(provider);

        return manager;
    }
}

    @Bean
    public RequestInterceptor oauth2FeignRequestInterceptor(
            OAuth2AuthorizedClientManager authorizedClientManager) {
        return new OAuth2AccessTokenInterceptor(authorizedClientManager);
    }
}
```
### è®¤è¯æœåŠ¡å™¨æ­å»º
```pom
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
</dependency>

<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>

<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-oauth2-resource-server</artifactId>
</dependency>

<dependency>
    <groupId>org.springframework.security</groupId>
    <artifactId>spring-security-oauth2-authorization-server</artifactId>
    <version>1.1.0</version> <!-- è¯·ç¡®è®¤æœ€æ–°ç‰ˆæœ¬ -->
</dependency>

<dependency>
    <groupId>org.springframework.security</groupId>
    <artifactId>spring-security-oauth2-jose</artifactId>
</dependency>
```
```java
//æ‹¦æˆªè§„åˆ™
@Configuration
public class ResourceServerSecurityConfig {

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(authorize -> authorize
                .requestMatchers("/public/**").permitAll() // ä¸æ‹¦æˆª
                .anyRequest().authenticated()              // å…¶ä»–éƒ½éœ€è¦å¸¦ token
            )
            .oauth2ResourceServer(oauth2 -> oauth2.jwt()); // æŒ‡å®šç”¨ JWT æ–¹å¼è®¤è¯

        return http.build();
    }
}
```
```java
@Configuration
public class AuthorizationServerConfig {

    @Bean
    public RegisteredClientRepository registeredClientRepository() {
        RegisteredClient registeredClient = RegisteredClient.withId(UUID.randomUUID().toString())
                .clientId("product-service")
                .clientSecret("{noop}s3cr3tK3y!")
                .authorizationGrantType(AuthorizationGrantType.CLIENT_CREDENTIALS)
                .scope("read")
                .tokenSettings(TokenSettings.builder()
                    .accessTokenTimeToLive(Duration.ofHours(1))
                    .build())
                .build();

        return new InMemoryRegisteredClientRepository(registeredClient);
    }

    @Bean
    public SecurityFilterChain authorizationServerSecurityFilterChain(HttpSecurity http) throws Exception {
        OAuth2AuthorizationServerConfiguration.applyDefaultSecurity(http);
        return http.formLogin().and().build();
    }

    // ç”ŸæˆRSAå¯†é’¥å¯¹ï¼ˆç”¨äºç­¾å‘JWTï¼‰
    @Bean
    public KeyPair keyPair() {
        try {
            KeyPairGenerator generator = KeyPairGenerator.getInstance("RSA");
            generator.initialize(2048);
            return generator.generateKeyPair();
        } catch (Exception e) {
            throw new IllegalStateException(e);
        }
    }

    // JWT ç¼–ç å™¨
	@Bean
	public JWKSource<SecurityContext> jwkSource(KeyPair keyPair) {
	    RSAKey rsaKey = new RSAKey.Builder((RSAPublicKey) keyPair.getPublic())
	            .privateKey(keyPair.getPrivate())
	            .keyID(UUID.randomUUID().toString())
	            .build();
	    JWKSet jwkSet = new JWKSet(rsaKey);
	    return (jwkSelector, securityContext) -> jwkSelector.select(jwkSet);
	}

	@Bean
	public JwtEncoder jwtEncoder(JWKSource<SecurityContext> jwkSource) {
	    return new NimbusJwtEncoder(jwkSource);
	}

    // JWT è§£ç å™¨ï¼ˆèµ„æºæœåŠ¡å™¨ç”¨ï¼‰
    @Bean
    public JwtDecoder jwtDecoder(KeyPair keyPair) {
        return NimbusJwtDecoder.withPublicKey((RSAPublicKey) keyPair.getPublic()).build();
    }

    @Bean
    public ProviderSettings providerSettings() {
        return ProviderSettings.builder()
                .issuer("http://localhost:9000")  // ä½ çš„è®¤è¯æœåŠ¡å™¨åœ°å€
                .build();
    }
}
```
```yml
spring:
  security:
    oauth2:
      resourceserver:
        jwt:
          jwk-set-uri: http://localhost:9000/oauth2/jwks
```
## å…­. CAPå’ŒBASE
### CAP
- åˆ†å¸ƒå¼ç³»ç»ŸèŠ‚ç‚¹é€šè¿‡ç½‘ç»œè¿›è¡Œè¿æ¥ï¼Œç”±äºç½‘ç»œé—®é¢˜ä¸€å®šä¼šå‡ºç°åˆ†åŒºé—®é¢˜ï¼ˆPï¼‰
- å½“åˆ†åŒºå‡ºç°ï¼Œç³»ç»Ÿçš„ä¸€è‡´æ€§ï¼ˆCï¼‰å’Œå¯ç”¨æ€§ï¼ˆAï¼‰å°±æ— æ³•åŒæ—¶æ»¡è¶³
### BASE
- åŸºæœ¬å¯ç”¨
- è½¯çŠ¶æ€
- æœ€ç»ˆä¸€è‡´ï¼šå„åˆ†æ”¯äº‹åŠ¡å®Œæˆä¹‹åè¿›è¡Œæäº¤ï¼Œå¦‚æœæœ‰ä¸ä¸€è‡´çš„æƒ…å†µï¼Œå†æƒ³åŠæ³•æ¢å¤æ•°æ®ï¼Œå­˜åœ¨ä¸­é—´çŠ¶æ€ï¼Œå ç”¨èµ„æºå°‘ï¼Œå¯ç”¨æ€§é«˜
- å¼ºä¸€è‡´ï¼šå„åˆ†æ”¯äº‹åŠ¡å®Œæˆåå…ˆä¸è¿›è¡Œæäº¤ï¼Œå½¼æ­¤ç­‰å¾…æ‰§è¡Œç»“æœï¼Œç„¶åç»Ÿä¸€è¿›è¡Œæäº¤æˆ–å›æ»šï¼Œä¸å­˜åœ¨ä¸­é—´çŠ¶æ€ï¼Œå ç”¨èµ„æºå¤šï¼Œä¸€è‡´æ€§å¼ºï¼Œå¯ç”¨æ€§å·®
## ä¸ƒ. åˆ†å¸ƒå¼äº‹åŠ¡
### 1. seate
```txt
+------------------+            +------------------+            +------------------+
|                  |            |                  |            |                  |
|       TM         |  â€”â€”Beginâ†’  |       TC         |  â€”â€”Regâ†’    |       RM         |
| (äº‹åŠ¡å‘èµ·è€…)      |             | (äº‹åŠ¡åè°ƒè€…)     |             |  (èµ„æºæ“ä½œå‘˜)    |
|                  |  â†Resultâ€”â€” |                  |  â†Branchâ€”  |                  |
+------------------+            +------------------+            +------------------+
         |                            â†‘      â†‘                         â†‘
         |                            |      |                         |
         |â€”â€”commit()/rollback()â€”â€”â†’    |      |â€”â€”â†’ prepare/commit/rollback()
```

| ç»„ä»¶                              | æ‰€å±  | ä½œç”¨                          |
| ------------------------------- | --- | --------------------------- |
| **TMï¼ˆTransaction Managerï¼‰**     | å®¢æˆ·ç«¯ | ç®¡ç†å…¨å±€äº‹åŠ¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œå†³å®šäº‹åŠ¡æ€»ä½“çš„å¼€å¯ã€æäº¤ã€å›æ»š |
| **RMï¼ˆResource Managerï¼‰**        | å®¢æˆ·ç«¯ | ç®¡ç†æœ¬åœ°èµ„æºï¼ˆæ•°æ®åº“ã€æ¶ˆæ¯ç­‰ï¼‰ï¼Œå‘ TC æ³¨å†Œåˆ†æ”¯äº‹åŠ¡ |
| **TCï¼ˆTransaction Coordinatorï¼‰** | æœåŠ¡ç«¯ | åè°ƒã€ç›‘æ§å’Œç»´æŠ¤å…¨å±€äº‹åŠ¡çŠ¶æ€ï¼Œè°ƒåº¦åˆ†æ”¯æäº¤/å›æ»š    |
æ‰§è¡Œæµç¨‹

| æ­¥éª¤  | å‚ä¸è€…    | è¡Œä¸º                                     |
| --- | ------ | -------------------------------------- |
| 1   | **TM** | å¼€å¯å…¨å±€äº‹åŠ¡ï¼Œå‘ **TC** æ³¨å†Œï¼Œè·å– `XID`            |
| 2   | **RM** | å„ä¸ªå¾®æœåŠ¡ä¸­è¿œç¨‹è°ƒç”¨æ—¶ï¼Œç”¨ `XID` å‘ TC æ³¨å†Œåˆ†æ”¯äº‹åŠ¡        |
| 3   | **TM** | æ‰€æœ‰è¿œç¨‹æœåŠ¡éƒ½è°ƒç”¨å®Œæ¯•ï¼Œå‘Šè¯‰ **TC** ç»Ÿä¸€æäº¤ or å›æ»š       |
| 4   | **TC** | åè°ƒæ‰€æœ‰ **RM** åš commit æˆ– rollbackï¼ˆä¸¤é˜¶æ®µæäº¤ï¼‰ |
| 5   | **RM** | æ ¹æ® UNDO æ—¥å¿—ç­‰ä¿¡æ¯çœŸæ­£æäº¤æˆ–å›æ»šæ•°æ®åº“äº‹åŠ¡              |
#### XAï¼ˆå¼ºä¸€è‡´æ€§ï¼‰
RMä¸­æ‰§è¡Œå®Œä¸šåŠ¡sqlå…ˆä¸è¿›è¡Œæäº¤ï¼Œç­‰å¾…å„ä¸ªåˆ†æ”¯äº‹åŠ¡å®Œæˆä¹‹åï¼Œå°†æ‰§è¡ŒçŠ¶æ€ç»Ÿä¸€æŠ¥å‘Šç»™TCï¼ŒTCæ£€æŸ¥å„åˆ†æ”¯äº‹åŠ¡çš„æ‰§è¡ŒçŠ¶æ€å…¨éƒ¨æˆåŠŸé€šçŸ¥RMæäº¤äº‹åŠ¡ï¼Œå¦‚æœæœ‰å¤±è´¥åˆ™é€šçŸ¥RMå…¨éƒ¨å›æ»š
#### ATï¼ˆæœ€ç»ˆä¸€è‡´ï¼‰
å„ä¸ªRMæ‰§è¡Œå®Œç›´æ¥æäº¤ï¼Œå¹¶ä¼šè®°å½•æ‰§è¡Œå‰åçš„undo_logæ•°æ®å¿«ç…§ï¼Œä¹‹åå°†æ‰§è¡ŒçŠ¶æ€æŠ¥å‘ŠTCï¼ŒTCæ£€æŸ¥æ‰§è¡ŒçŠ¶æ€ï¼Œå…¨éƒ¨æˆåŠŸåˆ é™¤RMçš„undo_logï¼Œå¦‚æœæœ‰å¤±è´¥åˆ™æ ¹æ®undo_logæ¢å¤æ‰§è¡Œäº‹åŠ¡å‰çš„æ•°æ®ï¼Œæ²¡æœ‰è¿‡å¤šå ç”¨èµ„æº
#### TCC
éœ€è¦æ‰‹åŠ¨åœ¨ä»£ç å±‚é¢å®ç°tryã€confirmã€cancelæ–¹æ³•ï¼Œä»£ç ä¾µå…¥é«˜ï¼Œè€¦åˆåº¦é«˜
1. tryï¼šå…ˆè¿›è¡Œèµ„æºçš„æ£€æµ‹å’Œé¢„ç•™ï¼ŒRMå‘TCæŠ¥å‘Šé¢„ç•™çŠ¶æ€
2. Confirm/Cancelï¼šå¦‚æœå…¨éƒ¨æˆåŠŸï¼Œåˆ™çœŸæ­£æ‰§è¡Œä¸šåŠ¡å¹¶æäº¤ï¼Œå¦‚æœæœ‰å¤±è´¥åˆ™é‡Šæ”¾é”å®šçš„èµ„æº
## å…«. æ¥å£å¹‚ç­‰æ€§
### 1. æ•°æ®åº“æ·»åŠ å”¯ä¸€ç´¢å¼•
### 2. token+redis
```java
String script = "if redis.call('get',KEYS[1]) == ARGV[1] then return redis.call('del',KEYS[1]) else return 0 end";  
Long execute = redisTemplate.execute(new DefaultRedisScript<>(script, Long.class), Arrays.asList(OrderConstant.ORDER_TOKEN_PREFIX + userInfo.getId()),orderToken);
```
åœ¨ç”Ÿæˆè®¢å•é¡µé¢åŒæ—¶ç”Ÿæˆä¸€ä¸ªå”¯ä¸€tokenä¿å­˜åœ¨redisä¸­ï¼Œå¹¶å°†è¿™ä¸ªtokenè¿å¸¦è®¢å•é¡µé¢ä¿¡æ¯ä¸€åŒè¿”å›ç»™å‰ç«¯ï¼Œå½“å‰ç«¯æäº¤è®¢å•æ—¶ä¼šå°†è¿™ä¸ªtokenå¸¦ä¸Šï¼Œä¹‹åä½¿ç”¨luaè„šæœ¬åˆ¤æ–­æ˜¯å¦å­˜åœ¨è¿™ä¸ªtokenå¹¶åˆ é™¤ï¼ˆä¿è¯åŸå­æ€§ï¼Œé˜²æ­¢å¹¶å‘çŠ¶å†µå¯¼è‡´å¤šæ¬¡æäº¤ï¼‰ï¼Œå¦‚æœæˆåŠŸåˆ™æ‰§è¡Œä¸šåŠ¡ï¼Œå¦åˆ™è¯´æ˜å·²ç»å¤„ç†è¿‡äº†ç›´æ¥è¿”å›ï¼Œè§£å†³è®¢å•é˜²åˆ·å’Œç½‘ç»œæ³¢åŠ¨ç­‰é—®é¢˜
### 3. åˆ†å¸ƒå¼é”
## ä¹. xxl-job
### 1. è·¯ç”±è§„åˆ™
- è½®è¯¢
- æ•…éšœè½¬ç§»ï¼šä¾æ¬¡æ£€æµ‹å¿ƒè·³ï¼Œå¦‚æœå¿ƒè·³æ­£å¸¸ï¼Œåˆ™é€‰æ‹©å½“å‰å®ä¾‹æ‰§è¡Œ
- åˆ†ç‰‡å¹¿æ’­ï¼šå¹¿æ’­æ‰€æœ‰å®ä¾‹æ‰§è¡Œä¸€æ¬¡ä»»åŠ¡ï¼ŒæŒ‰ç…§ä»»åŠ¡æ•°å¯¹å®ä¾‹æ•°å–æ¨¡è¿ç®—åˆ†é…ä»»åŠ¡
### 2. ä»»åŠ¡æ‰§è¡Œå¤±è´¥
- è·¯ç”±ç­–ç•¥é€‰æ‹©æ•…éšœè½¬ç§»ï¼Œè®©å¥åº·çš„å®ä¾‹æ‰§è¡Œä»»åŠ¡
- è®¾ç½®ä»»åŠ¡é‡è¯•æ¬¡æ•°
- æŸ¥çœ‹æ—¥å¿—+é‚®ä»¶é€šçŸ¥
### 3. å¤§æ•°æ®é‡ä»»åŠ¡æ‰§è¡Œ
éƒ¨ç½²å¤šä¸ªå®ä¾‹ï¼Œè·¯ç”±é€‰æ‹©åˆ†ç‰‡å¹¿æ’­
# æ¶ˆæ¯ä¸­é—´ä»¶
## ä¸€. RabbitMQ
### 1. æ¶ˆæ¯ä¸ä¸¢å¤±
```txt
  [Producer]
      |
      | å‘é€æ¶ˆæ¯ (publish)
      v
  +-----------+
  |  Broker   |
  | (RabbitMQ)|
  +-----------+
      |
      |  è·¯ç”±æ¶ˆæ¯
      v
  +-----------+
  | Exchange  |<-- äº¤æ¢æœºï¼ˆDirect/Topic/Fanout/Headersï¼‰
  +-----------+
      |
      | æ ¹æ®ç»‘å®šè§„åˆ™ (Binding)
      v
  +-----------+
  |   Queue   |<-- æ¶ˆæ¯é˜Ÿåˆ—
  +-----------+
      |
      | æ¶ˆè´¹æ¶ˆæ¯ (consume)
      v
  [Consumer]
```
æŠ•é€’æ¶ˆæ¯åˆ°æ¶ˆè´¹æ¶ˆæ¯è¿‡ç¨‹ä¸­éƒ½æœ‰å¯èƒ½ä¸¢å¤±æ¶ˆæ¯
```yaml
rabbitmq:  
  host: 192.168.88.101  
  port: 5672  
  virtual-host: /  
  username: guest  
  password: guest  
  publisher-confirm-type: correlated # å‘é€è€…å¯ç”¨confirmæ¨¡å¼  
  publisher-returns: true # å¯ç”¨returnCallback  
  listener:  
    simple:  
      acknowledge-mode: manual # æ‰‹åŠ¨ack  
      auto-startup: true  
      retry:  
        enabled: true # å¼€å¯é‡è¯•æœºåˆ¶  
        max-attempts: 3 # æœ€å¤§é‡è¯•æ¬¡æ•°  å¦‚æœä»ç„¶æ¥æ”¶ä¸åˆ°æ¶ˆæ¯åˆ™æŠ•é€’åˆ°å¼‚å¸¸é˜Ÿåˆ—
  template:  
    mandatory: true # å¼ºåˆ¶æŒ‡å®šæ¶ˆæ¯å‘é€æˆåŠŸ
```
é…ç½®å‘é€è€…confirmæ¶ˆæ¯æŠ•é€’åˆ°brokerï¼ŒreturnCallbackç”±exchangeè·¯ç”±åˆ°queueçš„å›è°ƒå‡½æ•°
```java
@Configuration  
@Slf4j  
public class PublisherCallback {  
  
    @Autowired  
    private RabbitTemplate rabbitTemplate;  
  
    @PostConstruct
    public void init() {  
        rabbitTemplate.setMandatory(true); // â—ç¡®ä¿ returnCallback è¢«è§¦å‘  
  
        //æ¶ˆæ¯æŠ•é€’åˆ°Brokerçš„å›è°ƒå‡½æ•°ï¼ŒconfirmCallback  
        //ackè¡¨ç¤ºæ˜¯å¦æˆåŠŸï¼ŒcauseåŒ…å«å¤±è´¥åŸå›   
        rabbitTemplate.setConfirmCallback((correlationData, ack, cause) -> {  
            if (ack) {  
                log.info("æ¶ˆæ¯å‘é€æˆåŠŸ,correlationData[{}]", correlationData);  
            } else {  
                log.error("æ¶ˆæ¯å‘é€å¤±è´¥,correlationData[{}],cause[{}]", correlationData, cause);  
            }  
        });  
  
        //æ¶ˆæ¯æ²¡æœ‰æˆåŠŸç”±äº¤æ¢æœºè·¯ç”±åˆ°é˜Ÿåˆ—çš„å›è°ƒå‡½æ•°ï¼ŒreturnCallback  
         rabbitTemplate.setReturnsCallback(returnedMessage -> {  
            log.error("æ¶ˆæ¯æ²¡æœ‰è·¯ç”±åˆ°é˜Ÿåˆ—,returnedMessage[{}]", returnedMessage);  
        });  
    }  
}
```
æ¶ˆè´¹è€…æ‰‹åŠ¨ç¡®è®¤æ¶ˆæ¯æ˜¯å¦è¢«æ¶ˆè´¹
```java
//Ackç¡®è®¤æ¶ˆæ¯è¢«æ¶ˆè´¹
channel.basicAck((Long) message.getHeaders().get("amqp_deliveryTag"), false);
//Nackæ¶ˆè´¹å¤±è´¥
channel.basicNack(  
        (Long) message.getHeaders().get("amqp_deliveryTag"),  //æ¶ˆæ¯çš„å”¯ä¸€æ ‡è¯†
        false,  //æ˜¯å¦æ‰¹é‡æ‹’ç»ï¼Œå¦‚æœä¸ºtrueï¼Œåˆ™ä¼šä¸€æ¬¡æ€§æ‹’ç»deliveryTagå°äºç­‰äºä¼ å…¥å€¼çš„æ¶ˆæ¯ï¼›å¦‚æœä¸ºfalseï¼Œåˆ™åªæ‹’ç»ä¼ å…¥å€¼çš„æ¶ˆæ¯ã€‚
        true/false//æ˜¯å¦é‡æ–°å…¥é˜Ÿ
);
```
æŒä¹…åŒ–äº¤æ¢æœºã€é˜Ÿåˆ—å’Œæ¶ˆæ¯,æ¶ˆæ¯é»˜è®¤å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œéœ€è¦åœ¨åˆ›å»ºæ¶ˆæ¯çš„æ—¶å€™å°†å…¶è®¾ç½®ä¸ºæŒä¹…åŒ–
```java
@Configuration  
public class MQConfig {  
  
    public Queue orderSeckillOrderQueue() {  
        return new Queue("order.seckill.order.queue", true, false, false);  
    }  
    @Bean  
    public Exchange orderEventExchange() {  
        return new TopicExchange("order-event-exchange", true, false, null);  
    }  
    @Bean  
    public Binding OrderSeckillOrderBinding() {  
        return new Binding("order.seckill.order.queue", Binding.DestinationType.QUEUE, "order-event-exchange", "order.seckill.order", null);  
    }  
}
```
```java
public static Message generateMessage(RabbitTemplate rabbitTemplate, Object messageBody) {  
    MessageProperties messageProperties = new MessageProperties();  
    //è®¾ç½®æ¶ˆæ¯çš„å±æ€§  
    //è®¾ç½®æ¶ˆæ¯çš„idï¼Œæ­¤idç”¨äºå°†æ¶ˆæ¯ä¿å­˜åˆ°redisä¸­ï¼Œæ£€æŸ¥å¹‚ç­‰æ€§  
    messageProperties.setMessageId(UUID.randomUUID().toString());  
    //è®¾ç½®æ¶ˆæ¯æŒä¹…åŒ–ï¼Œä¿è¯rabbitmqé‡å¯åæ¶ˆæ¯ä¸ä¸¢å¤±  
    messageProperties.setDeliveryMode(MessageDeliveryMode.PERSISTENT);  
    return rabbitTemplate.getMessageConverter().toMessage(messageBody, messageProperties);  
}
```
### 2. æ¶ˆæ¯é‡å¤æ¶ˆè´¹
å‘é€æ¶ˆæ¯æ—¶ï¼Œä¸ºæ¯æ¡æ¶ˆæ¯è®¾ç½®å”¯ä¸€çš„idï¼Œå¹¶å­˜å‚¨åœ¨redisä¸­ï¼Œæ¶ˆè´¹è€…æ ¡éªŒidæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™å·²ç»æ¶ˆè´¹ï¼Œå¦åˆ™æ²¡æœ‰æ¶ˆè´¹æˆ–å…¶ä»–ç›‘å¬è€…æ¶ˆè´¹å¤±è´¥
### 3. å»¶è¿Ÿé˜Ÿåˆ—
ttl+æ­»ä¿¡äº¤æ¢æœºï¼ŒæŠŠæ¶ˆæ¯æŠ•é€’ç»™äº¤æ¢æœºï¼Œç”±è¿™ä¸ªäº¤æ¢æœºæ ¹æ®è·¯ç”±é”®æŠŠæ¶ˆæ¯è·¯ç”±ç»™æ­»ä¿¡é˜Ÿåˆ—ï¼Œä½†æ˜¯è¿™ä¸ªæ­»ä¿¡é˜Ÿåˆ—æ²¡æœ‰ç›‘å¬è€…æ¶ˆè´¹ï¼Œè¶…æ—¶ä¹‹åä¼šå°†æ¶ˆæ¯æŠ•é€’ç»™æ­»ä¿¡äº¤æ¢æœºï¼Œç”±æ­»ä¿¡äº¤æ¢æœºæ ¹æ®æ­»ä¿¡è·¯ç”±é”®æŠŠæ¶ˆæ¯è·¯ç”±ç»™å¦ä¸€ä¸ªå’Œæ­»ä¿¡äº¤æ¢æœºç»‘å®šçš„é˜Ÿåˆ—
```java
@Bean  
public Queue orderDelayQueue() {  
    Map<String, Object> arguments = new HashMap<>();  
    arguments.put("x-dead-letter-exchange", "order-event-exchange");//æ­»ä¿¡äº¤æ¢æœº  
    arguments.put("x-dead-letter-routing-key", "order.release.order");//æ­»ä¿¡è·¯ç”±é”®ï¼Œæ³¨æ„å®ƒçš„æ„æ€æ˜¯æ­»ä¿¡äº¤ç»™æ­»ä¿¡äº¤æ¢æœºå‰æ­»ä¿¡çš„è·¯ç”±é”®å°±ä¼šå˜æˆè¿™ä¸ªï¼Œå®ƒå¿…é¡»æ˜¯å’Œæ­»ä¿¡äº¤æ¢æœºç»‘å®šçš„é˜Ÿåˆ—çš„è·¯ç”±é”®ä¸€æ ·  
    arguments.put("x-message-ttl", 1800000);//æ¶ˆæ¯å­˜æ´»æ—¶é—´ï¼Œå•ä½æ¯«ç§’ï¼Œè¿™é‡Œæ˜¯30åˆ†é’Ÿ  
    return new Queue("order.delay.queue", true, false, false, arguments);  
}
@Bean  
public Queue orderReleaseOrderQueue() {  
    return new Queue("order.release.order.queue", true, false, false);  
}
@Bean  
public Binding OrderCreateOrderBinding() {  
    return new Binding("order.delay.queue", Binding.DestinationType.QUEUE, "order-event-exchange", "order.create.order", null);  
}
@Bean  
public Binding OrderReleaseOrderBinding() {  
    return new Binding("order.release.order.queue", Binding.DestinationType.QUEUE, "order-event-exchange", "order.release.order", null);  
}
```
### 4. æ¶ˆæ¯å †ç§¯
- å¢åŠ æ›´å¤šæ¶ˆè´¹è€…å»æ¶ˆè´¹
- åœ¨æ¶ˆè´¹è€…å†…éƒ¨å¼€å¯çº¿ç¨‹æ± åŠ å¿«å¤„ç†é€Ÿåº¦
- å¢åŠ é˜Ÿåˆ—å®¹ç§¯ï¼Œé‡‡ç”¨æƒ°æ€§é˜Ÿåˆ—ï¼ˆæ¶ˆæ¯å­˜å‚¨åœ¨ç£ç›˜ä¸­ï¼‰
### 5. é«˜å¯ç”¨
#### æ™®é€šé›†ç¾¤
```txt
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Node A â”‚<---->â”‚ Node B â”‚<---->â”‚ Node C â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
æ¯ä¸ªèŠ‚ç‚¹å…±äº«äº¤æ¢æœºä¿¡æ¯å’Œéƒ¨åˆ†é˜Ÿåˆ—ä¿¡æ¯ï¼Œé˜Ÿåˆ—ç»‘å®šåœ¨å“ªä¸ªèŠ‚ç‚¹æ•°æ®å°±å­˜å‚¨åœ¨å“ªä¸ªèŠ‚ç‚¹ï¼Œå…¶ä»–èŠ‚ç‚¹åªæœ‰è¿™ä¸ªé˜Ÿåˆ—çš„å¼•ç”¨ä¿¡æ¯ï¼Œå½“å®¢æˆ·ç«¯è®¿é—®çš„èŠ‚ç‚¹æ²¡æœ‰å¯¹åº”é˜Ÿåˆ—çš„æ•°æ®æ—¶ï¼Œé˜Ÿåˆ—æ‰€åœ¨èŠ‚ç‚¹ä¼šæŠŠæ•°æ®å‘ç»™å½“å‰èŠ‚ç‚¹è¿”å›ç»™å®¢æˆ·ç«¯
#### é•œåƒé›†ç¾¤
```txt
          (åŒæ­¥å¤åˆ¶æœºåˆ¶)
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                     â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Node A â”‚<->â”‚ Node B â”‚<->â”‚ Node C â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–²             â–²             â–²
      â”‚             â”‚             â”‚
     ä¸»é˜Ÿåˆ—       é•œåƒå‰¯æœ¬     é•œåƒå‰¯æœ¬
    ï¼ˆMasterï¼‰   ï¼ˆSlaveï¼‰     ï¼ˆSlaveï¼‰
```
é˜Ÿåˆ—æ•°æ®è‡ªåŠ¨åŒæ­¥åˆ°å…¶ä»–é•œåƒèŠ‚ç‚¹ï¼Œå½“ä¸»èŠ‚ç‚¹å®•æœºå‰¯æœ¬è‡ªåŠ¨æˆä¸ºæ–°çš„masterï¼Œé«˜å¯ç”¨ï¼Œä½†åŒæ­¥æ•°æ®å¼€é”€å¤§ï¼Œæ€§èƒ½ä¸‹é™
#### ä»²è£æ¨¡å¼
```txt
    (ä½¿ç”¨ Raft åè®®å¼ºä¸€è‡´å¤åˆ¶)
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚Client  â”‚
        â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
            â”‚
        â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”
        â”‚ Leader â”‚  â†  å†™æ“ä½œã€æŠ•ç¥¨ä¸»èŠ‚ç‚¹
        â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
     â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Followerâ”‚     â”‚Followerâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
ä¸»ä»åŒæ­¥é‡‡ç”¨raftåè®®ã€å¼ºä¸€è‡´ï¼Œä½¿ç”¨ç®€å•

| æ¨¡å¼          | æ•°æ®å‰¯æœ¬ | å®¹ç¾èƒ½åŠ› | æ€§èƒ½  | å®˜æ–¹æ¨è | å¤‡æ³¨            |
| ----------- | ---- | ---- | --- | ---- | ------------- |
| æ™®é€šé›†ç¾¤        | æ—     | å·®    | é«˜   | âŒ    | é˜Ÿåˆ—æŒ‚åœ¨å“ªä¸ªèŠ‚ç‚¹ç®—è°çš„   |
| é•œåƒé˜Ÿåˆ—é›†ç¾¤      | æ‰‹åŠ¨é…ç½® | é«˜    | ä¸­-ä½ | âš ï¸å¼ƒç”¨ | åŒæ­¥æˆæœ¬é«˜ã€å¤æ‚      |
| Quorum é˜Ÿåˆ—é›†ç¾¤ | è‡ªåŠ¨æ§åˆ¶ | é«˜    | ä¸­   | âœ…æ¨è  | Raftå¼ºä¸€è‡´ï¼Œé€‚åˆæ–°é¡¹ç›® |
## äºŒ. kafka
### 1. æ¶ˆæ¯ä¸ä¸¢å¤±
# åŸºç¡€
## ä¸€. å¸¸è§é›†åˆ
### 1. æ•°ç»„
#### ä¸ºä»€ä¹ˆç´¢å¼•ä¸‹æ ‡ä»0å¼€å§‹
é€šè¿‡ç´¢å¼•è®¿é—®å…ƒç´ å®é™…ä¸Šæ˜¯é€šè¿‡ **æ•°ç»„é¦–åœ°å€+ç´¢å¼• * æ•°ç»„æ•°æ®ç±»å‹é•¿åº¦** å¾—åˆ°çš„ï¼Œå¦‚æœä¸‹æ ‡ä»1å¼€å§‹ï¼Œç´¢å¼•è¦é¢å¤–è¿›è¡Œå‡1è¿ç®—ï¼Œå¢åŠ äº†cpuçš„è¿ç®—
#### æ’å…¥/ä¿®æ”¹/åˆ é™¤
éƒ½æ˜¯O( n )å¤æ‚åº¦
### 2. ArrayList
#### æˆå‘˜å±æ€§ã€æ„é€ å‡½æ•°ã€addæ–¹æ³•
```java
//é»˜è®¤çš„åˆå§‹åŒ–å®¹é‡
private static final int DEFAULT_CAPACITY = 10;  

//ä¸¤ä¸ªå®¹é‡æ˜¯0çš„ç¼“å†²åŒºï¼Œç”¨æ¥åŒºåˆ†æœ‰å‚å’Œæ— å‚åˆ›å»ºå‡ºçš„listé›†åˆï¼Œåœ¨é¦–æ¬¡æ‰©å®¹æ—¶ä¼šæœ‰åŒºåˆ«
private static final Object[] EMPTY_ELEMENTDATA = {}; 

private static final Object[] DEFAULTCAPACITY_EMPTY_ELEMENTDATA = {};  

//çŸ­æš‚æ€§å­˜å‚¨æ•°æ®çš„æ•°ç»„ï¼Œåœ¨æ‰©å®¹æ—¶æ˜¯ç›´æ¥è¿›è¡Œæ•°ç»„æ‹·è´+æ›¿æ¢ï¼Œåœ°å€ä¼šæ”¹å˜
transient Object[] elementData;

//å…ƒç´ ä¸ªæ•°å¹¶éå®¹é‡
private int size;

//æœ‰å‚æ„é€ å™¨ï¼Œåˆ›å»ºä¸€ä¸ªæŒ‡å®šå®¹é‡çš„listï¼Œå¦‚æœå‚æ•°æ˜¯0ï¼Œç›´æ¥å°†EMPTY_ELEMENTDATAæˆå‘˜å˜é‡
//èµ‹ç»™elementData
public ArrayList(int initialCapacity) {  
    if (initialCapacity > 0) {  
        this.elementData = new Object[initialCapacity];  
    } else if (initialCapacity == 0) {  
        this.elementData = EMPTY_ELEMENTDATA;  
    } else {  
        throw new IllegalArgumentException("Illegal Capacity: "+  
                                           initialCapacity);  
    }  
}  

//æ— å‚æ„é€ ï¼Œç›´æ¥å°†DEFAULTCAPACITY_EMPTY_ELEMENTDATAèµ‹ç»™elementData
public ArrayList() {  
    this.elementData = DEFAULTCAPACITY_EMPTY_ELEMENTDATA;  
}  

//æ¥æ”¶collectionå‚æ•°ï¼Œå°†å…¶ç›´æ¥èµ‹ç»™elementDataï¼Œæˆ–å°†å…¶å…ƒç´ æ‹·è´+æ›¿æ¢ç»™elementData
public ArrayList(Collection<? extends E> c) {  
    Object[] a = c.toArray();  
    if ((size = a.length) != 0) {  
        if (c.getClass() == ArrayList.class) {  
            elementData = a;  
        } else {  
            elementData = Arrays.copyOf(a, size, Object[].class);  
        }  
    } else {  
        // å¦‚æœå‚æ•°é•¿åº¦ä¸º0ï¼Œåˆ™ä¸º EMPTY_ELEMENTDATA
        elementData = EMPTY_ELEMENTDATA;  
    }  
}
```

| å­—æ®µå                                 | å«ä¹‰             | ç”¨é€”                                                                 |
| ----------------------------------- | -------------- | ------------------------------------------------------------------ |
| `EMPTY_ELEMENTDATA`                 | çœŸæ­£çš„ç©ºæ•°ç»„         | é€šè¿‡ `new ArrayList(0)` åˆ›å»ºæ—¶ç”¨å®ƒï¼Œè¡¨ç¤º**å®¹é‡å°±æ˜¯ 0**                           |
| `DEFAULTCAPACITY_EMPTY_ELEMENTDATA` | ç©ºæ•°ç»„ï¼Œå ä½ç”¨ï¼Œæ‡’åˆå§‹åŒ–æ—¶ç”¨ | é€šè¿‡ `new ArrayList()` åˆ›å»ºæ—¶ç”¨å®ƒï¼Œè¡¨ç¤º**åˆå§‹å®¹é‡ä¸ºé»˜è®¤å€¼ï¼ˆ10ï¼‰ï¼Œä½†å°šæœªåˆ†é…** ï¼Œåœ¨é¦–æ¬¡æ·»åŠ å…ƒç´ ä¹‹ååˆ†é…ç©ºé—´ |

```java
public boolean add(E e) {  
    modCount++;  
    add(e, elementData, size);  
    return true;  
}
private void add(E e, Object[] elementData, int s) {  
    if (s == elementData.length)  
        elementData = grow();  
    elementData[s] = e;  
    size = s + 1;  
}
private Object[] grow() {  
    return grow(size + 1);  
}
private Object[] grow(int minCapacity) {  
    int oldCapacity = elementData.length;  
    if (oldCapacity > 0 || elementData != DEFAULTCAPACITY_EMPTY_ELEMENTDATA) {  
        int newCapacity = ArraysSupport.newLength(oldCapacity,  
                minCapacity - oldCapacity, /* minimum growth */  
                oldCapacity >> 1           /* preferred growth */);  
                //æ‹·è´å¹¶æ›¿æ¢
        return elementData = Arrays.copyOf(elementData, newCapacity);  
    } else {  
    //å¦‚æœæ˜¯`DEFAULTCAPACITY_EMPTY_ELEMENTDATA`ä¸”é¦–æ¬¡æ·»åŠ ï¼Œåˆ™ç›´æ¥æ‰©å®¹åˆ°10
        return elementData = new Object[Math.max(DEFAULT_CAPACITY, minCapacity)];  
    }  
}
```
å½“æ‰€éœ€æœ€å°å®¹é‡è¶…è¿‡å½“å‰å®¹é‡æ—¶ï¼Œè§¦å‘æ‰©å®¹ï¼Œæ¯”è¾ƒ **å½“å‰å®¹é‡ * 1.5å’Œæ‰€éœ€æœ€å°å®¹é‡ï¼Œå–è¾ƒå¤§å€¼** æˆä¸ºæ–°elementDataçš„é•¿åº¦ï¼Œä¸”å°†åŸæ¥çš„å…ƒç´ copyæˆæ–°çš„æ•°ç»„å¹¶æ›¿æ¢åŸæ¥çš„
ä½†æ˜¯é€šè¿‡ **new ArrayList()** åˆ›å»ºçš„list **åˆå§‹é»˜è®¤å®¹é‡æ˜¯10**ï¼Œä½†å®é™…ä¸Šè¿˜æ²¡æœ‰çœŸæ­£åˆ†é…ç©ºé—´ï¼Œå®é™…å¤§å°æ˜¯0ï¼Œåœ¨é¦–æ¬¡æ·»åŠ å…ƒç´ æ—¶ï¼Œä¼šåˆ©ç”¨ **DEFAULTCAPACITY_EMPTY_ELEMENTDATA** åˆ¤æ–­æ˜¯å¦æ˜¯ç”±æ— å‚æ„é€ åˆ›å»ºçš„ï¼Œå¦‚æœæ˜¯åˆ™ç›´æ¥æ‰©å®¹åˆ°é»˜è®¤çš„åˆå§‹å¤§å°10
#### listå’Œæ•°ç»„è½¬æ¢
é€šå¸¸ä½¿ç”¨Arrays.asList( T... a )æ–¹æ³•å°†æ•°ç»„è½¬æˆlist
```java
public static <T> List<T> asList(T... a) {  
    return new ArrayList<>(a);  
}

private static class ArrayList<E> extends AbstractList<E>  
    implements RandomAccess, java.io.Serializable{
	private final E[] a;
	ArrayList(E[] array) {  
	    a = Objects.requireNonNull(array);  
	}
}
```
æ³¨æ„è¿™ä¸ªè¿”å›çš„ArrayListæ˜¯Arrayså†…éƒ¨çš„ä¸€ä¸ªé™æ€ç±»ï¼Œé€šè¿‡å®ƒçš„æ„é€ æ–¹æ³•ï¼Œåˆ¤æ–­ä¼ å…¥çš„æ•°ç»„æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºå°±ç›´æ¥èµ‹ç»™äº†å†…éƒ¨çš„æˆå‘˜å˜é‡ï¼Œä¹Ÿå°±æ˜¯å®é™…å­˜å‚¨æ•°æ®çš„å˜é‡ï¼Œæ•°ç»„å’Œæˆå‘˜å˜é‡æŒ‡å‘åŒä¸€ä¸ªåœ°å€ï¼Œæ‰€ä»¥å½“æ•°ç»„å†…å®¹å‘ç”Ÿæ”¹å˜ï¼Œè½¬æˆçš„listä¹Ÿæ˜¯ä¼šå˜åŒ–çš„

ä½¿ç”¨toArray((T[] a)æ–¹æ³•å°†listè½¬æˆæ•°ç»„
```java
public <T> T[] toArray(T[] a) {  
    int size = size();  
    if (a.length < size)  
	    //æ‹·è´this.a
        return Arrays.copyOf(this.a, size,  
                             (Class<? extends T[]>) a.getClass());  
    System.arraycopy(this.a, 0, a, 0, size);  
    if (a.length > size)  
        a[size] = null;  
    return a;  
}
```
æŠŠlistå†…çš„aï¼Œä¹Ÿå°±æ˜¯å®é™…å­˜å‚¨æ•°æ®çš„æ•°ç»„ï¼Œcopyå…ƒç´ è¿›ä¼ å…¥çš„æ•°ç»„å‚æ•°ä¸­ï¼ˆæµ…æ‹·è´ï¼‰ï¼Œç„¶åå°†copyå®Œæˆçš„å‚æ•°æ•°ç»„è¿”å›ï¼Œä¸¤è€…æ²¡æœ‰æŒ‡å‘åŒä¸€ä¸ªåœ°å€ï¼Œæ‰€ä»¥listå˜åŒ–å½±å“ä¸åˆ°æ•°ç»„
#### ArrayListå’ŒLinkedListåŒºåˆ«
##### åº•å±‚ç»“æ„
ArrayListåº•å±‚æ˜¯Object[ ]æ•°ç»„ï¼ŒLinkedListåº•å±‚æ˜¯åŒå‘é“¾è¡¨
##### æ•ˆç‡
- ArrayListæ”¯æŒç´¢å¼•æŸ¥è¯¢ï¼ŒLinkedListä¸æ”¯æŒ
- æŸ¥è¯¢æœªçŸ¥å…ƒç´ ä¸¤è€…éƒ½éœ€è¦éå†ï¼ŒO(n)
- ArrayListå°¾éƒ¨æ’å…¥å’Œåˆ é™¤æ˜¯O(1)ï¼Œå…¶ä»–ä½ç½®éœ€è¦éå†æ˜¯O(n)
- LinkedListå¤´å°¾æ’å…¥å’Œåˆ é™¤æ˜¯æ˜¯O(1)ï¼Œå…¶ä»–ä½ç½®éœ€è¦éå†æ˜¯O(n)
##### ç©ºé—´
ArrayListä½¿ç”¨æ•°ç»„ï¼Œç©ºé—´è¿ç»­ï¼Œå ç”¨å†…å­˜å°ï¼ŒLinkedListä½¿ç”¨é“¾è¡¨ï¼ŒèŠ‚ç‚¹è¿˜åŒ…å«åŒå‘æŒ‡é’ˆï¼Œå ç”¨å†…å®¹å¤§
##### çº¿ç¨‹å®‰å…¨
éƒ½ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„
å¯ä»¥åªåœ¨æ–¹æ³•å†…åˆ›å»ºå¹¶ä½¿ç”¨list
```java
List<Integer> list = Collections.synchronizedList(thereIsNoParametricStructure);
public static <T> List<T> synchronizedList(List<T> list) {  
    return (list instanceof RandomAccess ?  
            new SynchronizedRandomAccessList<>(list) :  
            new SynchronizedList<>(list));  
}

static class SynchronizedList<E>  
    extends SynchronizedCollection<E>  
    implements List<E> {  
    
    @SuppressWarnings("serial") // Conditionally serializable  
    final List<E> list;  
  
    SynchronizedList(List<E> list) {  
        super(list);  
        //ç›´æ¥èµ‹
        this.list = list;  
    }
}
```
å¯ä»¥ä½¿ç”¨Collections.synchronizedListæ–¹æ³•ä½¿å…¶çº¿ç¨‹å®‰å…¨ï¼Œæœ¬è´¨ä¸Šæ˜¯ç»™åŸé›†åˆåŠ ä¸Šäº†syncé”ï¼Œå°è£…æˆäº†SynchronizedListé›†åˆè¿”å›ï¼Œå…¶å†…éƒ¨çš„listå˜é‡å’Œä¼ å…¥æ–¹æ³•çš„åŸlistæŒ‡å‘åŒä¸€ä¸ªåœ°å€
### 3. HashMap
#### å®ç°åŸç†
ä½¿ç”¨æ•°ç»„+é“¾è¡¨æˆ–çº¢é»‘æ ‘çš„ç»“æ„ï¼ˆhashè¡¨ï¼‰ï¼Œæ•°ç»„çš„å…ƒç´ æ˜¯é“¾è¡¨æˆ–çº¢é»‘æ ‘
å­˜å‚¨æ—¶ï¼Œæ ¹æ®keyè®¡ç®—å®ƒçš„hashå€¼å¾—åˆ°æ•°ç»„ä¸‹æ ‡ï¼Œå¦‚æœå‡ºç°hashå€¼ç›¸åŒçš„æƒ…å†µï¼Œkeyç›¸åŒåˆ™è¦†ç›–åŸæ¥çš„å€¼ï¼Œkeyä¸åŒåˆ™æ”¾å…¥é“¾è¡¨æˆ–çº¢é»‘æ ‘ä¸­
æŸ¥æ‰¾æ—¶ï¼Œè®¡ç®—hashå€¼å¾—åˆ°ä¸‹æ ‡ï¼Œåœ¨æ ¹æ®keyåˆ°é“¾è¡¨æˆ–çº¢é»‘æ ‘ä¸­åˆ¤æ–­keyæ˜¯å¦ä¸€è‡´ï¼ŒæŸ¥æ‰¾å¯¹åº”çš„å€¼
jdk8ä¹‹å‰åªæœ‰æ•°ç»„+é“¾è¡¨ï¼Œä¹‹åæ‰æ˜¯æ•°ç»„+é“¾è¡¨æˆ–çº¢é»‘æ ‘
##### é“¾è¡¨å˜ä¸ºçº¢é»‘æ ‘
å½“æ•°ç»„é•¿åº¦å¤§äºç­‰äº64ï¼ŒæŸä¸ªå…ƒç´ çš„é“¾è¡¨é•¿åº¦å¤§äºç­‰äº8ï¼Œåˆ™ä¼šå°†è¯¥å…ƒç´ çš„é“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘
#### putæ–¹æ³•
##### æ‰§è¡Œæµç¨‹
```txt
Start
 |
 |---> 1. key == null ?
 |         |
 |         |-- Yes --> æ’å…¥æˆ–æ›¿æ¢ table[0]ï¼ˆé“¾è¡¨/æ ‘ç»“æ„ï¼‰
 |         |
 |         |-- No --> è®¡ç®— key çš„ hash å€¼ï¼ˆhash(key)ï¼‰
 |
 |---> 2. è®¡ç®—ç´¢å¼•ä½ç½® index = (n - 1) & hash
 |
 |---> 3. table[index] æ˜¯å¦ä¸º nullï¼Ÿ
 |         |
 |         |-- Yes --> åˆ›å»ºæ–°èŠ‚ç‚¹ï¼Œç›´æ¥æ’å…¥
 |         |
 |         |-- No --> å†²çªå¤„ç†ï¼š
 |                |
 |                |-- èŠ‚ç‚¹ key ç›¸åŒï¼ˆequals åˆ¤æ–­ï¼‰ï¼Ÿ
 |                |       |
 |                |       |-- Yes --> æ›¿æ¢æ—§å€¼
 |                |       |
 |                |       |-- No --> éå†é“¾è¡¨/æ ‘
 |                |                 |
 |                |                 |-- æŸ¥åˆ°é‡å¤ keyï¼Ÿæ›¿æ¢æ—§å€¼
 |                |                 |-- å¦ï¼Œå°¾éƒ¨æ’å…¥æ–°èŠ‚ç‚¹
 |                |
 |                |-- å¦‚æœé“¾è¡¨é•¿åº¦ â‰¥ TREEIFY_THRESHOLDï¼ˆé»˜è®¤ 8ï¼‰
 |                        |
 |                        |-- æ˜¯ --> è½¬æ¢ä¸ºçº¢é»‘æ ‘
 |
 |---> 4. size++
 |
 |---> 5. åˆ¤æ–­ size > thresholdï¼Ÿ
 |         |
 |         |-- æ˜¯ --> resize() æ‰©å®¹
 |
End
```
##### æˆå‘˜å˜é‡å’Œæ„é€ å‡½æ•°
```java
//é»˜è®¤çš„åˆå§‹å®¹é‡
static final int DEFAULT_INITIAL_CAPACITY = 1 << 4;
//æœ€å¤§å®¹é‡
static final int MAXIMUM_CAPACITY = 1 << 30;
//é»˜è®¤è´Ÿè½½å› å­
static final float DEFAULT_LOAD_FACTOR = 0.75f;
//é“¾è¡¨è½¬æ¢æˆçº¢é»‘æ ‘çš„é•¿åº¦ä¸´ç•Œå€¼
static final int TREEIFY_THRESHOLD = 8;
//çº¢é»‘æ ‘é€€åŒ–æˆé“¾è¡¨çš„ä¸´ç•Œå€¼
static final int UNTREEIFY_THRESHOLD = 6;
//è§¦å‘é“¾è¡¨è½¬æ¢æˆçº¢é»‘æ ‘çš„æ•°ç»„é•¿åº¦æœ€å°è¦æ±‚
static final int MIN_TREEIFY_CAPACITY = 64;
//å­˜å‚¨kï¼Œvçš„æ•°ç»„ï¼Œå“ˆå¸Œè¡¨
transient Node<K,V>[] table;
//å­˜å‚¨å…ƒç´ çš„å¤šå°‘
transient int size;
//è§¦å‘æ‰©å®¹çš„é˜ˆå€¼ï¼Œå½“å‰æœ€å¤§å®¹é‡*è´Ÿè½½å› å­
int threshold;
```
ä¹‹æ‰€ä»¥ä¸´ç•Œå€¼å’Œé»˜è®¤è´Ÿè½½å› å­è¦è®¾ç½®æˆè¿™æ ·æ˜¯å› ä¸ºå‡ºäºç»éªŒè€ƒè™‘å’Œæ³Šæ¾åˆ†å¸ƒç»Ÿè®¡è€Œæ¥ï¼Œå½“è´Ÿè½½å› å­ä¸º0.75æ—¶ç©ºé—´æµªè´¹ä¸ä¸¥é‡ï¼Œä¸”å“ˆå¸Œå†²çªæ¬¡æ•°è¾ƒå°‘ï¼Œå¦‚æœå› å­è¾ƒå°åˆ™ç©ºé—´æµªè´¹ä¸¥é‡ï¼Œè¾ƒå¤§åˆ™å“ˆå¸Œå†²çªæ¬¡æ•°å˜å¤šã€‚é“¾è¡¨é•¿åº¦å¤§äº8æ—¶æŸ¥æ‰¾æ€§èƒ½å°±ä¼šä»O(1)ä¸‹é™åˆ°O(n)ï¼Œè½¬æ¢æˆçº¢é»‘æ ‘æŸ¥æ‰¾æ•ˆç‡èƒ½å¾—åˆ°æå‡ï¼Œå¦‚æœè½¬æ¢ä¸´ç•Œå€¼å°äº8åˆ™è¿‡æ—©è½¬æ¢æµªè´¹å¤§é‡ç©ºé—´ï¼ˆçº¢é»‘æ ‘è€—è´¹ç©ºé—´ï¼‰ï¼Œå¤§äº8åˆ™æŸ¥æ‰¾æ•ˆç‡ä½ä¸‹
```java
//æ— å‚æ„é€ ï¼Œè®¾ç½®è´Ÿè½½å› å­ä¸ºé»˜è®¤çš„ï¼Œæ³¨æ„è¿™ç§æƒ…å†µä¸‹æ‰©å®¹é˜ˆå€¼ä¸º0
public HashMap() {  
    this.loadFactor = DEFAULT_LOAD_FACTOR; // all other fields defaulted  
}
public HashMap(int initialCapacity) {  
	//ä¼ å…¥æŒ‡å®šå®¹é‡å’Œé»˜è®¤è´Ÿè½½å› å­
    this(initialCapacity, DEFAULT_LOAD_FACTOR);  
}
//æœ‰å‚æ„é€ 
public HashMap(int initialCapacity, float loadFactor) {  
    if (initialCapacity < 0)  
        throw new IllegalArgumentException("Illegal initial capacity: " +  
                                           initialCapacity);
	 //æŒ‡å®šå®¹é‡å¤§äºæœ€å¤§å®¹é‡ï¼Œå–æœ€å¤§å®¹é‡
    if (initialCapacity > MAXIMUM_CAPACITY)  
        initialCapacity = MAXIMUM_CAPACITY;  
    if (loadFactor <= 0 || Float.isNaN(loadFactor))  
        throw new IllegalArgumentException("Illegal load factor: " +  
                                           loadFactor);  
    this.loadFactor = loadFactor; 
    //æå‰è®¡ç®—å‡ºåˆå§‹åŒ–å®¹é‡å¤§å°ï¼Œåªä¸è¿‡èµ‹å€¼ç»™äº†é˜ˆå€¼å˜é‡ï¼Œç”±æ­¤çœ‹å‡ºæœ‰å‚æ„é€ åˆå§‹åŒ–æ—¶ï¼Œæ‰©å®¹é˜ˆå€¼å°±ä¸ä¼šæ˜¯0ï¼Œå’Œæ— å‚æ„é€ åŒºåˆ†å¼€äº†ï¼Œè€Œå…¶çœŸæ­£çš„é˜ˆå€¼ä¼šåœ¨ç¬¬ä¸€æ¬¡putæ˜¯æ‰çœŸæ­£è®¡ç®—
    this.threshold = tableSizeFor(initialCapacity);  
}
//ç”±äºhashmapè¦æ±‚å®¹é‡åªèƒ½æ˜¯2çš„å¹‚æ¬¡ï¼Œæ‰€ä»¥ä¼šå°†çœŸå®å®¹é‡è®¾ç½®ä¸ºå¤§äºç­‰äºæœ‰å‚æ„é€ ä¼ å…¥å‚æ•°çš„æœ€å°2çš„å¹‚æ¬¡
static final int tableSizeFor(int cap) {  
    int n = -1 >>> Integer.numberOfLeadingZeros(cap - 1);  
    return (n < 0) ? 1 : (n >= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + 1;  
}
```
##### putæ–¹æ³•
```java
public V put(K key, V value) {  
    return putVal(hash(key), key, value, false, true);  
}
final V putVal(int hash, K key, V value, boolean onlyIfAbsent,  
               boolean evict) {  
    Node<K,V>[] tab; Node<K,V> p; int n, i;
    //å…ˆåˆ¤æ–­tableæ˜¯å¦ä¸ºç©ºæˆ–è€…é•¿åº¦ä¸º0ï¼Œå¦‚æœæ˜¯å°±è¦åˆå§‹åŒ–å®¹é‡  
    if ((tab = table) == null || (n = tab.length) == 0)  
        n = (tab = resize()).length;
    //åˆ¤æ–­keyè¦æ’å…¥çš„ä½ç½®æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºç›´æ¥æ’å…¥  
    if ((p = tab[i = (n - 1) & hash]) == null)  
        tab[i] = newNode(hash, key, value, null);  
    else {  
        Node<K,V> e; K k;  
        //æŸ¥æ‰¾æ¡¶ä¸­ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œæ˜¯å¦keyç›¸åŒï¼Œç›¸åŒåˆ™è¿›è¡Œè¦†ç›–
        if (p.hash == hash &&  
            ((k = p.key) == key || (key != null && key.equals(k))))  
            e = p;  
        else if (p instanceof TreeNode)  
            e = ((TreeNode<K,V>)p).putTreeVal(this, tab, hash, key, value);  
        else {  
	        //ä¸ç›¸åŒåˆ™è¿›å…¥é“¾è¡¨è¿›è¡Œéå†
            for (int binCount = 0; ; ++binCount) {  
	            //å¦‚æœæ‰¾åˆ°æœ«å°¾ä»ç„¶æ²¡æœ‰åŒ¹é…çš„åˆ™æ’å…¥åˆ°å°¾éƒ¨
	            //å¦‚æœé“¾è¡¨é•¿åº¦å¤§äº8åˆ™è½¬æ¢æˆçº¢é»‘æ ‘
                if ((e = p.next) == null) {  
                    p.next = newNode(hash, key, value, null);  
                    if (binCount >= TREEIFY_THRESHOLD - 1) // -1 for 1st  
                        treeifyBin(tab, hash);  
                    break;  
                }  
                //æ‰¾åˆ°åŒ¹é…èŠ‚ç‚¹ç›´æ¥é€€å‡º
                if (e.hash == hash &&  
                    ((k = e.key) == key || (key != null && key.equals(k))))  
                    break;  
                p = e;  
            }  
        }  
        //å¦‚æœæ‰¾åˆ°çš„èŠ‚ç‚¹ä¸ºç©ºï¼Œæ›´æ–°èŠ‚ç‚¹
        if (e != null) { // existing mapping for key  
            V oldValue = e.value;  
            if (!onlyIfAbsent || oldValue == null)  
                e.value = value;  
            afterNodeAccess(e);  
            return oldValue;  
        }  
    }  
    //å¢åŠ ä¿®æ”¹æ¬¡æ•°
    ++modCount;  
    //åˆ¤æ–­å…ƒç´ ä¸ªæ•°æ˜¯å¦è¶…è¿‡é˜ˆå€¼ï¼Œè¶…è¿‡åˆ™è¿›è¡Œæ‰©å®¹ï¼Œå¦‚æœæ˜¯æ–°å¢æ‰ä¼šè§¦å‘++ï¼Œè¦†ç›–æ—§çš„ä¸ä¼š
    if (++size > threshold)  
        resize();  
    afterNodeInsertion(evict);  
    return null;  
}
```
#### æ‰©å®¹
```java
final Node<K,V>[] resize() {  
	//å¼•ç”¨table
    Node<K,V>[] oldTab = table; 
    //å¦‚æœä¸ºç©ºå®¹é‡ä¸º0ï¼Œå¦åˆ™ä¸ºå“ˆå¸Œè¡¨çš„é•¿åº¦ 
    int oldCap = (oldTab == null) ? 0 : oldTab.length;  
    //è®°å½•å½“å‰æ‰©å®¹é˜ˆå€¼
    int oldThr = threshold;  
    //å®šä¹‰æ–°çš„å®¹é‡å’Œæ‰©å®¹é˜ˆå€¼
    int newCap, newThr = 0;  
    //å¦‚æœå½“å‰å®¹é‡å¤§äº0
    if (oldCap > 0) {  
		//å®¹é‡å·²ç»è¾¾åˆ°æœ€å¤§å®¹é‡ï¼Œè®¾ç½®æ‰©å®¹é˜ˆå€¼ï¼Œè¿”å›å½“å‰å“ˆå¸Œè¡¨ï¼Œè¡¨ç¤ºä¸å†æ‰©å®¹
        if (oldCap >= MAXIMUM_CAPACITY) {  
            threshold = Integer.MAX_VALUE;  
            return oldTab;  
        }  
        //æ²¡æœ‰åˆ°æœ€å¤§å®¹é‡ï¼Œåˆ™å°†å®¹é‡ç¿»å€ï¼ŒåŒæ—¶æ‰©å®¹é˜ˆå€¼ä¹Ÿå› æ­¤ç¿»å€
        else if ((newCap = oldCap << 1) < MAXIMUM_CAPACITY &&  
                 oldCap >= DEFAULT_INITIAL_CAPACITY)  
            newThr = oldThr << 1; // double threshold  
    }  
    //å¦‚æœå½“å‰å®¹é‡ä¸º0ï¼Œä¸”æ‰©å®¹é˜ˆå€¼å¤§äº0ï¼ˆå“ˆå¸Œè¡¨æ²¡æœ‰åˆå§‹åŒ–ï¼‰ï¼Œå°†å®¹é‡è®¾ç½®ä¸ºå½“å‰æ‰©å®¹é˜ˆå€¼
    //æ³¨æ„ï¼Œæ­¤ç§æƒ…å†µåªæœ‰ä½¿ç”¨çš„æ˜¯æœ‰å‚æ„é€ æ‰ä¼šå‡ºç°ï¼Œä¼ äº†åˆå§‹å®¹é‡ï¼Œåœ¨æ„é€ æ–¹æ³•é‡Œæå‰è®¡ç®—äº†åˆå§‹åŒ–å®¹é‡èµ‹ç»™äº†é˜ˆå€¼å˜é‡
    else if (oldThr > 0) // initial capacity was placed in threshold  
        newCap = oldThr;  
    else {               // zero initial threshold signifies using defaults  
	    //å¦‚æœå®¹é‡å’Œé˜ˆå€¼éƒ½ä¸º0ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å®¹é‡16å’Œé˜ˆå€¼
	    //æ­¤ç§æƒ…å†µä½¿ç”¨çš„æ˜¯æ— å‚æ„é€ æ‰ä¼šå‡ºç°ï¼Œå› ä¸ºæ— å‚æ„é€ æ²¡æœ‰ä¼ åˆå§‹å®¹é‡ï¼Œåˆ™é˜ˆå€¼è®¡ç®—å‡ºæ¥æ‰æ˜¯0
        newCap = DEFAULT_INITIAL_CAPACITY;  
        newThr = (int)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);  
    }  
    //è®¡ç®—æ‰©å®¹é˜ˆå€¼
    if (newThr == 0) {  
        float ft = (float)newCap * loadFactor;  
        newThr = (newCap < MAXIMUM_CAPACITY && ft < (float)MAXIMUM_CAPACITY ?  
                  (int)ft : Integer.MAX_VALUE);  
    }  
    //æ›´æ–°é˜ˆå€¼
    threshold = newThr;  
    @SuppressWarnings({"rawtypes","unchecked"}) 
    //åˆ›å»ºæ–°çš„å“ˆå¸Œè¡¨ï¼Œé•¿åº¦ä¸ºæ‰©å®¹ä¹‹åçš„é•¿åº¦ 
    Node<K,V>[] newTab = (Node<K,V>[])new Node[newCap];  
    //ç›´æ¥æ›¿æ¢æ‰æ—§çš„å“ˆå¸Œè¡¨
    table = newTab;  
    //æŠŠæ—§çš„å“ˆå¸Œè¡¨çš„æ•°æ®æ‹·è´è¿‡å»
    if (oldTab != null) {  
        for (int j = 0; j < oldCap; ++j) {  
            Node<K,V> e;  
            if ((e = oldTab[j]) != null) {  
                oldTab[j] = null;  
                if (e.next == null)  
                    newTab[e.hash & (newCap - 1)] = e;  
                else if (e instanceof TreeNode)  
                    ((TreeNode<K,V>)e).split(this, newTab, j, oldCap);  
                else { // preserve order  
                    Node<K,V> loHead = null, loTail = null;  
                    Node<K,V> hiHead = null, hiTail = null;  
                    Node<K,V> next;  
                    do {  
                        next = e.next;  
                        if ((e.hash & oldCap) == 0) {  
                            if (loTail == null)  
                                loHead = e;  
                            else  
                                loTail.next = e;  
                            loTail = e;  
                        }  
                        else {  
                            if (hiTail == null)  
                                hiHead = e;  
                            else  
                                hiTail.next = e;  
                            hiTail = e;  
                        }  
                    } while ((e = next) != null);  
                    if (loTail != null) {  
                        loTail.next = null;  
                        newTab[j] = loHead;  
                    }  
                    if (hiTail != null) {  
                        hiTail.next = null;  
                        newTab[j + oldCap] = hiHead;  
                    }  
                }  
            }  
        }  
    }  
    return newTab;  
}
```
#### å¯»å€æ–¹å¼
```java
static final int hash(Object key) {  
    int h;  
    return (key == null) ? 0 : (h = key.hashCode()) ^ (h >>> 16);  
}
```
å…ˆé€šè¿‡hashCodeæ–¹æ³•å¾—åˆ°å“ˆå¸Œå€¼ï¼Œç„¶åå°†å…¶å‘å³ä½ç§»16ä½çš„å€¼å’Œè‡ªå·±åšå¼‚æˆ–è¿ç®—è¿›è¡ŒäºŒæ¬¡å“ˆå¸Œï¼Œä¹‹æ‰€ä»¥è¦è¿›è¡ŒäºŒæ¬¡å“ˆå¸Œæ˜¯ä¸ºäº†è®©å“ˆå¸Œå€¼æ›´å‡åŒ€
```java
newTab[e.hash & (newCap - 1)]

(e.hash & oldCap) == 0
 ```
æ ¹æ®å“ˆå¸Œå€¼è®¡ç®—ç´¢å¼•æ—¶æ˜¯ç”¨å“ˆå¸Œå€¼å¯¹æ•°ç»„é•¿åº¦å–æ¨¡ï¼Œä½†æ˜¯cupçš„å–ä½™è¿ç®—ä¼šæœ‰å¤šæ­¥æ“ä½œï¼Œå¦‚æœæ•°ç»„é•¿åº¦æ˜¯2çš„å¹‚æ¬¡å¯ä»¥å°†å…¶ç­‰ä»·ä¸º**hash&(é•¿åº¦-1)**ï¼Œåªéœ€è¦ä¸€æ¬¡è¿ç®—ï¼Œå¢åŠ äº†æ€§èƒ½
è€Œä¸”åœ¨æ‰©å®¹æ—¶éœ€è¦é‡æ–°è®¡ç®—å“ˆå¸Œå€¼å¯¹åº”çš„ç´¢å¼•ï¼Œå¦‚æœæ•°ç»„é•¿åº¦æ˜¯2çš„å¹‚æ¬¡ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡**hash&oldCap**çš„è¿ç®—å¿«é€Ÿåˆ¤æ–­å…ƒç´ æ˜¯å¦è¦ç•™åœ¨åŸæ¥çš„ä½ç½®è¿˜æ˜¯æ–°çš„ä½ç½®ï¼ˆå½“å‰ä½ç½®+æ—§çš„æ•°ç»„é•¿åº¦ï¼‰
#### 1.7HashMapå¤šçº¿ç¨‹æ­»å¾ªç¯
1.7çš„hashmapè¿›è¡Œæ•°æ®è¿ç§»ä½¿ç”¨å¤´æ’æ³•å°†é“¾è¡¨å…ƒç´ ç§»åŠ¨ï¼Œç›¸å½“äºè¿ç§»ä¹‹åé“¾è¡¨å‘ç”Ÿé¢ å€’ï¼Œåœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹ï¼Œçº¿ç¨‹äºŒå®Œæˆäº†è¿ç§»é“¾è¡¨é¢ å€’ï¼Œçº¿ç¨‹ä¸€å¯¹é“¾è¡¨å¤´éƒ¨çš„å¼•ç”¨ä»ç„¶æ˜¯æ²¡æœ‰é¢ å€’ä¹‹å‰çš„ï¼Œå¦‚ä¹‹å‰æ˜¯
A->Bï¼Œçº¿ç¨‹äºŒä¹‹åæˆäº†B->Aï¼Œçº¿ç¨‹ä¸€å¯¹é“¾è¡¨å¤´éƒ¨çš„å¼•ç”¨ä»ç„¶æ˜¯Aè€Œä¸æ˜¯Bï¼Œnextæ˜¯Bï¼ŒBçš„nextåˆæ˜¯Aï¼Œé€ æˆå¾ªç¯A->B->A
## äºŒ. å¸¸è§ç±»
### 1. Integer
#### è‡ªåŠ¨è£…ç®±
```java
//javaä»£ç 
Integer a=123;
//ç¼–è¯‘åçš„å­—èŠ‚ç æ–‡ä»¶
Integer a=Integer.valueOf(123);
```
intç±»å‹çš„å€¼èƒ½è‡ªåŠ¨è¢«å°è£…æˆIntegerå¯¹è±¡ï¼Œæ˜¯å› ä¸ºåœ¨ç¼–è¯‘åçš„classæ–‡ä»¶è°ƒç”¨äº†valueOfæ–¹æ³•
```java
Integer a=123;  
Integer b=123;  
int c=a+b;
//ç¼–è¯‘ä¹‹å
int c=a.intValue()+b.intValue();
```
åŒ…æ‹¬ä¸¤ä¸ªå¯¹è±¡ç›¸åŠ èƒ½å¾—å‡ºintç±»å‹çš„å€¼ï¼Œæ˜¯åœ¨ç¼–è¯‘ä¹‹åè°ƒç”¨äº†intValueè¿›è¡Œäº†æ‹†ç®±
#### ç¼“å­˜æœºåˆ¶
```java
//å¸¸é‡ï¼Œè‡ªåŠ¨è£…ç®±çš„intåŸå€¼
private final int value;
//å¾—åˆ°Integerå¯¹è±¡
public static Integer valueOf(int i) {  
	//åˆ¤æ–­æ˜¯å¦æ˜¯ç¼“å­˜æ± ä¸­èŒƒå›´çš„æ•°å­—ï¼Œå¦‚æœæ˜¯åˆ™ç›´æ¥ä»ç¼“å­˜æ± ä¸­å–å‡º
	//ä¸æ˜¯åˆ™ç”¨æ„é€ å‡½æ•°newä¸€ä¸ª
    if (i >= IntegerCache.low && i <= IntegerCache.high)  
        return IntegerCache.cache[i + (-IntegerCache.low)];  
    return new Integer(i);  
}

//é™æ€å†…éƒ¨ç±»ï¼Œæ‰€æœ‰Integerå¯¹è±¡å…±äº«ï¼Œç¼“å­˜æ± å¯¹
private static class IntegerCache {  
	//è§„å®šçš„ç¼“å­˜æ± çš„ä¸‹é™
    static final int low = -128;  
    //ç¼“å­˜æ± ä¸Šé™
    static final int high;  
    //çœŸå®ç¼“å­˜
    static final Integer[] cache;
    //å½’æ¡£ç¼“å­˜  
    static Integer[] archivedCache;  
	//åˆå§‹åŒ–é™æ€ä»£ç å—
    static {  
        //åˆå§‹åŒ–
        int h = 127;  
        //ä»JVMå‚æ•°ä¸­è¯»å–é…ç½®è®¾ç½®highï¼Œæ²¡æœ‰ä¸æŠ›å¼‚å¸¸
        String integerCacheHighPropValue =  
            VM.getSavedProperty("java.lang.Integer.IntegerCache.high");  
        if (integerCacheHighPropValue != null) {  
            try {  
                h = Math.max(parseInt(integerCacheHighPropValue), 127);  
                // Maximum array size is Integer.MAX_VALUE  
                h = Math.min(h, Integer.MAX_VALUE - (-low) -1);  
            } catch( NumberFormatException nfe) {  
                // If the property cannot be parsed into an int, ignore it.  
            }  
        }  
        high = h;  
        //CDSï¼ˆClass Data Sharingï¼‰ æ˜¯ JVM ä¸ºäº†åŠ å¿«ç±»åŠ è½½é€Ÿåº¦å’ŒèŠ‚çœå†…å­˜çš„ä¸€ç§å…±äº«æœºåˆ¶
        //å¦‚æœå¯ç”¨äº† CDSï¼ˆä¸€èˆ¬åœ¨æ¨¡å—åŒ– JVM ä¸­å¼€å¯ï¼‰ï¼ŒJVM ä¼šå°†å¸¸è§ç±»ï¼ˆå¦‚ Integerã€Stringï¼‰é¢„ç¼“å­˜åˆ°å½’æ¡£æ–‡ä»¶ä¸­ï¼Œä¸‹æ¬¡å¯åŠ¨å¯å¤ç”¨è¿™äº›ç¼“å­˜ï¼Œä¸å¿…é‡æ–°åˆå§‹åŒ–
		//ä»å½’æ¡£æ–‡ä»¶ä¸­æ¢å¤ IntegerCache çš„ç¼“å­˜ã€‚å¦‚æœå½’æ¡£ä¸­å­˜åœ¨æœ‰æ•ˆçš„ç¼“å­˜æ•°æ®ï¼Œå®ƒä¼šåŠ è½½è¿™äº›æ•°æ®å¹¶åˆå§‹åŒ– IntegerCache.archivedCach
        CDS.initializeFromArchive(IntegerCache.class);
        //å½“å‰ç¼“å­˜çš„å¤§å°
        int size = (high - low) + 1;  

		//å¦‚æœæ²¡æœ‰ç¼“å­˜æ•°æ®ï¼Œæˆ–è€…æ–°çš„ä¸Šä¸‹é™è¶…è¿‡äº†åŸæ¥çš„ç¼“å­˜æ•°æ®ï¼Œåˆ™è¿›è¡Œæ›´æ–°
        if (archivedCache == null || size > archivedCache.length) {  
            Integer[] c = new Integer[size];  
            int j = low;  
            for(int i = 0; i < c.length; i++) {  
                c[i] = new Integer(j++);  
            }  
            //é‡å¤newä¸€ä¸ªæ•°ç»„ï¼ŒèŒƒå›´ä»æ˜¯æ–°çš„ä¸Šä¸‹é™ï¼Œç„¶åè®¾ç½®å€¼ï¼ŒæŠŠåŸæ¥çš„å½’æ¡£ç¼“å­˜æ›¿æ¢
            archivedCache = c;  
        }  
        //è®¾ç½®æ–°çš„çœŸå®ç¼“å­˜
        cache = archivedCache;  
        assert IntegerCache.high >= 127;  
    }  
  
    private IntegerCache() {}  
}
```
ç”±æ­¤å¯è§å¯ä»¥é€šè¿‡`-XX:AutoBoxCacheMax=<size>` JVMå‚æ•°è®¾ç½®ä¸Šé™å¤§å°
### 2. String
#### å­—ç¬¦ä¸²å¸¸é‡æ± 
```java
String a = "hello";
String b = "hello";
System.out.println(a == b); // true
```
- **å­—ç¬¦ä¸²å­—é¢é‡ï¼ˆåŒå¼•å·ï¼‰** ä¼šè‡ªåŠ¨æ”¾å…¥JVMçš„æ–¹æ³•åŒºçš„å¸¸é‡æ± 
- å¦‚æœæ± ä¸­å·²æœ‰è¯¥å­—ç¬¦ä¸²ï¼ŒJVM ä¸ä¼šé‡æ–°åˆ›å»ºï¼Œè€Œæ˜¯å¤ç”¨åœ°å€
- **ä½†æ˜¯æ³¨æ„**å¦‚æœä¸æ˜¯å­—é¢é‡å­—ç¬¦ä¸²è€Œæ˜¯newå‡ºæ¥çš„ï¼Œä¼šæ”¾è¿›å †ä¸­ï¼Œä¸ç®¡æœ‰æ²¡æœ‰ç›¸åŒå­—ç¬¦ä¸²å€¼çš„å¯¹è±¡
```java
String s1 = "abc";
String s2 = new String("abc");
System.out.println(s1 == s2); // false â—
```
#### String æ˜¯ä¸å¯å˜çš„
```java
//å†…éƒ¨å­˜å‚¨å­—ç¬¦ä¸²çš„æ•°ç»„ï¼Œå› ä¸ºå­—ç¬¦ä¸²æœ¬èº«å°±æ˜¯ä¸€ä¸ªå­—ç¬¦æ•°ç»„ï¼ŒJava9ä¹‹åæ”¹æˆäº†byteæ•°ç»„
@Stable  
private final byte[] value;
```
- å®‰å…¨ï¼ˆå¤šçº¿ç¨‹ä¸‹ä¸éœ€è¦åŠ é”ï¼‰
- å¯ç¼“å­˜ï¼ˆåš hash ç¼“å­˜ï¼‰
- å¯è¢«ä½œä¸º Map çš„ key
- æ³¨æ„å¯¹Stringå¯¹è±¡æˆ–è€…Stringå­—é¢é‡è¿›è¡Œæ“ä½œï¼Œæ”¹å˜çš„åªæ˜¯å½“å‰è¿™ä¸ªå¼•ç”¨å˜é‡çš„åœ°å€ï¼ŒåŸæœ¬çš„å­—ç¬¦ä¸²å’Œå¯¹è±¡å¹¶æ²¡æœ‰æ”¹å˜ï¼Œæ“ä½œåå½¢æˆçš„æ–°å­—ç¬¦ä¸²æˆ–å¯¹è±¡ä¼šæ”¾è¿›æ–¹æ³•åŒºçš„å¸¸é‡æ± é‡Œæˆ–å †é‡Œ
```java
String a = "hello";
//å› ä¸ºä¸çŸ¥é“aè¿™ä¸ªå˜é‡åˆ°åº•æ˜¯å¸¸é‡æ± çš„åœ°å€å¼•ç”¨ã€‚è¿˜æ˜¯å †çš„åœ°å€å¼•ç”¨ï¼Œåˆ™ä¸€å¾‹å°†æ–°çš„ç»“æœæ”¾å…¥å †ä¸­ï¼Œbæ˜¯å †ä¸­stringå¯¹è±¡çš„åœ°å€å¼•ç”¨
String b = a + "world";
//ä½†æ˜¯"helloworld"æ˜¯å¸¸é‡æ± ä¸­çš„ï¼Œä¸¤ä¸ªè™½ç„¶å€¼ä¸€æ ·ï¼Œä½†æ˜¯åœ°å€ä¸ä¸€æ ·æ‰€ä»¥æ˜¯false
System.out.println(b == "helloworld"); // false âŒ
```
#### æ‹¼æ¥ä¼˜åŒ–
```java
String a = "hello" + "world"; // ç¼–è¯‘æœŸå¸¸é‡ä¼˜åŒ–
String b = "hello";
String c = b + "world";       // è¿è¡ŒæœŸæ‹¼æ¥
```
å¯¹äºä¸¤ä¸ªå­—é¢é‡å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œç¼–è¯‘åä¼šè¢«ä¼˜åŒ–æˆä¸€ä¸ªæ•´ä¸²ï¼Œæ”¾è¿›å¸¸é‡æ± ä¸­ï¼ˆå¦‚æœæ²¡æœ‰ï¼‰
å¯¹äºå¯¹è±¡+å¸¸é‡æˆ–å¯¹è±¡+å¯¹è±¡çš„æ‹¼æ¥ï¼Œç¼–è¯‘åä¼˜åŒ–æˆ`new StringBuilder().append(b).append("world").toString()` ä½¿ç”¨apiè¿›è¡Œæ‹¼æ¥å½¢æˆæ–°çš„Stringå¯¹è±¡ï¼Œæ”¾å…¥å †ä¸­ï¼ˆä¸ç®¡æœ‰æ²¡æœ‰ï¼‰
#### intern() æ–¹æ³•
```java
String a = new String("abc");
String b = a.intern();
String c = "abc";
System.out.println(b == c); // true âœ…
```
æŠŠå­—ç¬¦ä¸²æ”¾è¿›å¸¸é‡æ± ï¼ˆå¦‚æœè¿˜æ²¡æ”¾çš„è¯ï¼‰ï¼Œè¿”å›**æ± ä¸­çš„å¼•ç”¨**

# å¤šçº¿ç¨‹
## ä¸€. åŸºç¡€
### 1. è¿›ç¨‹å’Œçº¿ç¨‹
#### è¿›ç¨‹
ä¸€ä¸ªç¨‹åºè¿è¡Œçš„å®ä¾‹ï¼Œå°†ç¨‹åºçš„æŒ‡ä»¤å’Œæ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œä¸€ä¸ªè¿›ç¨‹å¯ä»¥åŒ…å«å¤šä¸ªçº¿ç¨‹
#### çº¿ç¨‹
çº¿ç¨‹æ¥æ‰§è¡ŒæŒ‡ä»¤ï¼ŒåŒä¸€è¿›ç¨‹ä¸‹çš„çº¿ç¨‹å…±äº«èµ„æºï¼Œåˆ†åˆ«æ‰§è¡Œä»»åŠ¡
#### ä¸Šä¸‹æ–‡åˆ‡æ¢
å½“cupåœ¨æ‰§è¡ŒAçº¿ç¨‹ä»»åŠ¡æ—¶åˆ‡æ¢åˆ°Bçº¿ç¨‹ä¼šä¿å­˜Açº¿ç¨‹è¿è¡Œæ—¶çš„ç¨‹åºå’Œä¸´æ—¶æ•°æ®ï¼Œå¹¶åŠ è½½Bçº¿ç¨‹çš„ç¨‹åºå’Œæ•°æ®
### 2. å¹¶è¡Œå’Œå¹¶å‘
#### å¹¶å‘
åŒä¸€æ—¶é—´åº”å¯¹å¤šä»¶äº‹æƒ…çš„èƒ½åŠ›ï¼Œå¤šä¸ªçº¿ç¨‹è½®æµä½¿ç”¨ä¸€ä¸ªæˆ–å¤šä¸ªcupçš„èƒ½åŠ›
#### å¹¶è¡Œ
åŒä¸€æ—¶é—´åŒæ—¶å¤„ç†å¤šä»¶äº‹æƒ…çš„èƒ½åŠ›ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶ä½¿ç”¨cupçš„èƒ½åŠ›
### 3. åˆ›å»ºçº¿ç¨‹çš„æ–¹å¼
#### å®ç°Runable
```java
public class MyRunable implements Runnable {  
    @Override  
    public void run() {  
        System.out.println("Runnable is running");  
    }  
  
    public static void main(String[] args) {  
        MyRunable runnable = new MyRunable();  
        //æœ¬è´¨ä¸Šæ˜¯Runableä»»åŠ¡äº¤ç»™çº¿ç¨‹å»æ‰§è¡Œ  
        Thread thread = new Thread(runnable);  
        thread.start();  
	        //æ³¨æ„ï¼šå¦‚æœåœ¨åŒä¸€ä¸ªçº¿ç¨‹å¯¹è±¡ä¸Šè°ƒç”¨start()æ–¹æ³•å¤šæ¬¡ï¼Œä¼šæŠ›å‡ºIllegalThreadStateExceptionå¼‚å¸¸ï¼Œå› ä¸ºè¿™ä¸ªçº¿ç¨‹å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå·²ç»ç»“æŸ
        thread.start();  
    }  
}
```
å®ç°Runableæ¥å£å®ç°runæ–¹æ³•ï¼Œäº¤ç»™ä¸€ä¸ªçº¿ç¨‹å¯¹è±¡å»æ‰§è¡Œè¿™ä¸ªä»»åŠ¡
#### ç»§æ‰¿Threadï¼Œä¿®æ”¹runæ–¹æ³•é€»è¾‘
```java
public class MyThread extends Thread {  
    @Override  
    public void run() {
	    //super.run(); æ‰§è¡Œåˆå§‹çš„runé€»è¾‘ä¹Ÿå°±æ˜¯æ‰§è¡Œrunableä»»åŠ¡  
        System.out.println("Thread is running");  
    }  
    public MyThread(Runnable task){  
        super(task);  
    }  
    public MyThread() {  
        super();  
    }  
  
    public static void main(String[] args) {  
        MyThread thread = new MyThread();  
        //æ³¨æ„åˆ°ä¸¤æ¬¡æ‰§è¡Œä»»åŠ¡ï¼Œä¸€æ¬¡æ˜¯é‡å†™çš„runæ–¹æ³•ï¼Œä¸€æ¬¡æ˜¯é€šè¿‡æ„é€ å‡½æ•°ä¼ å…¥çš„Runnableä»»åŠ¡  
        //ä½†æ˜¯ç»“æœéƒ½æ˜¯"Thread is running"ï¼Œå› ä¸ºrunæ–¹æ³•è¢«é‡å†™äº†  
        thread.start();  
        new MyThread(new MyRunable()).start();  
    }  
}
```
ç»§æ‰¿Threadé‡å†™runæ–¹æ³•ï¼Œç„¶åå°±å¯ä»¥å¯åŠ¨è¿™ä¸ªçº¿ç¨‹å¯¹è±¡æ‰§è¡Œrunæ–¹æ³•å†…å®¹ï¼Œå¯ä»¥æ³¨æ„åˆ°ä¸¤æ¬¡çš„æ‰§è¡Œç»“æœä¸€è‡´ï¼Œéƒ½æ˜¯é‡å†™çš„runæ–¹æ³•ï¼Œæ²¡æœ‰æ‰§è¡ŒRunableæ¥å£çš„å®ç°çš„runæ–¹æ³•ï¼Œå› ä¸ºTreadåŸæœ¬çš„startçš„é€»è¾‘å°±æ˜¯åœ¨runæ–¹æ³•å†…æ‰§è¡Œä¸€ä¸ªrunableä»»åŠ¡ï¼Œé€šè¿‡ç»§æ‰¿å®ƒé‡å†™runæ–¹æ³•æŠŠåŸæœ¬çš„runé€»è¾‘è¦†ç›–äº†ï¼Œé€»è¾‘å°±æˆäº†ç›´æ¥æ‰§è¡Œé‡å†™æ–¹æ³•å†…çš„å†…å®¹ï¼Œæ‰€ä»¥Runableçš„runæ²¡æœ‰æ‰§è¡Œ
**æ³¨æ„**
**å¯ä»¥åœ¨é‡å†™çš„runæ–¹æ³•é‡ŒåŠ ä¸Š==super.run()==ï¼Œè¿™æ ·å°±èƒ½æ‰§è¡Œå­ç±»å’Œçˆ¶ç±»çš„ä¸¤ç§runæ–¹æ³•é€»è¾‘äº†**
#### å®ç°Callableæ¥å£
```java
public class MyCallable implements Callable<String> {  
    @Override  
    public String call() throws Exception {  
        return "Callable is running";  
    }  
  
    public static void main(String[] args) throws ExecutionException, InterruptedException {  
        MyCallable callable = new MyCallable();  
        //åˆ›å»ºä¸€ä¸ªå•çº¿ç¨‹æ‰§è¡Œå™¨  
        ExecutorService executorService = Executors.newSingleThreadExecutor();  
        //æäº¤Callableä»»åŠ¡åˆ°æ‰§è¡Œå™¨ï¼Œå¹¶è·å–Futureå¯¹è±¡  
        Future<String> future = executorService.submit(callable);  
        //è·å–Callableä»»åŠ¡çš„æ‰§è¡Œç»“æœ  
        System.out.println(future.get());  
        //æ‰§è¡Œå™¨æ‰§è¡Œå®Œæ¯•åéœ€è¦å…³é—­  
        executorService.shutdown();  
    }  
}
```
Callableä¹Ÿæ˜¯ä¸€ä¸ªçº¿ç¨‹å¯æ‰§è¡Œçš„ä»»åŠ¡ï¼Œä½†æ˜¯éœ€è¦åˆ›å»ºçº¿ç¨‹æ± å¤„ç†å™¨å»å¤„ç†ï¼Œ**å¯ä»¥å¾—åˆ°ä»»åŠ¡è¿”å›çš„ç»“æœ**
#### å¤šçº¿ç¨‹æ‰§è¡Œå™¨
```java
public class MyExecutor implements Runnable{  
    @Override  
    public void run() {  
        System.out.println("Executor is running");  
    }  
  
    public static void main(String[] args) {  
        //åˆ›å»ºä¸€ä¸ªå›ºå®šå¤§å°çš„çº¿ç¨‹æ± æ‰§è¡Œå™¨  
        ExecutorService executorService = Executors.newFixedThreadPool(3);  
        for (int i = 0; i < 10; i++) {  
            //æäº¤ä»»åŠ¡åˆ°æ‰§è¡Œå™¨  
            executorService.submit(new MyExecutor());  
        }  
        executorService.shutdown();  
    }  
}
```
åˆ›å»ºä¸€ä¸ªå›ºå®šå¤§å°çš„çº¿ç¨‹æ± å¤„ç†å™¨ï¼Œæ‰§è¡Œä»»åŠ¡ï¼Œæ³¨æ„åˆ°**çº¿ç¨‹æ± å¤„ç†å™¨å¯ä»¥æ‰§è¡ŒRunableå’ŒCallableä¸¤ç§ä»»åŠ¡**
#### æ³¨æ„
RunbaleæŠ›å‡ºçš„å¼‚å¸¸åªèƒ½åœ¨å†…éƒ¨å¤„ç†ï¼Œä¸å…è®¸ç»§ç»­å‘ä¸ŠæŠ›ï¼Œä½†æ˜¯Callableå¯ä»¥
**Threadçš„startæ–¹æ³•æ˜¯å¼€å¯ä¸€ä¸ªçº¿ç¨‹ï¼Œåœ¨çº¿ç¨‹é‡Œæ‰§è¡Œrunæ–¹æ³•ï¼Œç›´æ¥è¿è¡Œå®ƒçš„runæ–¹æ³•ä¸ä¼šå¼€å¯çº¿ç¨‹ï¼Œå°±åªæ˜¯ä¸€ä¸ªæ™®é€šæ–¹æ³•**
### 4. çº¿ç¨‹çŠ¶æ€
#### NEW
æ–°å»ºçŠ¶æ€ï¼Œæ–°åˆ›å»ºå‡ºæ¥çš„çº¿ç¨‹å¯¹è±¡ï¼Œå°šæœªè°ƒç”¨startæ–¹æ³•å¯åŠ¨
#### RUNNABLE
å¯è¿è¡ŒçŠ¶æ€ï¼Œçº¿ç¨‹å·²ç»å‡†å¤‡å°±ç»ªæ­£åœ¨æŠ¢å¤ºcupçš„æ‰§è¡Œæƒï¼ŒæŠ¢åˆ°äº†å°±èƒ½æ‰§è¡Œä»£ç ï¼Œæ²¡æœ‰æŠ¢åˆ°å¯èƒ½è¿›å…¥å…¶ä»–çŠ¶æ€
#### BLOCKED
é˜»å¡çŠ¶æ€ï¼Œç­‰å¾…è·å¾—é”ï¼Œä¹‹åé‡æ–°è¿›å…¥RUNNABLEçŠ¶æ€
#### WAITING
ç­‰å¾…çŠ¶æ€ï¼Œè¢«å”¤é†’ä¹‹åè¿›å…¥è¿›å…¥RUNNABLEçŠ¶æ€
#### TIMED_WAITING
è®¡æ—¶ç­‰å¾…ï¼Œè®¡æ—¶å®Œæˆè¿›å…¥RUNNABLEçŠ¶æ€
#### TERMINATED
æ‰§è¡Œå®Œæˆï¼Œæ­»äº¡çŠ¶æ€
### 5. çº¿ç¨‹é¡ºåºæ‰§è¡Œ
```java
public class test1 {  
    public static void main(String[] args) {  
        Thread t1 = new Thread(() -> System.out.println("Thread 1 is running"));  
        Thread t2 = new Thread(() -> {  
            try {  
                t1.join();  
            } catch (InterruptedException e) {  
            }  
            System.out.println("Thread 2 is running after Thread 1");  
        });  
        Thread t3 = new Thread(() -> {  
            try {  
                t2.join();  
            } catch (InterruptedException e) {  
            }  
            System.out.println("Thread 3 is running after Thread 2");  
        });  
        t1.start();  
        t2.start();  
        t3.start();  
    }  
}
```
å¯ä»¥åœ¨çº¿ç¨‹ä»»åŠ¡ä¸­ä½¿ç”¨**å…¶ä»–çº¿ç¨‹å¯¹è±¡çš„join()æ–¹æ³•**ï¼Œä½¿å½“å‰çº¿ç¨‹å¤„äºé˜»å¡çŠ¶æ€ï¼Œä¿è¯å½“å‰çº¿ç¨‹ä¼šåœ¨å…¶ä»–çº¿ç¨‹æ‰§è¡Œä¹‹åæ‰æ‰§è¡Œ
### 6. waitå’Œsleep

| ç‰¹æ€§    | `wait()`                            | `sleep()`                  |
| ----- | ----------------------------------- | -------------------------- |
| æ‰€å±ç±»   | `Object` ç±»çš„æ–¹æ³•                       | `Thread` ç±»çš„é™æ€æ–¹æ³•            |
| ä½¿ç”¨å‰æ  | çº¿ç¨‹å¿…é¡»æŒæœ‰è¯¥å¯¹è±¡çš„é”ï¼ˆå³åœ¨ `synchronized` ä»£ç å—å†…ï¼‰ | æ— éœ€ä»»ä½•åŒæ­¥å‰æ                   |
| æ˜¯å¦é‡Šæ”¾é” | âœ… ä¼šé‡Šæ”¾å½“å‰å¯¹è±¡çš„**ç›‘è§†å™¨é”ï¼ˆmonitorï¼‰**         | âŒ ä¸ä¼šé‡Šæ”¾é”                    |
| å”¤é†’æ–¹å¼  | `notify()` / `notifyAll()` æˆ–è¶…æ—¶      | è‡ªåŠ¨åœ¨æŒ‡å®šæ—¶é—´åå”¤é†’                 |
| å¸¸ç”¨åœºæ™¯  | å¤šçº¿ç¨‹åè°ƒï¼ˆå¦‚ç”Ÿäº§è€…/æ¶ˆè´¹è€…ï¼‰                     | ç®€å•çš„å»¶è¿Ÿï¼Œå¦‚å®šæ—¶å™¨ã€è½®è¯¢ã€èŠ‚æµç­‰          |
| æŠ›å‡ºå¼‚å¸¸  | æŠ›å‡º `InterruptedException`           | ä¹ŸæŠ›å‡º `InterruptedException` |
waitæ–¹æ³•å¿…é¡»æ­é…synchronizedä»£ç å—ä½¿ç”¨ï¼Œè°ƒç”¨waitæ–¹æ³•ä¹‹åä¼šé‡Šæ”¾é”ï¼Œè®©å…¶ä»–çº¿ç¨‹å»ä½¿ç”¨ï¼Œ
sleepè°ƒç”¨ä¸ä¼šé‡Šæ”¾é”å°±åªæ˜¯è®©çº¿ç¨‹ç¡è§‰
`notify()` / `notifyAll()`æ–¹æ³•å®é™…ä¸Šæ˜¯é€šçŸ¥æ‰€æœ‰æ­£åœ¨waitã€é˜»å¡åœ¨è¿™ä¸ªé”å¯¹è±¡çš„çº¿ç¨‹å¯ä»¥æŠ¢å é”äº†ï¼Œä½†æ˜¯å…¶ä»–çº¿ç¨‹å¼€å§‹æŠ¢å çš„**å‰ææ˜¯é€šçŸ¥çš„çº¿ç¨‹ä¹‹åè¿›è¡Œäº†waitæˆ–æ‰§è¡Œå®Œäº†synchronizedå†…çš„å†…å®¹ï¼Œé”æ‰ä¼šé‡Šæ”¾**
### 7. åœæ­¢ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹
```java
public class stopThread {  
    public static void main(String[] args) throws InterruptedException {  
        //ä¸­æ–­é˜»å¡çš„çº¿ç¨‹  
        Thread thread = new Thread(() -> {  
            try {  
                Thread.sleep(10000);  //é˜»å¡
            } catch (InterruptedException e) {  
                System.out.println("çº¿ç¨‹è¢«ä¸­æ–­äº†");  
                throw new RuntimeException(e);  
            }  
        });  
        thread.start();  
        Thread.sleep(1000);  
        thread.interrupt();//ç›´æ¥ä¸­æ–­æ­£åœ¨é˜»å¡çš„çº¿ç¨‹ï¼ŒåŒæ—¶ä¼šæŠ›å‡ºå¼‚å¸¸  
  
        //æ‰“æ–­æ­£å¸¸çš„çº¿ç¨‹ï¼Œå®é™…ä¸Šæ˜¯æ”¹å˜çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ï¼Œæ¥é€€å‡ºçº¿ç¨‹çš„ä»£ç   
        Thread thread1 = new Thread(() -> {  
            while (true) {  
                boolean interrupted = Thread.currentThread().isInterrupted();  
                if (interrupted) {  
                    System.out.println("çŠ¶æ€è¢«ä¸­æ–­äº†");  
                    break;  
                }  
            }  
        });  
        thread1.start();  
        Thread.sleep(1000);  
        thread1.interrupt();  
    }  
}
```
## äºŒ. çº¿ç¨‹å®‰å…¨
### 1. synchronized
`synchronized` çš„å®ç°ä¾èµ– JVM ä¸­çš„**å¯¹è±¡å¤´ï¼ˆMark Wordï¼‰å’ŒMonitorï¼ˆç›‘è§†å™¨é”ï¼‰**
#### Mark Word
| ä½æ•°ï¼ˆ64-bit JVMï¼‰ | å†…å®¹è¯´æ˜                     |
| -------------- | ------------------------ |
| 25 bits        | å¯¹è±¡å“ˆå¸Œç ï¼ˆhashcodeï¼‰          |
| 4 bits         | GC åˆ†ä»£å¹´é¾„                  |
| 1 bit          | æ˜¯å¦æ˜¯åå‘é”æ ‡å¿—                 |
| 2 bits         | é”æ ‡å¿—ä½ï¼ˆè½»é‡é”ã€åå‘é”ã€é‡é‡é”ã€æ— é”ï¼‰     |
| 32/64 bits     | æŒ‡å‘ Monitor çš„æŒ‡é’ˆæˆ–çº¿ç¨‹IDï¼ˆé”ç«äº‰ï¼‰ |

|çŠ¶æ€|Mark Word å†…å®¹|
|---|---|
|æ— é”|å¯¹è±¡Hashcodeã€GCåˆ†ä»£å¹´é¾„ç­‰|
|åå‘é”|ThreadID + Epochæ—¶é—´æˆ³ + åå‘é”æ ‡å¿—|
|è½»é‡é”|æŒ‡å‘çº¿ç¨‹æ ˆä¸­ Lock Record çš„æŒ‡é’ˆï¼ˆå³ Mark Word è¢«çº¿ç¨‹å ç”¨ï¼‰|
|é‡é‡é”|æŒ‡å‘ Monitor å¯¹è±¡çš„æŒ‡é’ˆ|
|GCæ ‡è®°|ä¸“é—¨ç»™ GC æš‚ç”¨ï¼Œè¡¨ç¤ºå¯¹è±¡æ˜¯å¦å¯å›æ”¶ç­‰ä¿¡æ¯|
#### å››ç§é”çš„çŠ¶æ€
|é”çŠ¶æ€|çº¿ç¨‹å®‰å…¨|æ€§èƒ½|ç‰¹ç‚¹|
|---|---|---|---|
|æ— é”|å¦|é«˜|æ™®é€šå¯¹è±¡|
|åå‘é”|æ˜¯|é«˜|é€‚ç”¨äºçº¿ç¨‹ä¸ç«äº‰|
|è½»é‡é”|æ˜¯|ä¸­|é€‚ç”¨äºçº¿ç¨‹é—´å­˜åœ¨å°‘é‡ç«äº‰|
|é‡é‡é”|æ˜¯|ä½|å¤šçº¿ç¨‹ç«äº‰æ¿€çƒˆ|#
##### åå‘é”
- åœ¨jdk1.6ä¹‹åå¼•å…¥
- é¦–æ¬¡åŠ é”æ—¶çº¿ç¨‹ä¼šå°†è‡ªå·±çš„Thread Idå†™å…¥å¯¹è±¡çš„å¯¹è±¡å¤´ä¸­
- ä¹‹åå¦‚æœæ²¡æœ‰å…¶ä»–çº¿ç¨‹ä½¿ç”¨è¿™ä¸ªé”ï¼Œè¿™ä¸ªé”å°±åå‘è¿™ä¸ªçº¿ç¨‹ï¼Œå³å½“åŠ é”çš„çº¿ç¨‹å†æ¬¡ç”³è¯·åŠ é”æ—¶ä¼šç›´æ¥æˆåŠŸçœå»äº†æ£€æŸ¥å’ŒåŠ é”çš„æ—¶é—´
- å½“å¦ä¸€ä¸ªçº¿ç¨‹å°è¯•è·å–é”æ—¶ï¼Œåå‘é”æ’¤é”€ï¼Œä¼šå°†é”å‡çº§ä¸ºè½»é‡é”
##### è½»é‡é”
- ç”¨äºçº¿ç¨‹ä¹‹é—´äº¤æ›¿è¿›è¡Œå¹¶æ— çœŸæ­£å†²çªæƒ…å†µå‘ç”Ÿ
- çº¿ç¨‹åˆ›å»ºLock Recordï¼ˆé”è®°å½•ï¼Œæ‹·è´äº†Mark Wordï¼‰å…¥è‡ªå·±çš„æ ˆ
- CASå°è¯•å°†å¯¹è±¡å¤´æ›¿æ¢æˆLock Recordåœ°å€ï¼Œå³é”æ ‡è®°ä¸ºè½»é‡é”
- å¦‚æœå¤±è´¥ï¼Œåˆ™è¿›å…¥ç«äº‰é˜Ÿåˆ—ï¼Œå‡çº§ä¸ºé‡é‡é”
##### é‡é‡é”
- å¤šçº¿ç¨‹ç«äº‰æ—¶å‡çº§ä¸ºé‡é‡é”
- çº¿ç¨‹å¤„äºé˜»å¡çŠ¶æ€ï¼Œä¼šæ¶ˆè€—å¤§é‡èµ„æº
#### Montior
**å®ç°äº†é‡é‡é”**
```c
ObjectMonitor {
    Object* object;       // æŒ‡å‘è¢«é”å®šçš„å¯¹è±¡
    Thread* owner;        // æ‹¥æœ‰è€…çº¿ç¨‹
    int     recursions;   // é‡å…¥æ¬¡æ•°
    List    EntryList;    // ç«äº‰é˜Ÿåˆ—ï¼ˆé˜»å¡çº¿ç¨‹ï¼‰
    List    WaitSet;      // ç­‰å¾…é˜Ÿåˆ—ï¼ˆwaitçº¿ç¨‹ï¼‰
}
```
åœ¨ `synchronized(obj)` ä¸­ï¼ŒJVM ä¼šæ‰§è¡Œä»¥ä¸‹åŠ¨ä½œï¼š
- CASå°è¯•å°†Lock Recordçš„åœ°å€å’Œobjçš„å¯¹è±¡å¤´è¿›è¡Œäº¤æ¢
- å¦‚æœæˆåŠŸï¼Œçº¿ç¨‹æŒæœ‰é”
- å¦‚æœå¤±è´¥ï¼Œè¿›å…¥ç«äº‰é˜Ÿåˆ—ç­‰å¾…æŒæœ‰è€…é‡Šæ”¾é”ï¼Œæ­¤æ—¶å°±ä¼šå‡çº§ä¸ºé‡é‡é”
##### é‡å…¥é”
Montiorè®°å½•äº†å½“å‰æŒæœ‰é”çš„çº¿ç¨‹å’Œé‡å…¥æ¬¡æ•°ï¼Œå¦‚æœæŒæœ‰çš„çº¿ç¨‹å†æ¬¡ç”³è¯·è·å¾—é”ï¼Œä¼šå¢åŠ é‡å…¥æ¬¡æ•°
### 2. JMMå†…å­˜ç»“æ„
æ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„å·¥ä½œç©ºé—´ï¼Œåœ¨è‡ªå·±çš„å·¥ä½œç©ºé—´çš„å˜é‡æ˜¯æ²¡æœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜çš„ï¼Œç©ºé—´ä¸­è¿˜ä¼šæœ‰å¼•ç”¨ä¸»çº¿ç¨‹å˜é‡çš„å‰¯æœ¬ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹å¯¹ä¸»çº¿ç¨‹çš„å˜é‡ä¿®æ”¹ä¹‹åä¼šå°†æ•°æ®åŒæ­¥åˆ°ä¸»çº¿ç¨‹ï¼Œä¹‹åç”±ä¸»çº¿ç¨‹æŠŠæ•°æ®åŒæ­¥åˆ°å…¶ä»–å¼•ç”¨äº†è¿™ä¸ªä¸»çº¿ç¨‹å˜é‡çš„çº¿ç¨‹
### 3. CAS
å…¨ç§°æ˜¯compare and swapå…ˆæ¯”è¾ƒå†äº¤æ¢ï¼Œé‡‡ç”¨çš„æ˜¯**ä¹è§‚é”çš„æ€æƒ³**ï¼Œåœ¨æ— é”çŠ¶æ€ä¸‹ä¿è¯çº¿ç¨‹æ“ä½œçš„åŸå­æ€§
å½“ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†å…±äº«å˜é‡ä¹‹åï¼Œå…ˆä¼šå°†**ä¿®æ”¹å‰çš„æ•°æ®å’Œä¸»å†…å­˜çš„å…±äº«å˜é‡æ¯”è¾ƒ**ï¼Œå¦‚æœä¸€æ ·åˆ™æŠŠä¿®æ”¹åçš„æ•°æ®è¿›è¡ŒåŒæ­¥ï¼Œå¦‚æœä¸ä¸€æ ·åˆ™è¿›è¡Œè‡ªæ—‹ï¼Œå³**é‡æ–°æ‹‰å–ä¸»å­˜é‡Œçš„å…±äº«å˜é‡ç„¶åé‡æ–°æ“ä½œä¿®æ”¹ä¹‹åé‡æ–°æ¯”è¾ƒ**è¿™ä¸ªè¿‡ç¨‹
#### ä¹è§‚é”
è®¤ä¸ºå…¶ä»–çº¿ç¨‹ä¸€èˆ¬ä¸ä¼šä¿®æ”¹ï¼Œæ‰€ä»¥ä¸åŠ é”ï¼Œåœ¨æäº¤çš„æ—¶å€™å†éªŒè¯æ•°æ®æœ‰æ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹è¿‡
#### æ‚²è§‚é”
å§‹ç»ˆè®¤ä¸ºå…¶ä»–çº¿ç¨‹ä¼šæ¥ä¿®æ”¹å˜é‡ï¼Œæ‰€ä»¥æ¯æ¬¡æ“ä½œä¹‹å‰å…ˆåŠ é”ï¼Œç¡®ä¿å½“å‰çº¿ç¨‹ç‹¬å èµ„æºï¼Œå…¶ä»–çº¿ç¨‹ç­‰å¾…æˆ–é˜»å¡ï¼Œç›´åˆ°é”é‡Šæ”¾
### 4. volatile
#### çº¿ç¨‹å¯è§æ€§
```java
import java.util.concurrent.atomic.AtomicInteger;  
  
public class test {  
    static volatile Integer i = 0;  
//    static Integer i = 0;  
  
    public static void main(String[] args) {  
        new Thread(() -> {  
            try {  
                Thread.sleep(100);  
                i = 1;  
            } catch (InterruptedException e) {  
                throw new RuntimeException(e);  
            }  
        }, "t1").start();  
  
        new Thread(() -> {  
            try {  
                Thread.sleep(500);  
                System.out.println("i = " + i);  
            } catch (InterruptedException e) {  
                throw new RuntimeException(e);  
            }  
        }, "t2").start();  
  
        new Thread(() -> {  
            int j = 0;
            //å˜é‡çš„ä¿®æ”¹å¯¹äºå…¶ä»–çº¿ç¨‹æ˜¯å¯è§çš„  
            while (i != 1) {  //å¯¹äºå…±äº«å˜é‡çš„åˆ¤æ–­å¯ä»¥ä¼šè¢«JITç›´æ¥ä¼˜åŒ–æˆtrueæˆ–false
                j++;  
            }  
        }, "t3").start();  
    }  
  
}
```
è¢«volatileä¿®é¥°çš„å˜é‡åœ¨çº¿ç¨‹ä¹‹é—´æ˜¯å¯è§çš„ï¼ŒåŒ…æ‹¬ä¿®æ”¹ä¹‹åçš„æ–°å€¼ä¹Ÿæ˜¯å¯è§çš„ï¼Œå®ƒå¯ä»¥ç¦æ­¢JITå¯¹ä¿®é¥°å˜é‡çš„ä»£ç ä¼˜åŒ–
#### ç¦æ­¢æŒ‡ä»¤é‡æ’åº
ä½¿ç”¨volatileä¿®é¥°çš„å˜é‡ä¼šåœ¨è¯»å†™æ—¶åŠ å…¥ä¸åŒçš„å±éšœï¼Œå¯¹äºå†™æ“ä½œï¼Œå˜é‡ä¹‹å‰çš„å†™ä¸èƒ½å‘ä¸‹æ‰§è¡Œï¼Œå¯¹äºè¯»æ“ä½œï¼Œå˜é‡ä¹‹åçš„ä¸èƒ½å‘ä¸Šæ‰§è¡Œï¼Œé˜»æ­¢å…¶ä»–è¯»å†™æ“ä½œè¶Šè¿‡å±éšœ
### 5. AQS
å…¨ç§°æ˜¯ `AbstractQueuedSynchronizer`ï¼Œæ˜¯ JDK æä¾›çš„ä¸€ä¸ª**ç”¨äºæ„å»ºé”å’ŒåŒæ­¥å™¨çš„æ¡†æ¶**ï¼Œå®ƒé€šè¿‡ä¸€ä¸ª**FIFO çš„ç­‰å¾…é˜Ÿåˆ—ï¼ˆCLH é˜Ÿåˆ—å˜ç§ï¼‰+ ä¸€ä¸ªåŸå­çŠ¶æ€å­—æ®µ state** æ¥å®ç°çº¿ç¨‹çš„é˜»å¡ä¸å”¤é†’
#### æˆå‘˜å˜é‡å’Œæ–¹æ³•
```java
//AbstractQueuedSynchronizerçš„å†…éƒ¨ç±»ï¼Œæ¯ä¸€ä¸ªæ²¡æœ‰æŠ¢åˆ°é”çš„çº¿ç¨‹éƒ½ä¼šå°è£…æˆä¸€ä¸ªnodeèŠ‚ç‚¹
abstract static class Node {
	//å‰é©±èŠ‚ç‚¹
    volatile Node prev;
    //åç»§èŠ‚ç‚¹       
    volatile Node next;      
    //æ­£åœ¨ç­‰å¾…çš„èŠ‚ç‚¹
    Thread waiter; 
    //èŠ‚ç‚¹çš„çŠ¶æ€å­—æ®µï¼Œå¦‚ä¸å†ç­‰å¾…ã€ç«äº‰ï¼Œåç»§èŠ‚ç‚¹éœ€è¦è¢«å”¤é†’
    volatile int status;
}
```
```java
//FIFOç­‰å¾…é˜Ÿåˆ—ï¼Œé˜Ÿå¤´èŠ‚ç‚¹
private transient volatile Node head;  

//é˜Ÿå°¾èŠ‚ç‚¹
private transient volatile Node tail;  

//çŠ¶æ€å­—æ®µï¼Œåœ¨ä¸åŒçš„å­ç±»æœ‰ä¸åŒçš„å«ä¹‰
private volatile int state;  

//è¯»å†™stateå­—æ®µçš„åŸå­æ“ä½œæ–¹æ³•
protected final int getState() {  
    return state;  
}  
  
protected final void setState(int newState) {  
    state = newState;  
}  
//CASåŸå­ä¿®æ”¹  
protected final boolean compareAndSetState(int expect, int update) {  
    return U.compareAndSetInt(this, STATE, expect, update);  
}
```
- statuså­—æ®µå¯¹äºä¸åŒçš„å­ç±»æœ‰ä¸åŒçš„å«ä¹‰
	- å¯¹äº `ReentrantLock`ï¼šstate è¡¨ç¤ºåŠ é”çš„æ¬¡æ•°ï¼ˆé‡å…¥æ¬¡æ•°ï¼‰
		- 0ï¼Œé”æ˜¯ç©ºé—²çš„
		- 1ï¼Œé”è¢«ä¸€ä¸ªçº¿ç¨‹å ç”¨
		- >1ï¼Œé‡å…¥æ¬¡æ•°ï¼Œä¸€ä¸ªçº¿ç¨‹å¤šæ¬¡è·å¾—é”
	- å¯¹äº `Semaphore`ï¼šstate è¡¨ç¤ºå½“å‰å¯ç”¨çš„è®¸å¯è¯æ•°é‡
- å½“ä¸€ä¸ªçº¿ç¨‹è·å–èµ„æºå¤±è´¥åï¼Œä¼šè¢«æ„é€ æˆä¸€ä¸ªnodeèŠ‚ç‚¹æ’å…¥FIFOåŒå‘ç­‰å¾…é˜Ÿåˆ—çš„å°¾éƒ¨
- å½“å‰æŒæœ‰é”çš„çº¿ç¨‹é‡Šæ”¾é”ä¹‹åä¼šå”¤é†’headçš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè®©å®ƒå»è·å–èµ„æºï¼Œè·å–èµ„æºåï¼Œè¿™ä¸ªçº¿ç¨‹æˆä¸ºæ–°çš„head
- å¯¹äºReentrantLockï¼ˆCILé˜Ÿåˆ—åŠ AQSï¼‰æœ‰ä¸¤ç§é”ï¼Œéå…¬å¹³é”ï¼Œå³é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹å’Œé˜Ÿåˆ—å¤–çš„çº¿ç¨‹èƒ½ä¸€èµ·æŠ¢å èµ„æºï¼Œå…¬å¹³é”ï¼Œåªæœ‰é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹èƒ½æŠ¢å é”
```txt
å°è¯•è·å–é”
  â†“å¤±è´¥
æ„é€ Nodeå¹¶å…¥é˜Ÿ
  â†“
è®¾ç½®å‰é©±çŠ¶æ€ä¸º SIGNAL
  â†“
æŒ‚èµ·å½“å‰çº¿ç¨‹ï¼ˆLockSupport.parkï¼‰
  â†“
è¢«å”¤é†’åé‡æ–°å°è¯•è·å–é”

```
#### ä¸¤ç§é”æ¨¡å¼åŠå¯¹åº”çš„æŠ½è±¡æ–¹æ³•
##### ç‹¬å æ¨¡å¼
```java
protected boolean tryAcquire(int arg) // ç‹¬å å¼è·å–èµ„æº
protected boolean tryRelease(int arg) // ç‹¬å å¼é‡Šæ”¾èµ„æº
```
ç”±ä¸€ä¸ªçº¿ç¨‹å æœ‰é”ï¼Œå…¶ä»–çº¿ç¨‹ç­‰å¾…æˆ–é˜»å¡
##### å…±äº«æ¨¡å¼
```java
protected int tryAcquireShared(int arg) // å…±äº«å¼è·å–èµ„æº
protected boolean tryReleaseShared(int arg) // å…±äº«å¼é‡Šæ”¾èµ„æº
```
å¤šä¸ªçº¿ç¨‹å…±äº«èµ„æº
### 6. synchronizedå’ŒLockçš„åŒºåˆ«
| å¯¹æ¯”ç»´åº¦          | `synchronized`                  | `Lock`ï¼ˆå¦‚ `ReentrantLock`ï¼‰                      |
| ------------- | ------------------------------- | ---------------------------------------------- |
| **åŸºæœ¬ç”¨é€”**      | å†…ç½®å…³é”®å­—ï¼Œç”¨äºåŠ é”åŒæ­¥ä»£ç å—æˆ–æ–¹æ³•              | æ˜¾å¼é”ï¼Œé€šè¿‡è°ƒç”¨ `lock()` å’Œ `unlock()` æ§åˆ¶              |
| **ä½¿ç”¨æ–¹å¼**      | éšå¼è·å–ä¸é‡Šæ”¾é”ï¼ˆJVM è‡ªåŠ¨ç®¡ç†ï¼‰              | éœ€æ˜¾å¼è·å–ä¸é‡Šæ”¾ï¼Œä»£ç æ›´çµæ´»ä½†ä¹Ÿéœ€æ›´å°å¿ƒ                           |
| **ç±»åˆ«**        | æ‚²è§‚é”                             | æ‚²è§‚é”                                            |
| **å¯é‡å…¥æ€§**      | æ”¯æŒï¼Œå¯é‡å…¥ï¼ˆåŒä¸€çº¿ç¨‹å¯ä»¥å¤šæ¬¡è¿›å…¥ï¼‰              | æ”¯æŒï¼Œå¯é‡å…¥ï¼ˆ`ReentrantLock` å°±æ˜¯å¯é‡å…¥é”ï¼‰                 |
| **å¯ä¸­æ–­æ€§**      | ä¸æ”¯æŒä¸­æ–­ç­‰å¾…é”çš„çº¿ç¨‹                     | æ”¯æŒä¸­æ–­ç­‰å¾…ï¼ˆ`lockInterruptibly()`ï¼‰                  |
| **æ˜¯å¦å…¬å¹³é”**     | ä¸æ”¯æŒå…¬å¹³æ€§é€‰æ‹©ï¼ˆé»˜è®¤éå…¬å¹³ï¼‰                 | å¯é€‰æ‹©å…¬å¹³æˆ–éå…¬å¹³ï¼ˆæ„é€ å‡½æ•°ä¸­æŒ‡å®šï¼‰                             |
| **æ˜¯å¦å¯å®šæ—¶**     | ä¸æ”¯æŒè¶…æ—¶ç­‰å¾…é”                        | æ”¯æŒè¶…æ—¶ç­‰å¾…ï¼ˆ`tryLock(long timeout)`ï¼‰                |
| **è¯»å†™é”æ”¯æŒ**     | ä¸æ”¯æŒè¯»å†™åˆ†ç¦»                         | æ”¯æŒï¼ˆé€šè¿‡ `ReentrantReadWriteLock`ï¼‰                |
| **æ¡ä»¶å˜é‡æ”¯æŒ**    | ä¸æ”¯æŒ                             | æ”¯æŒå¤šä¸ª `Condition` å¯¹è±¡ç”¨äºçº¿ç¨‹é—´é€šä¿¡ï¼ˆæ¯” `wait/notify` çµæ´»ï¼‰ |
| **æ€§èƒ½è¡¨ç°ï¼ˆè½»è½½ï¼‰**  | ç”±äºæ˜¯ JVM å†…ç½®é”ï¼Œåœ¨ä½ç«äº‰ä¸‹æ€§èƒ½ä¼˜ç§€           | ç•¥é€Šè‰²äº synchronizedï¼Œéœ€é¢å¤–ç»´æŠ¤çŠ¶æ€                      |
| **æ€§èƒ½è¡¨ç°ï¼ˆé«˜ç«äº‰ï¼‰** | JVM ä¼˜åŒ–æœ‰é™ï¼ˆä½†ä» JDK1.6 å¼€å§‹å¼•å…¥åå‘é”ã€è½»é‡é”ï¼‰ | ä½¿ç”¨ AQS é«˜æ€§èƒ½é˜Ÿåˆ—æ”¯æŒï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹è¡¨ç°æ›´ä½³                     |
| **å†…å­˜å¼€é”€**      | æ— éœ€æ˜¾å¼å¯¹è±¡å¼€é”€ï¼Œè¯­æ³•çº§åˆ«æ”¯æŒ                 | éœ€è¦ç»´æŠ¤é”å¯¹è±¡å’Œå†…éƒ¨çŠ¶æ€ï¼Œå¼€é”€ç•¥é«˜                              |
| **é€‚ç”¨åœºæ™¯**      | ç®€å•åŒæ­¥åœºæ™¯ï¼Œä»£ç ç®€æ´                     | å¯¹å¹¶å‘è¡Œä¸ºæ§åˆ¶è¦æ±‚æ›´é«˜çš„åœºæ™¯ï¼ˆä¸­æ–­ã€å…¬å¹³ã€å®šæ—¶ç­‰ï¼‰                      |
##### lockå¯æ‰“æ–­
```java
public static void main(String[] args) throws InterruptedException {  
    ReentrantLock lock = new ReentrantLock();  
    Thread t1 = new Thread(() -> {  
            try {  
                lock.lockInterruptibly();  
            } catch (InterruptedException e) {  
                System.out.println("ç­‰å¾…è·å–é”çš„è¿‡ç¨‹ä¸­è¢«ä¸­æ–­äº†");  
                throw new RuntimeException(e);  
            }  
            try{  
                System.out.println("è·å–é”æˆåŠŸï¼Œå¼€å§‹æ‰§è¡Œä»»åŠ¡");  
            }finally {  
                lock.unlock();  
            }  
    }, "t1");  
    lock.lock();  
    t1.start();  
    Thread.sleep(1000);  
    t1.interrupt();//ç›´æ¥æ‰“æ–­çº¿ç¨‹  
}
```
`lock.lockInterruptibly()`ä¼šé˜»å¡ç­‰å¾…è·å–é”ï¼Œä½†æ˜¯å¯ä»¥è¢«çº¿ç¨‹çš„ä¸­æ–­è€Œæ‰“æ–­

##### lockè¶…æ—¶ç­‰å¾…
```java
public static void main(String[] args) throws InterruptedException {  
    ReentrantLock lock = new ReentrantLock();  
    Thread t1 = new Thread(() -> {  
        try {  
	        //lock.tryLock()æ— å‚æ–¹æ³•ï¼Œåªå°è¯•è·å–ä¸€æ¬¡é”ï¼Œä¸ä¼šé˜»å¡ç­‰å¾…ï¼Œä¸ä¼šé‡å¤å°è¯•
            if (!lock.tryLock(2, TimeUnit.SECONDS)) {// å°è¯•è·å–é”ï¼Œæœ€å¤šç­‰å¾…2ç§’  
                System.out.println("å°è¯•è·å–é”å¤±è´¥");  
                return;  
            }  
        } catch (InterruptedException e) {  
            throw new RuntimeException(e);  
        }  
        try {  
            System.out.println("çº¿ç¨‹1è·å–é”æˆåŠŸ");  
        } finally {  
            lock.unlock();  
            System.out.println("çº¿ç¨‹1é‡Šæ”¾é”");  
        }  
    }, "çº¿ç¨‹1");  
    lock.lock();  
    t1.start();  
    Thread.sleep(3000);//è¶…å‡ºç­‰å¾…æ—¶é—´  
}
```
`lock.tryLock()`åªå°è¯•è·å–ä¸€æ¬¡é”ï¼Œä¸ä¼šé˜»å¡ç­‰å¾…
`lock.tryLock(2, TimeUnit.SECONDS)`åœ¨æŒ‡å®šæ—¶é—´å†…è·å–é”ï¼Œè¶…æ—¶ä¹‹åä¸ä¼šå†æ¬¡å°è¯•è·å–ï¼Œä¸ä¼šé˜»å¡

##### lockæ¡ä»¶å˜é‡
```java
public static void main(String[] args) throws InterruptedException {  
    ReentrantLock lock = new ReentrantLock();  
    Condition c1 = lock.newCondition();  
    Condition c2 = lock.newCondition();  
    Thread t1 = new Thread(() -> {  
        lock.lock();  
        System.out.println("t1è·å¾—é”");  
        try {  
            c1.await();//ç›¸å½“äºæ˜¯synchronizedçš„waitæ–¹æ³•ä¼šé‡Šæ”¾é”  
            System.out.println("t1è¢«å”¤é†’");  
            lock.unlock();  
        } catch (InterruptedException e) {  
            throw new RuntimeException(e);  
        }  
    });  
    Thread t2 = new Thread(() -> {  
        lock.lock();  
        System.out.println("t2è·å¾—é”");  
        try {  
            c2.await();//ç›¸å½“äºæ˜¯synchronizedçš„waitæ–¹æ³•ä¼šé‡Šæ”¾é”  
            System.out.println("t2è¢«å”¤é†’");  
            lock.unlock();  
        } catch (InterruptedException e) {  
            throw new RuntimeException(e);  
        }  
    });  
    Thread t3 = new Thread(() -> {  
        lock.lock();  
        c1.signal();  
        c2.signal();  
        lock.unlock();//é‡Šæ”¾é”  
    });  
    t1.start();  
    t2.start();  
    TimeUnit.SECONDS.sleep(1000); // ç¡®ä¿t1å’Œt2å·²ç»å¼€å§‹å¹¶ç­‰å¾…  
    t3.start();  
}
```
#### lockçš„è¯»å†™é”
```java
ReentrantReadWriteLock lock = new ReentrantReadWriteLock();
Lock readLock = lock.readLock();
Lock writeLock = lock.writeLock();

// è·å–è¯»é”ï¼Œå¯ä»¥å¤šä¸ªçº¿ç¨‹æ‹¥æœ‰
readLock.lock();
readLock.unlock();

// è·å–å†™é”ï¼Œåªèƒ½ä¸€ä¸ªçº¿ç¨‹æ‹¥æœ‰
writeLock.lock();
writeLock.unlock();
```
å½“çº¿ç¨‹å æœ‰å†™é”æ—¶å…¶ä»–çº¿ç¨‹ä¸èƒ½å æœ‰å†™é”æˆ–è¯»é”ï¼Œå æœ‰è¯»é”æ—¶å…¶ä»–çº¿ç¨‹å¯ä»¥å…±äº«è¯»é”
### 7. æ­»é”
å½“å¤šä¸ªçº¿ç¨‹æŒæœ‰ã€æŠ¢å¤ºå¤šä¸ªé”æ—¶æœ‰å¯èƒ½æŠ¢å¤ºçš„é”æ˜¯åˆ«çš„çº¿ç¨‹æ­£åœ¨æŒæœ‰çš„ï¼Œé€ æˆæ­»é”
```cmd
jps
jstack -l[çº¿ç¨‹å·]
```
åœ¨jvmç»ˆç«¯è¿è¡Œå‘½ä»¤æŸ¥çœ‹çº¿ç¨‹å æœ‰é”çš„æƒ…å†µ
æˆ–è€…ä½¿ç”¨jdk/binçš„jconoslç¨‹åºæŸ¥çœ‹æˆ–visualVM
### 8. ConcurrentHashMap
åœ¨jdk1.7ä¹‹å‰æ˜¯æ•°ç»„åŠ é“¾è¡¨çš„ç»“æ„ï¼Œåœ¨ä¹‹åæ˜¯å’ŒHashhMapä¸€æ ·çš„ç»“æ„
#### 1.7ConcurrentHashMap
```txt
ConcurrentHashMap
      |
      v
+----------------------------+
|        Segment[]          |   ï¼ˆé»˜è®¤é•¿åº¦ 16ï¼‰
+----------------------------+
     |       |       |
     v       v       v
  Segment  Segment  Segment  ...
     |
     v
+------------------------+
|      HashEntry[]      |     ï¼ˆæ¯ä¸ª Segment å†…éƒ¨ä¸€ä¸ªæ¡¶æ•°ç»„ï¼‰
+------------------------+
     |      |      |
     v      v      v
  Entry   Entry   Entry   ...
    â†“
  Entry
    â†“
  Entry
ï¼ˆé“¾è¡¨ç»“æ„ï¼‰
```
- æ’å…¥æˆ–æ‰©å®¹ä½¿ç”¨çš„**åªæœ‰ReentrantLock**
- Segmentçš„æ¯ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ª`HashEntry[]`æ•°ç»„çœŸæ­£å­˜å‚¨æ•°æ®
- å®ƒçš„æ¯ä¸ªå…ƒç´ å­˜å‚¨æ¡¶ï¼ŒSegmentæ•°ç»„æ— æ³•æ‰©å®¹ï¼Œä½†æ˜¯`HashEntry[]`æ˜¯å¯ä»¥æ‰©å®¹çš„
- æ’å…¥æ•°æ®æˆ–æ‰©å®¹æ—¶ç›´æ¥é”ä½çš„æ˜¯ä¸€ä¸ªSegmentå…ƒç´ ä¹Ÿå°±æ˜¯ä¸€æ•´ä¸ª`HashEntry[]`æ•°ç»„ï¼Œæ€§èƒ½ä½ä¸‹
#### 1.8ConcurrentHashMap
```txt
ConcurrentHashMap
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                   table                                    â”‚
â”‚                      (Node<K,V>[]ï¼Œé•¿åº¦ä¸º2çš„å¹‚æ¬¡)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Node0  â”‚ Node1  â”‚ Node2  â”‚ Node3  â”‚ Node4  â”‚ Node5  â”‚ Node6  â”‚ Node7  â”‚ ...
â”‚  â†“         â†“        â†“        â†“        â†“        â†“        â†“        â†“
â”‚ é“¾è¡¨/æ ‘  é“¾è¡¨/ç©º  ç©º      é“¾è¡¨     æ ‘      ç©º      é“¾è¡¨     ç©º
â”‚         â†‘       â†‘                â†‘      â†‘              â†‘
â”‚       (CAS+é”æœºåˆ¶ï¼ŒèŠ‚ç‚¹æ‰©å®¹/æ’å…¥æ—¶äº’ä¸é˜»å¡ï¼Œåˆ†æ®µæ§åˆ¶)        ...
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
```java
static class Node<K,V> implements Map.Entry<K,V> {
    final int hash;      // keyçš„å“ˆå¸Œå€¼
    final K key;
    volatile V val;      // volatileä¿è¯å¯è§æ€§
    volatile Node<K,V> next; // é“¾è¡¨ç»“æ„ or çº¢é»‘æ ‘ TreeNode
}
```
å†…éƒ¨èŠ‚ç‚¹çš„ç»“æ„å’ŒHashMapçš„nodeä¸åŒï¼Œvalå’ŒnextæŒ‡é’ˆæ˜¯volatileä¿®é¥°çš„çº¿ç¨‹å¯è§
- æ’å…¥æˆ–æ‰©å®¹è¿‡ç¨‹é€šè¿‡ **CAS + synchronizedï¼ˆé”åˆ†æ®µï¼‰** ä¿è¯çº¿ç¨‹å®‰å…¨å’Œæ€§èƒ½
- åœ¨æ’å…¥æˆ–ä¿®æ”¹çš„æ—¶å€™å…ˆç”¨CASè¿›è¡Œæ“ä½œï¼Œä¾‹å¦‚åœ¨æ’å…¥æ—¶ï¼Œå¦‚æœæ¡¶ä¸ºç©ºï¼Œåˆ™CASç›´æ¥æˆåŠŸ
- å¦‚æœCASå¤±è´¥ï¼Œåˆ™æŠŠæ¡¶çš„é“¾è¡¨çš„å¤´ç»“ç‚¹æˆ–çº¢é»‘æ ‘çš„æ ¹èŠ‚ç‚¹ç”¨synchronizedé”ä½å†æ“ä½œ
- **åœ¨æ‰©å®¹æ—¶å¿…å®šä¼šä½¿ç”¨synchronized**ï¼Œå› ä¸ºä¼šä½¿ç”¨**å¤šçº¿ç¨‹æ¥è¿›è¡Œæ•°æ®è¿ç§»**ï¼Œæ¯ä¸ªçº¿ç¨‹åˆ†é…ä¸€æ®µ**æ¡¶åŒºé—´**ï¼Œä¸€ä¸ªçº¿ç¨‹åœ¨å¤„ç†åŒºé—´çš„æ—¶å€™ä¼šç”¨synchronizedé”ä½å½“å‰éå†åˆ°çš„æ¡¶èŠ‚ç‚¹ï¼Œä¿è¯ä¸€ä¸ªæ¡¶åªèƒ½ç”±ä¸€ä¸ªçº¿ç¨‹æ¥æ“ä½œ
	- åœ¨æ•°æ®è¿ç§»è¿‡ç¨‹åœ¨å¦‚æœä¸€ä¸ªæ¡¶çš„æ•°æ®å·²ç»è¿ç§»å®Œæˆï¼Œåˆ™ä¼šå°†è¿™ä¸ªæ¡¶æ›¿æ¢æˆForwardingNodeï¼Œå®ƒå¹¶ä¸å­˜å‚¨æ•°æ®ï¼Œåªæ˜¯æ ‡è®°è¿™ä¸ªæ¡¶å·²ç»å®Œæˆè¿ç§»ï¼Œå…¶ä»–çº¿ç¨‹é‡åˆ°è¿™ä¸ªForwardingNodeå°±ä¼šç›´æ¥è·³è¿‡
- åœ¨**é“¾è¡¨è½¬æ¢æˆçº¢é»‘æ ‘**çš„æ—¶å€™ä¹Ÿä¼šæœ‰**synchronized**é”ä½æ“ä½œè¿‡ç¨‹

|æ“ä½œ|CAS|synchronized|
|---|---|---|
|get()|âŒ|âŒ|
|put() ç©ºæ¡¶æ’å…¥|âœ… å°è¯•CAS|âŒ|
|put() éç©ºæ¡¶æ’å…¥|âŒ|âœ… é”ä½æ¡¶å¤´èŠ‚ç‚¹|
|put() æ›´æ–°å·²æœ‰key|âŒ|âœ… éå†éœ€è¦é”ï¼Œèµ‹å€¼æœ¬èº«æ— éœ€é”|
|æ‰©å®¹ resize|âŒ|âœ… åˆ†æ®µé”+è¿ç§»èŠ‚ç‚¹|
|é“¾è¡¨è½¬çº¢é»‘æ ‘|âŒ|âœ…|
## ä¸‰. çº¿ç¨‹æ± 
### 1. çº¿ç¨‹æ± çš„æ‰§è¡ŒåŸç†
```java
public ThreadPoolExecutor(int corePoolSize,  
                          int maximumPoolSize,  
                          long keepAliveTime,  
                          TimeUnit unit,  
                          BlockingQueue<Runnable> workQueue,  
                          RejectedExecutionHandler handler)
```
```java
executor.allowCoreThreadTimeOut(true);//å…è®¸é”€æ¯æ ¸å¿ƒçº¿ç¨‹
```
- corePoolSizeï¼šæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œä¸ä¼šè¢«é”€æ¯ï¼Œé™¤éè°ƒç”¨allowCoreThreadTimeOutæ–¹æ³•
- maximumPoolSizeï¼šæœ€å¤§çº¿ç¨‹æ•°ï¼Œå³æ ¸å¿ƒçº¿ç¨‹æ•°+æ•‘æ€¥çº¿ç¨‹æ•°
- keepAliveTimeï¼šå½“æ²¡æœ‰ä»»åŠ¡å¤„ç†æ—¶ï¼Œæ•‘æ€¥çº¿ç¨‹çš„æœ€å¤§å­˜æ´»æ—¶é—´
- unitï¼šå­˜æ´»æ—¶é—´å•ä½
- BlockingQueueï¼šå½“**æ²¡æœ‰ç©ºé—²çš„æ ¸å¿ƒçº¿ç¨‹**æ—¶ï¼Œæ–°æ¥çš„ä»»åŠ¡ä¼šè¢«æ”¾å…¥è¿™ä¸ªé˜»å¡é˜Ÿåˆ—ï¼Œå½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œå¦‚æœå½“å‰çº¿ç¨‹æ•°æ²¡æœ‰è¶…è¿‡æœ€å¤§çº¿ç¨‹æ•°ï¼Œä¼šåˆ›å»ºæ•‘æ€¥çº¿ç¨‹æ¥å¤„ç†
- RejectedExecutionHandlerï¼šå½“é˜»å¡é˜Ÿåˆ—å·²æ»¡ä¸”å½“å‰çº¿ç¨‹æ•°åˆ°è¾¾æœ€å¤§çº¿ç¨‹æ•°ï¼Œä¼šæ ¹æ®æ‹’ç»ç­–ç•¥å¤„ç†æ–°æ¥çš„ä»»åŠ¡
### 2. é˜»å¡é˜Ÿåˆ—
| ç‰¹æ€§              | `LinkedBlockingQueue`                      | `ArrayBlockingQueue`                |
| --------------- | ------------------------------------------ | ----------------------------------- |
| **åº•å±‚ç»“æ„**        | é“¾è¡¨ï¼ˆé“¾å¼èŠ‚ç‚¹ï¼‰                                   | æ•°ç»„ï¼ˆå¾ªç¯æ•°ç»„ï¼‰                            |
| **æ˜¯å¦æœ‰ç•Œ**        | é»˜è®¤æ— ç•Œï¼ˆå¯è®¾å®¹é‡ï¼‰                                 | å¿…é¡»è®¾å®šå®¹é‡ï¼ˆæœ‰ç•Œï¼‰                          |
| **ååé‡**         | é€šå¸¸è¾ƒé«˜ï¼Œé€‚åˆé«˜å¹¶å‘                                 | ç•¥ä½ï¼Œä½†æ€§èƒ½æ›´ç¨³å®š                           |
| **é”å®ç°**         | **ä¸¤æŠŠé”**ï¼Œæ›´é«˜å¹¶å‘æ•ˆç‡ï¼Œputæ—¶é”ä½é“¾è¡¨å°¾èŠ‚ç‚¹ï¼Œtakeæ—¶é”ä½å¤´ç»“ç‚¹ï¼Œäº’ä¸å½±å“ | **ä¸€æŠŠé”**ï¼ˆput å’Œ take äº’æ–¥ï¼‰è¾ƒç®€å•ä½†å†²çªå¤šï¼Œå¹¶å‘æ•ˆç‡ä½ |
| **å†…å­˜å ç”¨**        | åŠ¨æ€å¢é•¿é“¾è¡¨èŠ‚ç‚¹ï¼Œå†…å­˜å ç”¨è¾ƒé«˜                            | å›ºå®šæ•°ç»„å¤§å°ï¼Œå†…å­˜ä½¿ç”¨ç¨³å®š                       |
| **æ„é€ æ—¶æ˜¯å¦å¿…é¡»æŒ‡å®šå®¹é‡** | å¦ï¼ˆé»˜è®¤ `Integer.MAX_VALUE`ï¼‰                  | æ˜¯ï¼ˆå¿…é¡»æŒ‡å®šï¼‰                             |
| **å…¸å‹ä½¿ç”¨åœºæ™¯**      | `ExecutorService` çš„é»˜è®¤é˜Ÿåˆ—                    | å¯¹èµ„æºæ•æ„Ÿã€å®æ—¶æ€§è¦æ±‚é«˜çš„ç³»ç»Ÿ                     |
| **é˜»å¡è¡Œä¸º**        | put æ»¡æ—¶é˜»å¡ï¼Œtake ç©ºæ—¶é˜»å¡                         | ç›¸åŒè¡Œä¸º                                |
| **å¹¶å‘æ€§èƒ½**        | æ›´ä¼˜ï¼ˆè¯»å†™é”åˆ†ç¦»ï¼‰                                  | ä¸­ç­‰åä¸Š                                |
| **é€‚åˆåœºæ™¯**        | ä»»åŠ¡é‡ä¸ç¡®å®šã€å¤§é‡ç”Ÿäº§æ¶ˆè´¹ã€æµå¼å¤„ç†                         | ä»»åŠ¡é‡ç¨³å®šã€å†…å­˜å—é™çš„é«˜æ€§èƒ½ä»»åŠ¡é˜Ÿåˆ—                  |
SynchronousQueueä¸å­˜å‚¨ä»»åŠ¡ï¼Œæ¯ä¸ªæ’å…¥æ“ä½œå¿…é¡»ç­‰å¾…ä¸€ä¸ªç§»å‡ºæ“ä½œå®Œæˆ
DelayedWorkQueueï¼Œå¯ä»¥æŒ‡å®šä»»åŠ¡æ‰§è¡Œçš„å¼€å§‹æ—¶é—´
### 3. ç¡®å®šæ ¸å¿ƒçº¿ç¨‹æ•°
- å¯¹äºIOå‹ä»»åŠ¡ï¼Œå¦‚æ–‡ä»¶è¯»å†™ï¼Œdbè¯»å†™ï¼Œçº¿ç¨‹æ•°æ˜¯2n+1ï¼Œnæ˜¯cupçš„æ ¸æ•°
- å¯¹äºCUPå¯†é›†å‹ä»»åŠ¡ï¼Œå¦‚ä»£ç è®¡ç®—ï¼ŒBitmaapè½¬æ¢ç­‰ï¼Œæ˜¯n+1
### 4. Executorsåˆ›å»ºçº¿ç¨‹æ± æ–¹å¼
```java
//æŒ‡å®šæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œæ²¡æœ‰æ•‘æ€¥çº¿ç¨‹ï¼Œé˜»å¡é˜Ÿåˆ—å®¹é‡æ— é™
public static ExecutorService newFixedThreadPool(int nThreads) {  
    return new ThreadPoolExecutor(nThreads, nThreads,  
                                  0L, TimeUnit.MILLISECONDS,  
                                  new LinkedBlockingQueue<Runnable>());  
}
//å•ä¾‹çº¿ç¨‹æ± ï¼Œåªæœ‰ä¸€ä¸ªæ ¸å¿ƒçº¿ç¨‹å¤„ç†ä»»åŠ¡ï¼Œé˜Ÿåˆ—æ— ç•Œ
public static ExecutorService newSingleThreadExecutor(ThreadFactory threadFactory) {  
    return new AutoShutdownDelegatedExecutorService  
        (new ThreadPoolExecutor(1, 1,  
                                0L, TimeUnit.MILLISECONDS,  
                                new LinkedBlockingQueue<Runnable>(),  
                                threadFactory));  
}
//ç¼“å­˜çº¿ç¨‹æ± ï¼Œå…¨éƒ¨ç”±æ•‘æ€¥çº¿ç¨‹å¤„ç†ä»»åŠ¡
public static ExecutorService newCachedThreadPool() {  
    return new ThreadPoolExecutor(0, Integer.MAX_VALUE,  
                                  60L, TimeUnit.SECONDS,  
                                  new SynchronousQueue<Runnable>());  
}
//å®šæ—¶å¤„ç†çº¿ç¨‹æ± 
public ScheduledThreadPoolExecutor(int corePoolSize) {  
    super(corePoolSize, Integer.MAX_VALUE,  
          DEFAULT_KEEPALIVE_MILLIS, MILLISECONDS,  
          new DelayedWorkQueue());  
}
```
æ‰€ä»¥ä¸æ¨èä½¿ç”¨Executorsåˆ›å»ºçº¿ç¨‹æ± ï¼Œå®¹æ˜“å‡ºç°åˆ›å»ºè¿‡å¤šçº¿ç¨‹æˆ–å­˜å‚¨è¿‡å¤šä»»åŠ¡çš„æƒ…å†µï¼Œå¯¼è‡´OOM
### 5. ä½¿ç”¨åœºæ™¯
```java
public static void main(String[] args) throws InterruptedException {  
    CountDownLatch countDownLatch = new CountDownLatch(3);  
    ThreadPoolExecutor threadPoolExecutor = (ThreadPoolExecutor) Executors.newFixedThreadPool(3);  
    threadPoolExecutor.execute(new Runnable() {  
        @Override  
        public void run() {  
            System.out.println("å“ˆå“ˆ");  
            countDownLatch.countDown();  
        }  
    });  
    threadPoolExecutor.execute(new Runnable() {  
        @Override  
        public void run() {  
            System.out.println("å“ˆå“ˆ");  
            countDownLatch.countDown();  
        }  
    });  
    countDownLatch.await();  
}
```
- åˆ©ç”¨CountDownLatchç­‰å¾…æ‰€æœ‰çº¿ç¨‹ä»»åŠ¡å®Œæˆ
- æ„é€ å‡½æ•°æŒ‡å®šäº†ä¿¡å·é‡ï¼Œæ¯æœ‰ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨äº†countDownæ–¹æ³•å°±ç›¸å½“äºå‡å°‘äº†ä¸€ä¸ªä¿¡å·é‡
- awaitæ–¹æ³•ç±»ä¼¼äºsleepæ–¹æ³•ï¼Œå½“ä¿¡å·é‡å‡å°‘åˆ°0åˆ™çº¿ç¨‹è¢«å”¤é†’
- åº•å±‚ä½¿ç”¨AQSæ¥å‡å°‘ä¿¡å·é‡
- ä¾‹å¦‚å¯ä»¥åˆ©ç”¨çº¿ç¨‹æ± æŠŠæ•°æ®åº“æ•°æ®è¿ç§»åˆ°esçš„è¿‡ç¨‹ï¼Œåˆ’åˆ†æˆå¤šä¸ªçº¿ç¨‹ä»»åŠ¡ï¼Œæ¯ä¸ªä»»åŠ¡è¿ç§»ä¸€é¡µæ•°æ®ï¼Œå°†ä»»åŠ¡äº¤ç»™çº¿ç¨‹æ± å»æ‰§è¡Œï¼Œåˆ©ç”¨ awaitæ–¹æ³•åˆ¤æ–­æ˜¯å¦æ‰§è¡Œå®Œæˆ
```java
public static void main(String[] args) throws InterruptedException {  
    ExecutorService executorService = Executors.newFixedThreadPool(3);  
    try {  
        CompletableFuture<String> stringCompletableFuture = new CompletableFuture<String>().completeAsync(() -> "l",executorService);  
        System.out.println(stringCompletableFuture.get());  
    } catch (Exception e) {  
        throw new RuntimeException(e);  
    }  
}
```
å¯ä»¥ä½¿ç”¨å¼‚æ­¥ä»»åŠ¡åŠ çº¿ç¨‹æ± è¿›è¡Œæ•°æ®æ•´åˆ
### 6. ThreadLocal
- å®ç°çº¿ç¨‹å¯¹è±¡éš”ç¦»ï¼Œè®©æ¯ä¸ªç°çº¿ç¨‹ä½¿ç”¨å„è‡ªçš„èµ„æºï¼Œé¿å…å‘ç”Ÿçº¿ç¨‹å®‰å…¨
- æ¯ä¸ªçº¿ç¨‹å¯¹è±¡å†…éƒ¨æœ‰ä¸€ä¸ªThreadLocalMapç±»å‹çš„æˆå‘˜å˜é‡ï¼Œæ˜¯çœŸæ­£å­˜å‚¨æ•°æ®çš„åœ°æ–¹
- å½“è°ƒç”¨setæ–¹æ³•æ—¶ï¼Œå°±æ˜¯ä»¥å½“å‰çš„ThreadLocalä¸ºé”®å°†å€¼å­˜å…¥è¿›å»çš„
- getæ–¹æ³•å°±æ˜¯ä»¥å½“å‰TreadLocalä½œä¸ºé”®æ‰¾å‡ºå¯¹åº”çš„å€¼
- removeæ–¹æ³•ä¼šåˆ é™¤ä»¥å½“å‰ThreadLocalä¸ºé”®çš„æ‰€æœ‰å€¼
```java
static class ThreadLocalMap {  
  static class Entry extends WeakReference<ThreadLocal<?>> {   
        Object value;  
        Entry(ThreadLocal<?> k, Object v) {  
            super(k);  
            value = v;  
        }  
    }
}
```
ç”±äºThreadLocalMapå®é™…æ˜¯ä»¥å†…éƒ¨çš„Entryå­˜å‚¨æ•°æ®çš„ï¼Œè€Œå®ƒç»§æ‰¿äº†`WeakReference<ThreadLocal<?>>`å¼±å¼•ç”¨æ¥å£ï¼Œå¯¼è‡´ThreadLocalæ˜¯å¼±å¼•ç”¨ï¼Œè€Œvalæ˜¯å¼ºå¼•ç”¨ï¼Œå¯¼è‡´ThreadLocalåœ¨GCä¹‹åkeyå¤±æ•ˆï¼Œä½†æ˜¯valå´ä»ç„¶å­˜åœ¨ï¼Œé•¿æ—¶é—´åå°±ä¼šåœ¨Mapé‡Œç´¯ç§¯å¤§é‡æ— ç”¨æ•°æ®å¯¼è‡´OOM
# JVM
## ä¸€. ç»„æˆ
```txt
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ JVM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Method Area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€ Native Method â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚   ç±»ä¿¡æ¯ï¼ˆç±»åã€çˆ¶ç±»åã€æ–¹æ³•ã€å­—æ®µç­‰ï¼‰ â”‚     â”‚   æœ¬åœ°æ–¹æ³•æ¥å£ï¼ˆJNIï¼‰ â”‚â”‚
â”‚  â”‚   å¸¸é‡æ± ï¼ˆè¿è¡Œæ—¶å¸¸é‡æ± ï¼‰               â”‚     â”‚   è°ƒç”¨C/C++æ–¹æ³•æ”¯æŒ    â”‚â”‚
â”‚  â”‚   é™æ€å˜é‡ã€ç±»åŠ è½½ä¿¡æ¯ç­‰               â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Heap â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚  â”‚   æ‰€æœ‰å¯¹è±¡å®ä¾‹å’Œæ•°ç»„åˆ†é…åœ¨å †ä¸­    â”‚                                       â”‚
â”‚  â”‚   åŒ…æ‹¬ï¼š                          â”‚                                       â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Young Generation â” â”‚                                       â”‚
â”‚  â”‚   â”‚ Edenã€Survivor From/ToåŒº   â”‚ â”‚                                       â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                                       â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Old Generation â”€â”€â”€â” â”‚                                       â”‚
â”‚  â”‚   â”‚  é•¿æœŸå­˜æ´»çš„å¯¹è±¡              â”‚ â”‚                                       â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ JVM Stack â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚  â”‚ æ¯ä¸ªçº¿ç¨‹ä¸€ä¸ªæ ˆï¼Œæ¯ä¸ªæ–¹æ³•è°ƒç”¨å¯¹åº”  â”‚                                      â”‚
â”‚  â”‚ ä¸€ä¸ªæ ˆå¸§ï¼ˆStack Frameï¼‰            â”‚                                      â”‚
â”‚  â”‚ åŒ…å«ï¼šå±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€      â”‚                                      â”‚
â”‚  â”‚ æ–¹æ³•è¿”å›åœ°å€ã€å¼‚å¸¸å¤„ç†ä¿¡æ¯ç­‰      â”‚                                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Program Counter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚  â”‚ æ¯ä¸ªçº¿ç¨‹ä¸€ä¸ªPCå¯„å­˜å™¨                  â”‚                                â”‚
â”‚  â”‚ æŒ‡å‘å½“å‰çº¿ç¨‹æ‰€æ‰§è¡Œæ–¹æ³•å­—èŠ‚ç çš„åœ°å€    â”‚                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Stack Native (C Stack) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚ ç”¨äºæ”¯æŒnativeæ–¹æ³•æ‰§è¡Œï¼ˆå¦‚JNIè°ƒç”¨ï¼‰               â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```
### 1. ç¨‹åºè®¡æ•°å™¨
æ¯ä¸ªçº¿ç¨‹ä¸€ä¸ªç§æœ‰çš„pcå¯„å­˜å™¨ï¼Œå†…éƒ¨ä¿å­˜å­—èŠ‚ç çš„è¡Œå·ï¼Œç”¨äºè®°å½•å³å°†è¦æ‰§è¡Œçš„ä¸‹ä¸€æ¡å­—èŠ‚ç æŒ‡ä»¤çš„åœ°å€
### 2. å †
çº¿ç¨‹å…±äº«çš„åŒºåŸŸï¼Œä¿å­˜æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹å’Œæ•°ç»„ï¼ŒåŒ…æ‹¬ä¼Šç”¸å›­åŒºï¼Œä¸¤ä¸ªå¹¸å­˜è€…åŒºï¼Œä¸€ä¸ªè€å¹´å¸¦
åœ¨jdk1.7ä¹‹å‰Method Areaï¼ˆæ°¸ä¹…å¸¦ï¼ŒåŒ…æ‹¬ç±»ä¿¡æ¯ï¼Œå¸¸é‡ä¿¡æ¯ï¼Œé™æ€å˜é‡ï¼‰å­˜å‚¨åœ¨å †ä¸­ï¼Œ1.8ä¹‹åæ‰ç§»è‡³å…ƒç©ºé—´
### 3. è™šæ‹Ÿæœºæ ˆ
	æ¯ä¸ªçº¿ç¨‹è¿è¡Œæ—¶æ‰€éœ€è¦çš„å†…å­˜ï¼Œå°±æ˜¯jvmæ ˆ
- æ¯ä¸ªçº¿ç¨‹åœ¨å¯åŠ¨æ—¶ï¼Œjvmä¼šä¸ºå®ƒåˆ†é…ä¸€ä¸ªJVMæ ˆï¼Œæ ˆç”±ä¸€ç»„æ ˆå¸§ç»„æˆ
```txt
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    å±€éƒ¨å˜é‡è¡¨ (Local Variables)â”‚
â”‚  - æ–¹æ³•å‚æ•°                    â”‚
â”‚  - æ–¹æ³•å†…éƒ¨å®šä¹‰çš„å˜é‡           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    æ“ä½œæ•°æ ˆ (Operand Stack)    â”‚
â”‚  - ç”¨äºä¸´æ—¶ä¿å­˜è®¡ç®—è¿‡ç¨‹ä¸­çš„ä¸­é—´å€¼ â”‚
â”‚  - æ‰§è¡ŒæŒ‡ä»¤å¦‚ iaddã€imul ç­‰     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    åŠ¨æ€é“¾æ¥ (Dynamic Linking)  â”‚
â”‚  - æŒ‡å‘è¿è¡Œæ—¶å¸¸é‡æ± ä¸­å½“å‰æ–¹æ³•ä¿¡æ¯ â”‚
â”‚  - æ¯”å¦‚æ–¹æ³•å¼•ç”¨ã€å­—æ®µå¼•ç”¨ç­‰      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    æ–¹æ³•è¿”å›åœ°å€ (Return Address)â”‚
â”‚  - è°ƒç”¨è€…æ–¹æ³•çš„å­—èŠ‚ç æ‰§è¡Œä½ç½®    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
- æ¯æ¬¡è°ƒç”¨æ–¹æ³•æ—¶ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ ˆå¸§å‹æ ˆ
- åœ¨ä¸€ä¸ªæ ˆå¸§æ‰§è¡Œå®Œæˆåå¼¹æ ˆï¼Œå†…å­˜é‡Šæ”¾
- å±€éƒ¨å˜é‡è¡¨ï¼šå­˜æ”¾æ–¹æ³•å‚æ•°å’Œæ–¹æ³•å†…å±€éƒ¨å˜é‡ï¼Œå¼•ç”¨ç±»å‹å¯¹è±¡ä¹Ÿä¼šä»¥åœ°å€å½¢å¼å­˜å‚¨åœ¨è¿™é‡Œ
- æ“ä½œæ•°æ ˆï¼šä¿å­˜è®¡ç®—è¿‡ç¨‹ä¸­çš„ä¸­é—´å€¼å’Œæ“ä½œæŒ‡ä»¤
- åŠ¨æ€é“¾æ¥ï¼šæ¯ä¸ªæ–¹æ³•åœ¨ç¼–è¯‘æ—¶å¼•ç”¨çš„æ˜¯**å¸¸é‡æ± ä¸­çš„ç¬¦å·å¼•ç”¨ï¼Œè¿è¡Œæ—¶è§£ææˆå®é™…åœ°å€**ï¼Œè¿™ä¸ªä¿¡æ¯è¢«å­˜å‚¨åœ¨åŠ¨æ€é“¾æ¥ä¸­
- æ–¹æ³•è¿”å›åœ°å€ï¼šå½“å‰æ–¹æ³•è¿”å›åï¼Œ**ç»§ç»­æ‰§è¡Œè°ƒç”¨è€…æ–¹æ³•çš„ä¸‹ä¸€æ¡å­—èŠ‚ç æŒ‡ä»¤çš„åœ°å€**
- ç”±æ­¤å¯è§æ¯è°ƒç”¨ä¸€æ¬¡æ–¹æ³•éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ ˆå¸§ï¼Œæ‰€ä»¥æ–¹æ³•å†…çš„å±€éƒ¨å˜é‡å¦‚æœæ²¡æœ‰é€ƒç¦»ä½œç”¨èŒƒå›´å°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¦åˆ™å°±æ˜¯ä¸å®‰å…¨çš„
- æ ˆå¸§è¿‡å¤šã€è¿‡å¤§éƒ½ä¼šå¯¼è‡´jvmæ ˆå†…å­˜æº¢å‡º
### 4. æ–¹æ³•åŒº
- å„ä¸ªçº¿ç¨‹å…±äº«çš„å†…å­˜åŒºåŸŸ
- å­˜å‚¨ç±»ä¿¡æ¯ã€è¿è¡Œæ—¶å¸¸é‡æ± 
- è™šæ‹Ÿæœºå¼€å¯æ—¶åˆ›å»ºï¼Œå…³é—­æ—¶é‡Šæ”¾
- å¦‚æœæ–¹æ³•åŒºçš„å†…å­˜æ— æ³•æ»¡è¶³åˆ†é…è¯·æ±‚ï¼Œå¦‚ç±»çš„åŠ è½½ä¿¡æ¯æ”¾ä¸ä¸‹äº†ï¼Œå°±ä¼šæŠ›å‡ºMetaspaceå†…å­˜æº¢å‡º
- **å¸¸é‡æ± **å¯ä»¥çœ‹ä½œ`.class`æ–‡ä»¶ä¸­çš„ä¸€å¼ è¡¨ï¼Œè™šæ‹ŸæœºæŒ‡ä»¤æ ¹æ®è¿™å¼ è¡¨æ‰¾åˆ°è¦æ‰§è¡Œçš„ç±»åï¼Œæ–¹æ³•åï¼Œå­—é¢é‡ç­‰ï¼Œ**è¿™äº›åªæ˜¯æè¿°ä¿¡æ¯ï¼ˆåå­—è€Œå·²ï¼‰**ï¼Œ**ç›¸å½“äºåªæ˜¯ä¸€æ®µç±»è·¯å¾„/æ–¹æ³•è·¯å¾„çš„å­—ç¬¦ä¸²ï¼Œä¸æ˜¯å…¶æœ¬èº«**
- **è¿è¡Œæ—¶å¸¸é‡æ± **æ˜¯å½“ç±»è¢«åŠ è½½çš„æ—¶ï¼Œ**å¸¸é‡æ± çš„ä¿¡æ¯å°±ä¼šæ”¾å…¥è¿è¡Œæ—¶å¸¸é‡æ± ï¼Œå¹¶æŠŠç¬¦å·å¼•ç”¨è§£æä¸ºçœŸå®åœ°å€**ï¼Œè¿™ä¸ªè§£æè¿‡ç¨‹å°±æ˜¯**ç±»è£…è½½**çš„è¿‡ç¨‹ï¼Œç”±ç±»åŠ è½½å™¨ â†’ Class å¯¹è±¡ â†’ æ–¹æ³•åŒºï¼Œå®Œæˆè§£æï¼Œå¾—åˆ°çœŸå®åœ°å€
### 5. ç›´æ¥å†…å­˜
æ˜¯ JVM å¤–çš„ä¸€å—å†…å­˜åŒºåŸŸï¼Œ**ä¸å±äºå †ã€ä¹Ÿä¸å±äºæ–¹æ³•åŒº**ï¼Œæ˜¯é€šè¿‡ Java ä»£ç ï¼ˆé€šå¸¸æ˜¯ `ByteBuffer.allocateDirect`ï¼‰ç›´æ¥å‘æ“ä½œç³»ç»Ÿç”³è¯·çš„å†…å­˜ç©ºé—´
æ™®é€šçš„IOæ“ä½œï¼Œéœ€è¦å…ˆå°†æ•°æ®æ‰¹æ¬¡è¯»åˆ°ç³»ç»Ÿå†…å­˜ï¼Œå†ç”±ç³»ç»Ÿå†…å­˜å†™å…¥javaå †çš„ç¼“å†²åŒºï¼Œjavaä»£ç æ— æ³•ç›´æ¥æ“ä½œç³»ç»Ÿå†…å­˜
è€Œç›´æ¥å†…å­˜æ˜¯javaä»£ç ç”³è¯·çš„ã€å¯ä»¥ç›´æ¥æ“ä½œçš„å†…å­˜ï¼Œæ›´çœæ—¶é—´
## äºŒ. ç±»åŠ è½½å™¨
### 1. æ¦‚å¿µ
**ç±»åŠ è½½å™¨** æ˜¯ JVM ä¸­ç”¨æ¥ **å°† `.class` æ–‡ä»¶è¯»å–è¿›å†…å­˜ï¼Œå¹¶è½¬æ¢ä¸º Class å¯¹è±¡** çš„ç»„ä»¶ï¼Œä»¥ä¾¿jvmèƒ½å¤Ÿè¯†åˆ«è¿è¡Œ
### 2. åŒäº²å§”æ´¾æœºåˆ¶
| ç±»åŠ è½½å™¨å       | JVMåç§°/å®ç°ç±»                       | åŠ è½½å†…å®¹                           |
| ----------- | ------------------------------- | ------------------------------ |
| **å¼•å¯¼ç±»åŠ è½½å™¨**  | `BootstrapClassLoader`ï¼ˆC/C++å®ç°ï¼‰ | æ ¸å¿ƒç±»åº“ï¼š`rt.jar`, `java.lang.*` ç­‰ |
| **æ‰©å±•ç±»åŠ è½½å™¨**  | `ExtClassLoader`                | JDK æ‰©å±•ç›®å½•ä¸‹çš„ç±»ï¼ˆå¦‚ `jre/lib/ext/`ï¼‰  |
| **åº”ç”¨ç±»åŠ è½½å™¨**  | `AppClassLoader`                | CLASSPATH ä¸‹çš„ç±»ï¼ˆä½ å†™çš„ç±»ï¼‰            |
| **è‡ªå®šä¹‰ç±»åŠ è½½å™¨** | ä½ ç»§æ‰¿ `ClassLoader` å†™çš„            | åŠ¨æ€åŠ è½½ç±»ï¼Œçƒ­éƒ¨ç½²ï¼Œè§£è€¦ï¼ˆå¸¸è§äºæ¡†æ¶ã€æ’ä»¶ï¼‰         |
åŒäº²å§”æ´¾æœºåˆ¶å°±æ˜¯å½“ä¸€ä¸ªåŠ è½½å™¨å°è¯•åŠ è½½ä¸€ä¸ªç±»çš„æ—¶å€™ï¼Œä¸ä¼šè‡ªå·±å»åŠ è½½ï¼Œè€Œæ˜¯å§”æ´¾è‡ªå·±çš„çˆ¶åŠ è½½å™¨å»åŠ è½½ï¼Œå¦‚æœçˆ¶åŠ è½½å™¨ä¹Ÿæœ‰è‡ªå·±çš„çˆ¶åŠ è½½å™¨å°±ç»§ç»­å‘ä¸Šå§”æ‰˜ï¼Œå¦‚æœçˆ¶åŠ è½½å™¨æ²¡æœ‰åŠ è½½è¯¥ç±»æ—¶ï¼Œå­åŠ è½½å™¨æ‰ä¼šè‡ªå·±å»åŠ è½½
#### ä½œç”¨
- é˜²æ­¢æ ¸å¿ƒä»£ç è¢«ç”¨æˆ·ä»£ç æ›¿æ¢ï¼Œä¾‹å¦‚ç”¨æˆ·è‡ªå®šä¹‰çš„ä¸€ä¸ªå«Stringçš„ç±»ä¼šè¢«jdkè‡ªå¸¦çš„è¦†ç›–
- é¿å…é‡å¤åŠ è½½ï¼Œå¦‚æœçˆ¶åŠ è½½å™¨å·²ç»åŠ è½½è¿‡ï¼Œå°±ä¸ä¼šé‡å¤åŠ è½½
- springbootã€tomcatæˆ–æ’ä»¶ä¼šäººä¸ºæ‰“ç ´æœºåˆ¶ï¼Œä¼˜å…ˆè‡ªå®šä¹‰åŠ è½½å™¨åŠ è½½ï¼Œä¸æˆåŠŸå†è®©çˆ¶åŠ è½½å™¨åŠ è½½
### 3. ç±»è£…è½½æ‰§è¡Œæµç¨‹
```txt
åŠ è½½ï¼ˆLoadï¼‰ â†’ éªŒè¯ï¼ˆVerifyï¼‰ â†’ å‡†å¤‡ï¼ˆPrepareï¼‰ â†’ è§£æï¼ˆResolveï¼‰ â†’ åˆå§‹åŒ–ï¼ˆInitializeï¼‰ â†’ ä½¿ç”¨ï¼ˆUseï¼‰ â†’ å¸è½½ï¼ˆUnloadï¼‰
```
#### åŠ è½½
javaç±»åœ¨ç¼–è¯‘ä¹‹åç”Ÿæˆ.classæ–‡ä»¶ï¼ŒåŠ è½½é˜¶æ®µå°±æ˜¯å°†æ–‡ä»¶ä»æ–‡ä»¶ç³»ç»Ÿä¸­å»è¯»å–æˆäºŒè¿›åˆ¶çš„å­—èŠ‚æµï¼Œå¹¶æ„å»ºæˆjvmèƒ½æ“ä½œçš„Classå¯¹è±¡
- é€šè¿‡ç±»çš„å…¨é™å®šåï¼Œæ‰¾åˆ°äºŒè¿›åˆ¶æ•°æ®æµ
- è§£ææ•°æ®æµï¼Œåœ¨**æ–¹æ³•åŒºä¸­å­˜å‚¨ç±»çš„ç»“æ„ä¿¡æ¯**ï¼Œåœ¨å †**ä¸­å¼€è¾Ÿç©ºé—´å­˜å‚¨è¿™ä¸ªç±»çš„Classå¯¹è±¡**ï¼Œå¯¹è±¡çš„å†…éƒ¨ç»“æ„ä¸­æŒæœ‰å¯¹æ–¹æ³•åŒºï¼ˆå…ƒç©ºé—´ï¼‰ä¸­ç±»ç»“æ„ä¿¡æ¯çš„**ç›´æ¥å¼•ç”¨ï¼ˆæŒ‡é’ˆï¼‰**ï¼Œå½¢æˆæ˜ å°„å…³ç³»ï¼Œä½œä¸ºæ–¹æ³•åŒºè¿™ä¸ªç±»çš„å„ç§æ•°æ®ã€æ–¹æ³•çš„**è®¿é—®å…¥å£**
- ä¹‹åè¦åˆ›å»ºè¿™ä¸ªç±»çš„å¯¹è±¡ï¼Œå°±èƒ½é€šè¿‡è¿™ä¸ªClasså¯¹è±¡å»æ–¹æ³•åŒºä¸­è·å¾—ç±»çš„æ„é€ å‡½æ•°ã€æ–¹æ³•ã€å­—æ®µç­‰ä¿¡æ¯æ¥åˆ›å»ºå¯¹è±¡ï¼Œåˆ›å»ºå‡ºæ¥çš„å¯¹è±¡çš„å¯¹è±¡å¤´**åŒ…å«å®ƒæ‰€å±çš„ç±»çš„Classå¯¹è±¡çš„å¼•ç”¨**ï¼Œä»è€Œå½¢æˆé“¾æ¡ï¼Œjvmå°±æ˜¯é€šè¿‡è¿™ä¸ªå¼•ç”¨æ¥æ”¯æŒå¯¹è±¡çš„åå°„ã€æ–¹æ³•æŸ¥æ‰¾ã€å­—æ®µè®¿é—®ç­‰æ“ä½œ
#### éªŒè¯
- æ–‡ä»¶æ ¼å¼éªŒè¯
- å…ƒæ•°æ®éªŒè¯
- å­—èŠ‚ç éªŒè¯
- ç¬¦å·å¼•ç”¨éªŒè¯ï¼ŒClassæ–‡ä»¶**åœ¨å…¶å¸¸é‡æ± é€šè¿‡å­—ç¬¦ä¸²ï¼ˆç¬¦å·å¼•ç”¨ï¼‰** è®°å½•è‡ªå·±å°†è¦ç”¨åˆ°çš„å…¶ä»–ç±»æˆ–è€…æ–¹æ³•ï¼Œæ£€æŸ¥å®ƒä»¬æ˜¯å¦å­˜åœ¨
#### å‡†å¤‡
ä¸ºç±»å˜é‡åˆ†é…å†…å­˜å¹¶è®¾ç½®åˆå§‹å€¼
```java
static int a=10;  //å®é™…ä¸Šåœ¨è¿™ä¸ªé˜¶æ®µçš„é»˜è®¤å€¼æ˜¯0
static final int b=10;  //ç›´æ¥èµ‹å€¼ï¼Œä¸‹é¢ä¸€æ ·
static final String c= "hello";  
static final Object d= new Object();
```
- staticç›´æ¥ä¿®é¥°çš„å˜é‡ï¼Œåœ¨å‡†å¤‡é˜¶æ®µè®¾ç½®é»˜è®¤å€¼ï¼Œæ¯”å¦‚intç±»å‹å°±æ˜¯0ï¼Œè¦ç»™aèµ‹å€¼10è¦åœ¨åˆå§‹åŒ–é˜¶æ®µæ‰ä¼šæ‰§è¡Œ
- staticä¿®é¥°çš„finalå˜é‡ï¼Œä¼šåœ¨è¿™ä¸ªé˜¶æ®µç›´æ¥èµ‹å€¼ï¼Œå› ä¸ºæ˜¯å¸¸é‡ï¼Œå€¼å·²ç»ç¡®å®š
- staticä¿®é¥°çš„finalå¼•ç”¨å˜é‡ï¼Œåœ¨è¿™ä¸ªé˜¶æ®µä¹Ÿä¼šå®Œæˆèµ‹å€¼
#### è§£æ
å°†ç¬¦å·å¼•ç”¨è½¬åŒ–ä¸ºçœŸå®åœ°å€
#### åˆå§‹åŒ–
ä¼˜å…ˆåˆå§‹åŒ–çˆ¶ç±»çš„é™æ€ä»£ç å—ï¼ˆä¹Ÿå°±æ˜¯æ‰§è¡Œé™æ€ä»£ç å—ï¼‰å’Œé™æ€å˜é‡ï¼Œç„¶åæ˜¯å­ç±»çš„é™æ€ä»£ç å—å’Œé™æ€å˜é‡
å½“ç”¨**å­ç±»è®¿é—®çˆ¶ç±»çš„é™æ€å˜é‡æ—¶ï¼Œå°±åªä¼šåˆå§‹åŒ–çˆ¶ç±»**
## ä¸‰. åƒåœ¾å›æ”¶
### 1. å¯¹è±¡ä»€ä¹ˆæ—¶å€™å¯ä»¥è¢«å›æ”¶
å½“å †ä¸­çš„å¯¹è±¡æ²¡æœ‰ä»»ä½•çš„å¼•ç”¨æŒ‡å‘å®ƒæ—¶ï¼Œå°±å¯èƒ½è¢«å®šä¸ºåƒåœ¾è¢«å›æ”¶
å¦‚æœå †ä¸­çš„å¯¹è±¡èº«ä¸Šåªæœ‰å¼±å¼•ç”¨ï¼Œåœ¨GCçš„æ—¶å€™ä¹Ÿä¼šè¢«å›æ”¶
å¦‚æœèº«ä¸Šæœ‰å¼ºå¼•ç”¨ï¼Œå°±ä¸ä¼šè¢«å›æ”¶
å¦‚æœæ²¡æœ‰å¼ºå¼•ç”¨æœ‰è½¯å¼•ç”¨ï¼Œåœ¨GCè¿‡ç¨‹ä¸­å¦‚æœå†…å­˜ä¸è¶³ä¼šè¢«å›æ”¶
#### å¼•ç”¨è®¡æ•°æ³•
æ¯å½“å¯¹è±¡è¢«å¼•ç”¨ä¸€æ¬¡ï¼Œè®¡æ•°å™¨å°±ä¼šåŠ 1ï¼Œå¦‚æœè®¡æ•°å™¨ä¸º0ï¼Œå°±ä¼šæŠŠå¯¹è±¡æ ‡è®°ä¸ºåƒåœ¾
#### å¯è¾¾æ€§åˆ†ææ³•ï¼ˆé»˜è®¤ï¼‰
JVM é€šè¿‡ä»ä¸€ç»„è¢«ç§°ä¸º **GC Roots** çš„å¯¹è±¡å¼€å§‹å‘ä¸‹æœç´¢ï¼Œåªè¦æŸä¸ªå¯¹è±¡**èƒ½ä» GC Roots ç›´æ¥æˆ–é—´æ¥è®¿é—®åˆ°**ï¼Œå°±è¢«è®¤ä¸ºæ˜¯â€œå¯è¾¾çš„ï¼ˆliveï¼‰â€ï¼Œå¦åˆ™å°±æ˜¯åƒåœ¾ï¼Œç­‰å¾…å›æ”¶
GC Root æ˜¯ JVM è®¤ä¸ºâ€œæ°¸è¿œæ´»ç€â€çš„å¯¹è±¡èµ·ç‚¹

| GC Root ç±»å‹                  | è¯´æ˜                                                      |
| --------------------------- | ------------------------------------------------------- |
| âœ… **è™šæ‹Ÿæœºæ ˆï¼ˆæ ˆå¸§ä¸­çš„å±€éƒ¨å˜é‡è¡¨ï¼‰ä¸­çš„å¼•ç”¨å¯¹è±¡** | æ–¹æ³•æ­£åœ¨æ‰§è¡Œçš„æ‰€æœ‰å±€éƒ¨å˜é‡ã€å‚æ•°ï¼ˆåŒ…æ‹¬åŸºæœ¬ç±»å‹çš„åŒ…è£…å¯¹è±¡ã€å¼•ç”¨å¯¹è±¡ï¼‰                      |
| âœ… **æ–¹æ³•åŒºä¸­ç±»é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡**        | å¦‚ `static Object obj = new Object()`ï¼Œåªè¦ç±»è¿˜è¢«åŠ è½½ï¼Œè¿™ä¸ªé™æ€å¼•ç”¨å°±æ˜¯æ´»çš„ |
| âœ… **æ–¹æ³•åŒºä¸­å¸¸é‡å¼•ç”¨çš„å¯¹è±¡**           | å¦‚ `final static String s = "abc"`ï¼›"abc" å¯èƒ½ä¼šè¢«å¸¸é‡æ± å¼•ç”¨       |
| âœ… **æœ¬åœ°æ–¹æ³•æ ˆä¸­ JNI å¼•ç”¨çš„å¯¹è±¡**      | native æ–¹æ³•ä¸­ä½¿ç”¨çš„å¯¹è±¡ï¼Œä¸å— JVM è‡ªåŠ¨ç®¡ç†ï¼Œå› æ­¤è§†ä¸ºæ ¹                       |
| âœ… **æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹å¯¹è±¡æœ¬èº«**           | æ´»è·ƒçº¿ç¨‹å¯¹è±¡ã€çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ç­‰                                       |
| âœ… **Class å¯¹è±¡æœ¬èº«**            | æ¯ä¸ªç±»å¯¹åº”ä¸€ä¸ª `java.lang.Class` å¯¹è±¡ï¼Œå­˜åœ¨å †ä¸­ï¼Œè¢«ç±»åŠ è½½å™¨å¼•ç”¨ï¼Œæ´»ç€            |
| âœ… **è¢«åŒæ­¥é”ï¼ˆmonitorï¼‰æŒæœ‰çš„å¯¹è±¡**    | å¦‚æœå¯¹è±¡ä½œä¸ºé” monitorï¼Œä¹Ÿä¼šè¢«è§†ä¸ºæ ¹ï¼Œé¿å…åœ¨åŒæ­¥ä¸­è¢«å›æ”¶                        |
### 2. å››ç§å¼•ç”¨
#### å¼•ç”¨
æ¯å½“newå‡ºä¸€ä¸ªå¯¹è±¡ï¼Œå°±ä¼šåœ¨å †å†…å­˜ä¸­å¼€è¾Ÿä¸€æ®µç©ºé—´ç”¨æ¥å­˜å‚¨è¿™ä¸ªå¯¹è±¡ï¼Œè¿”å›ä¸€ä¸ªå¼•ç”¨å€¼äº¤ç»™å˜é‡ï¼Œç›¸å½“äºæ˜¯æŒ‡é’ˆä½†ä¸æ˜¯è£¸æŒ‡é’ˆï¼Œå˜é‡åªæ˜¯å¯¹å †ä¸­å¯¹è±¡çš„å¼•ç”¨æˆ–è€…â€œæŒ‡å‘â€

#### å››ç§å¼•ç”¨

| å¼•ç”¨ç±»å‹    | æ˜¯å¦å‚ä¸ GC åˆ¤æ–­     | è¢« GC å›æ”¶æ—¶æœº            | å…¸å‹ç”¨é€”                                 | æ˜¯å¦å½±å“ GC Root å¯è¾¾æ€§åˆ†æ |
| ------- | -------------- | -------------------- | ------------------------------------ | ------------------ |
| **å¼ºå¼•ç”¨** | âœ… æ˜¯            | åªæœ‰æ²¡æœ‰å¼ºå¼•ç”¨æ—¶æ‰ä¼šå›æ”¶         | æ™®é€šå¯¹è±¡å¼•ç”¨ï¼Œå¦‚ `Object obj = new Object()` | âœ… æ˜¯                |
| **å¼±å¼•ç”¨** | âœ… æ˜¯            | åªè¦å‘ç”Ÿ GC å°±ä¼šè¢«å›æ”¶        | ThreadLocal çš„ keyã€å…ƒæ•°æ®ç¼“å­˜              | âœ… æ˜¯                |
| **è½¯å¼•ç”¨** | âœ… æ˜¯            | å†…å­˜ä¸è¶³æ—¶å›æ”¶ï¼ˆGC å‰åˆ¤æ–­å†…å­˜å‹åŠ›ï¼‰  | ç¼“å­˜ï¼ˆå¦‚å›¾ç‰‡ç¼“å­˜ï¼‰                            | âœ… æ˜¯                |
| **è™šå¼•ç”¨** | âŒ å¦ï¼ˆæ— æ³•é€šè¿‡å®ƒè·å–å¯¹è±¡ï¼‰ | è¢« GC åä¼šæ”¶åˆ°é€šçŸ¥ï¼Œä½†æœ¬èº«ä¸é˜»æ­¢å›æ”¶ | ç®¡ç†ç›´æ¥å†…å­˜ï¼ˆé…åˆ `ReferenceQueue`ï¼‰          | âŒ å¦ï¼ˆä¸èƒ½å½±å“å¯è¾¾æ€§ï¼‰       |
### 3. å›æ”¶åƒåœ¾ç®—æ³•
#### æ ‡è®°æ¸…é™¤ç®—æ³•
- å…ˆè¿›è¡Œå¯è¾¾æ€§åˆ†æï¼Œæ ‡è®°å‡ºè¦å›æ”¶çš„å¯¹è±¡ç„¶åå°†æ ‡è®°çš„å¯¹è±¡è¿›è¡Œå›æ”¶
- æ ‡è®°å’Œæ¸…é™¤é€Ÿåº¦æ¯”è¾ƒå¿«
- ç¢ç‰‡åŒ–ä¸¥é‡ï¼Œå†…å­˜ä¸è¿ç»­ï¼Œæ²¡æœ‰åŠæ³•å­˜å‚¨è¾ƒå¤§çš„æ•°ç»„
#### æ ‡è®°æ•´ç†ç®—æ³•
å’Œæ ‡è®°æ¸…é™¤ç®—æ³•åŸºæœ¬ä¸€æ ·ï¼Œä½†æ˜¯åœ¨æ¸…é™¤ä¹‹åæŠŠå­˜æ´»çš„å¯¹è±¡è¿›è¡Œäº†ç§»åŠ¨æ•´ç†ï¼Œè®©ç©ºé—´å˜å¾—è¿è´¯
ç”±äºèŠ±è´¹å®æ—¶é—´ç§»åŠ¨å¯¹è±¡ï¼Œæ‰€ä»¥æ•ˆç‡æœ‰ä¸€å®šå½±å“
è€å¹´ä»£ä½¿ç”¨
#### å¤åˆ¶ç®—æ³•
å°†å†…å­˜åˆ†æˆä¸¤å—å¤§å°ç›¸åŒçš„åŒºåŸŸï¼Œå°†æ ‡è®°çš„å­˜æ´»çš„å¯¹è±¡**å¤åˆ¶**åˆ°ä¸€ä¸ªåŒºåŸŸï¼Œå°†å¦ä¸€ä¸ªåŒºåŸŸå…¨éƒ¨æ¸…é™¤ï¼Œå¤åˆ¶çš„è¿‡ç¨‹å°±å®Œæˆäº†ç©ºé—´çš„æ•´ç†
### 4. GCè¿‡ç¨‹çš„åˆ†ä»£å›æ”¶
- æ–°å»ºå¯¹è±¡éƒ½ä¼šå…ˆåˆ†é…åˆ°ä¼Šç”¸å›­åŒºï¼Œä¼Šç”¸å›­å†…å­˜ä¸è¶³æ—¶ï¼Œè§¦å‘GCï¼Œæ ‡è®°**ä¼Šç”¸å›­å’Œå¹¸å­˜è€…from**å†…å­˜æ´»çš„å¯¹è±¡ï¼Œç”¨å¤åˆ¶ç®—æ³•æŠŠå­˜æ´»çš„å¯¹è±¡å¤åˆ¶åˆ°å¹¸å­˜è€…toä¸­ï¼Œä¹‹åä¼Šç”¸å›­å’Œfromå†…å­˜å…¨éƒ¨é‡Šæ”¾
- ä¹‹åå¦‚æœä¼Šç”¸å›­åŒºåˆæ»¡äº†ï¼Œå°±ä¼šæ ‡è®°**ä¼Šç”¸å›­å’Œto**çš„æ´»å¯¹è±¡ï¼Œç„¶åé‡‡ç”¨å¤åˆ¶ç®—æ³•æŠŠå¯¹è±¡å¤åˆ¶åˆ°fromä¸­ï¼Œä¾æ¬¡ç±»æ¨ï¼Œå¦‚æœfromå’Œtoä¸­çš„å¯¹è±¡ç»å†äº†næ¬¡ï¼ˆé»˜è®¤15æ¬¡ï¼Œjvmå‚æ•°å¯ä»¥æ”¹ï¼‰è¿™æ ·çš„å›æ”¶ä¹‹åå°±ä¼šè¿ç§»åˆ°è€å¹´ä»£ä¸­
- å¦‚æœæ–°ç”Ÿä»£GCå®Œä»ç„¶æ”¾ä¸ä¸‹å°±ä¼šGCè€å¹´ä»£ï¼Œå°è¯•æ”¾è¿›è€å¹´ä»£ï¼Œå¦‚æœè€å¹´ä»£ä¹Ÿæ”¾ä¸è¿›å»ï¼Œå°±è¿›è¡Œå †æ•´ä½“çš„GCï¼Œå¦‚æœæ•´ä½“GCå®Œè¿˜æ˜¯æ”¾ä¸è¿›å»å°±OOMäº†
- young GCï¼šå‘ç”Ÿåœ¨æ–°ç”Ÿä»£ï¼Œä¼šæš‚åœæ‰€æœ‰çº¿ç¨‹è¿›è¡ŒGCï¼Œæš‚åœæ—¶é—´çŸ­
- Mixed GCï¼šå‘ç”Ÿåœ¨æ–°ç”Ÿä»£å’Œéƒ¨åˆ†è€å¹´ä»£
- Full GCï¼šå‘ç”Ÿåœ¨æ–°ç”Ÿä»£å’Œå…¨éƒ¨è€å¹´ä»£ï¼Œæš‚åœæ—¶é—´é•¿
### 5. åƒåœ¾å›æ”¶å™¨
- ä¸²è¡Œåƒåœ¾æ”¶é›†å™¨ï¼šSerial GCã€Serial Old GC
- å¹¶è¡Œåƒåœ¾æ”¶é›†å™¨ï¼šParallel Old GCã€ParNew GC
- CMSï¼ˆå¹¶å‘ï¼‰åƒåœ¾æ”¶é›†å™¨ï¼šCMS GCï¼Œä½œç”¨åœ¨è€å¹´ä»£
- G1ï¼šä½œç”¨åœ¨æ–°ç”Ÿä»£å’Œè€å¹´ä»£
### 6. G1åƒåœ¾å›æ”¶å™¨
- å°†å †å†…å­˜åˆ†æˆäº†å¤šä¸ªå°çš„å†…å­˜åŒºåŸŸï¼Œæ¯ä¸ªåŒºåŸŸéƒ½èƒ½æˆä¸ºä¼Šç”¸å›­ã€å¹¸å­˜è€…ã€è€å¹´ä»£ï¼Œåˆå§‹æ—¶ï¼Œæ‰€æœ‰åŒºåŸŸéƒ½æ˜¯ç©ºé—²çš„
- åˆ›å»ºä¸€äº›å¯¹è±¡ï¼ŒæŒ‘é€‰å‡ºä¸€äº›ç©ºé—²åŒºåŸŸä½œä¸ºä¼Šç”¸å›­å­˜å‚¨è¿™äº›å¯¹è±¡ï¼ˆå æ¯”æ˜¯5%~6%ï¼‰
- å½“ä¼Šç”¸å›­éœ€è¦åƒåœ¾å›æ”¶æ—¶ï¼Œä¼šæŒ‘é€‰å‡ºä¸€ä¸ªç©ºé—²åŒºåŸŸæˆä¸ºå¹¸å­˜è€…åŒºï¼Œç„¶åè¿›è¡Œæ ‡è®°ï¼ŒæŠŠå­˜æ´»çš„å¯¹è±¡å¤åˆ¶åˆ°å¹¸å­˜è€…ä¸­ï¼Œé‡Šæ”¾ä¼Šç”¸å›­ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šæš‚åœç”¨æˆ·è¿›ç¨‹
- å½“ä¼Šç”¸å›­çš„å†…å­˜åˆæ»¡äº†ä¹‹åï¼ŒæŒ‘é€‰å‡ºä¸€ä¸ª**æ–°çš„å¹¸å­˜è€…åŒº**ï¼Œæ ‡è®°ä¼Šç”¸å›­å’ŒåŸæ¥å¹¸å­˜è€…çš„å­˜æ´»çš„å¯¹è±¡ï¼Œå°†å­˜æ´»æ—¶é—´è¾ƒé•¿çš„å¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£ï¼Œå‰©ä½™çš„å¤åˆ¶åˆ°æ–°çš„å¹¸å­˜è€…åŒºä¸­ï¼Œç„¶åå°†ä¼Šç”¸å›­å’ŒåŸæ¥çš„å¹¸å­˜è€…é‡Šæ”¾
- å½“è€å¹´ä»£å ç”¨å†…å­˜è¶…è¿‡45%ä¹‹åï¼Œè§¦å‘å¹¶å‘æ ‡è®°ï¼Œç”¨æˆ·çº¿ç¨‹ä¸ä¼šæš‚åœ
- å¹¶å‘æ ‡è®°ä¹‹åï¼Œæ··åˆæ”¶é›†ï¼Œä¼˜å…ˆæ”¶é›†å­˜æ´»å¯¹è±¡å°‘çš„è€å¹´ä»£ï¼Œå°†è¿™ç§è€å¹´ä»£é‡Œå­˜æ´»çš„å¯¹è±¡å¤åˆ¶åˆ°æ–°çš„è€å¹´ä»£ï¼Œå°†ä¼Šç”¸å›­ã€å¹¸å­˜è€…çš„å­˜æ´»çš„å¯¹è±¡å¤åˆ¶åˆ°æ–°çš„å¹¸å­˜è€…ä¸­ï¼Œå¹¶å°†å­˜æ´»æ—¶é—´è¾ƒé•¿çš„å¯¹è±¡å¤åˆ¶åˆ°æ–°çš„è€å¹´ä»£ä¸­ï¼Œç„¶åé‡Šæ”¾å†…å­˜ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šæš‚åœç”¨æˆ·çº¿ç¨‹
- å¦‚æœå¹¶å‘æ ‡è®°å¤±è´¥ï¼Œå³å›æ”¶é€Ÿåº¦èµ¶ä¸ä¸Šå¯¹è±¡åˆ›å»ºçš„é€Ÿåº¦åˆ™ä¼šè¿›è¡Œfullgcï¼Œæ ‡è®°æ•´ä½“çš„åŒºåŸŸè¿›è¡Œå›æ”¶
- ç»è¿‡å¤šè½®æ··åˆæ”¶é›†ä¹‹åï¼Œè¿›å…¥æ–°ä¸€è½®çš„æ–°ç”Ÿä»£å›æ”¶
- å¦‚æœä¸€ä¸ªå¯¹è±¡å¤ªå¤§ï¼Œä¼šåˆ†é…ä¸€å—æˆ–è¿ç»­çš„å‡ å—hugeåŒºå­˜å‚¨
## å››. JVMå‚æ•°
### 1. è°ƒä¼˜å‚æ•°
#### å†…å­˜ä¸å †ï¼ˆé‡ç‚¹ï¼‰

| å‚æ•°                               | è¯´æ˜             | ç¤ºä¾‹                             |
| -------------------------------- | -------------- | ------------------------------ |
| `-Xms<size>`                     | åˆå§‹å †å¤§å°          | `-Xms512m`                     |
| `-Xmx<size>`                     | æœ€å¤§å †å¤§å°          | `-Xmx2g`                       |
| `-Xmn<size>`                     | æ–°ç”Ÿä»£å¤§å°          | `-Xmn512m`                     |
| `-XX:MaxDirectMemorySize=<size>` | æœ€å¤§ç›´æ¥å†…å­˜å¤§å°ï¼ˆNIOç”¨ï¼‰ | `-XX:MaxDirectMemorySize=256m` |
| `-XX:MetaspaceSize=<size>`       | å…ƒç©ºé—´åˆå§‹å¤§å°ï¼ˆJDK8+ï¼‰ | `-XX:MetaspaceSize=128m`       |
| `-XX:MaxMetaspaceSize=<size>`    | å…ƒç©ºé—´æœ€å¤§å€¼         | `-XX:MaxMetaspaceSize=512m`    |
#### åƒåœ¾å›æ”¶å™¨é€‰æ‹©å‚æ•°

|å‚æ•°|è¯´æ˜|
|---|---|
|`-XX:+UseSerialGC`|å•çº¿ç¨‹æ”¶é›†å™¨ï¼Œé€‚åˆå°å†…å­˜|
|`-XX:+UseParallelGC`|ååé‡ä¼˜å…ˆï¼Œé»˜è®¤å¹¶è¡Œæ”¶é›†å™¨|
|`-XX:+UseConcMarkSweepGC`|CMS æ”¶é›†å™¨ï¼ˆJDK9å¼ƒç”¨ï¼‰|
|`-XX:+UseG1GC`|G1 æ”¶é›†å™¨ï¼ˆæ¨è JDK8 ä¹‹åï¼‰|
|`-XX:+UseZGC`|ZGCï¼ˆä½å»¶è¿Ÿï¼ŒJDK11+ï¼‰|
|`-XX:+UseShenandoahGC`|çº¢å¸½ Shenandoahï¼ˆä½åœé¡¿ï¼ŒJDK12+ï¼‰|
#### åƒåœ¾å›æ”¶æ—¥å¿—ç›¸å…³å‚æ•°

| å‚æ•°                                             | è¯´æ˜              |
| ---------------------------------------------- | --------------- |
| `-verbose:gc`                                  | ç®€å•è¾“å‡ºGCæ—¥å¿—        |
| `-XX:+PrintGCDetails`                          | è¾“å‡ºGCè¯¦ç»†ä¿¡æ¯        |
| `-XX:+PrintGCDateStamps`                       | è¾“å‡ºGCæ—¶é—´æˆ³         |
| `-Xloggc:<file>`                               | å°†GCæ—¥å¿—å†™å…¥æ–‡ä»¶ï¼ˆJDK8ï¼‰ |
| `-Xlog:gc*:file=gc.log:time,uptime,level,tags` | JDK9+ æ–°æ—¥å¿—ç³»ç»Ÿ     |
#### JVM æ€§èƒ½ä¸è¯Šæ–­å‚æ•°ï¼ˆé‡ç‚¹ï¼‰

| å‚æ•°                                | è¯´æ˜                              |
| --------------------------------- | ------------------------------- |
| `-XX:+PrintFlagsFinal`            | æ‰“å°æ‰€æœ‰JVMå‚æ•°åŠé»˜è®¤å€¼                   |
| `-XX:+HeapDumpOnOutOfMemoryError` | OOMæ—¶ç”Ÿæˆå †è½¬å‚¨æ–‡ä»¶ï¼Œæ–‡ä»¶æ­é…visualVMçš„è£…å…¥åŠŸèƒ½æŸ¥çœ‹ |
| `-XX:HeapDumpPath=<path>`         | æŒ‡å®š OOM è½¬å‚¨æ–‡ä»¶è·¯å¾„                   |
| `-XX:+PrintCompilation`           | æ‰“å°JITç¼–è¯‘ä¿¡æ¯                       |
| `-XX:+PrintClassHistogram`        | æ‰“å°ç±»ç›´æ–¹å›¾ï¼ˆç”¨äºè¯Šæ–­å†…å­˜ï¼‰                  |
| `-XX:+UseCompressedOops`          | å‹ç¼©æ™®é€šå¯¹è±¡æŒ‡é’ˆï¼ˆé»˜è®¤å¼€å¯ï¼‰                  |
| `-XX:+UseCompressedClassPointers` | å‹ç¼©ç±»æŒ‡é’ˆï¼ˆé»˜è®¤å¼€å¯ï¼‰                     |
#### JIT ç¼–è¯‘ç›¸å…³å‚æ•°

|å‚æ•°|è¯´æ˜|
|---|---|
|`-XX:+TieredCompilation`|åˆ†å±‚ç¼–è¯‘ï¼ˆé»˜è®¤å¯ç”¨ï¼‰|
|`-XX:CompileThreshold=<n>`|æ§åˆ¶çƒ­ç‚¹ä»£ç è§¦å‘ç¼–è¯‘çš„é˜ˆå€¼|
|`-XX:+PrintInlining`|æ‰“å°å†…è”ä¼˜åŒ–ä¿¡æ¯|
#### çº¿ç¨‹ä¸æ ˆè®¾ç½®

|å‚æ•°|è¯´æ˜|
|---|---|
|`-Xss<size>`|æ¯ä¸ªçº¿ç¨‹çš„æ ˆå¤§å°ï¼Œé»˜è®¤1M|
#### ç³»ç»Ÿç¨³å®šæ€§ä¿éšœ

| å‚æ•°                             | è¯´æ˜                   |
| ------------------------------ | -------------------- |
| `-XX:+ExitOnOutOfMemoryError`  | OOMæ—¶ç«‹å³é€€å‡ºJVMï¼ˆè€Œä¸æ˜¯å°è¯•æ¢å¤ï¼‰ |
| `-XX:+CrashOnOutOfMemoryError` | OOMæ—¶ç”Ÿæˆé”™è¯¯æ—¥å¿—           |
### 2. JVMå†…å­˜æ³„æ¼æ’æŸ¥
```cmd
# æŸ¥ PID
jps -l

# Dumpå †æ–‡ä»¶ï¼Œæ–‡ä»¶æ­é…visualVMçš„è£…å…¥åŠŸèƒ½æŸ¥çœ‹
jmap -dump:format=b,file=heap.hprof <pid>

# å®æ—¶å†…å­˜ç›‘æ§
jstat -gc <pid> 1000 10

# å¼ºåˆ¶ Full GC
jcmd <pid> GC.run

# æŸ¥çœ‹ç±»åŠ è½½æƒ…å†µ
jcmd <pid> GC.class_histogram
```
### 3. CPUé£™é«˜
```linux
top # æŸ¥çœ‹cpuçš„è¿›ç¨‹å ç”¨æƒ…å†µ
ps H -eo pid,tid,%cpu | grep [pid]  # æŸ¥çœ‹æŒ‡å®šè¿›ç¨‹çš„æ‰€æœ‰çº¿ç¨‹ï¼Œå’Œçº¿ç¨‹çš„cpuä½¿ç”¨æƒ…å†µï¼Œæ‰¾åˆ°å ç”¨è¾ƒé«˜çš„çº¿ç¨‹
jstack [pid]  # è·Ÿè¿›æŒ‡å®šè¿›ç¨‹ï¼Œæ‰¾åˆ°å ç”¨é«˜çš„çº¿ç¨‹ï¼ŒæŸ¥çœ‹ä»£ç é—®é¢˜
```
# è®¾è®¡æ¨¡å¼
## ä¸€. å·¥å‚æ¨¡å¼
### 1. ç®€å•å·¥å‚
ç”¨ä¸€ä¸ªâ€œå·¥å‚ç±»â€æ¥å°è£…å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹ï¼Œå®¢æˆ·ç«¯åªéœ€è¦å‘Šè¯‰å·¥å‚â€œæˆ‘æƒ³è¦å“ªç§ç±»å‹â€ï¼Œå·¥å‚å°±ä¼šè¿”å›å¯¹åº”çš„å®ä¾‹
```txt
          +----------------+
          |  Factory å·¥å‚ç±» |
          +----------------+
                   |
                   | æ ¹æ®æ¡ä»¶ï¼ˆä¼ å‚ï¼‰é€‰æ‹©åˆ›å»ºå“ªä¸ªäº§å“
                   â†“
        +----------+-----------+
        |                      |
+---------------+     +---------------+
|  ProductAç±»    |     |  ProductBç±»    |
+---------------+     +---------------+
```
```java
package simpleFactory;  
  
public interface Coffee {  
  
    String getName();  
  
    void addMilk();  
  
    void addSugar();  
  
    class goodCoffee implements Coffee {  
  
        private final String name;  
  
        public goodCoffee(String name) {  
            this.name = name;  
        }  
  
        @Override  
        public String getName() {  
            return name;  
        }  
  
        @Override  
        public void addMilk() {  
            System.out.println("Adding milk to " + name);  
        }  
  
        @Override  
        public void addSugar() {  
            System.out.println("Adding sugar to " + name);  
        }  
    }  
    class badCoffee implements Coffee {  
  
        private final String name;  
  
        public badCoffee(String name) {  
            this.name = name;  
        }  
  
        @Override  
        public String getName() {  
            return name;  
        }  
  
        @Override  
        public void addMilk() {  
            System.out.println("Adding milk to " + name);  
        }  
  
        @Override  
        public void addSugar() {  
            System.out.println("Adding sugar to " + name);  
        }  
    }  
}
```
```java
public class simpleCoffeeFactory {  
    public Coffee createCoffee(String type, String name) {  
        if ("good".equalsIgnoreCase(type)) {  
            return new Coffee.goodCoffee(name);  
        } else if ("bad".equalsIgnoreCase(type)) {  
            return new Coffee.badCoffee(name);  
        } else {  
            throw new IllegalArgumentException("Unknown coffee type: " + type);  
        }  
    }  
}
```
```java
public class CoffStore{  
    public Coffee OrderCoffee(String type, String name) {  
        simpleCoffeeFactory factory = new simpleCoffeeFactory();  
        return factory.createCoffee(type, name);  
    }  
}
```
- å®¢æˆ·ç«¯æ— éœ€çŸ¥é“å…·ä½“ç±»åï¼Œåªéœ€ä¼ å…¥â€œæ ‡è¯†â€ï¼Œ**é™ä½è€¦åˆ**
- é›†ä¸­ç®¡ç†åˆ›å»ºé€»è¾‘ï¼Œ**ä¾¿äºç»´æŠ¤å’Œä¿®æ”¹**
- **ä¾¿äºæ‰©å±•**ï¼ˆåˆæœŸç‰ˆæœ¬ï¼Œé€‚åˆäº§å“ç§ç±»è¾ƒå°‘ï¼‰
- ä¸€æ—¦å­ç±»ç§ç±»è¿‡å¤šï¼Œif-elseåˆ†æ”¯ä¼šéå¸¸è‡ƒè‚¿ï¼Œä¸åˆ©äºæ‰©å±•ï¼Œè¿èƒŒäº† **å¼€é—­åŸåˆ™ï¼ˆå¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ï¼‰**
### 2. å·¥å‚æ–¹æ³•è®¾è®¡æ¨¡å¼
å·¥å‚æ–¹æ³•æ¨¡å¼çš„æ ¸å¿ƒæ˜¯ **å°†â€œåˆ›å»ºå¯¹è±¡çš„èŒè´£â€ä»â€œå·¥å‚ç±»â€ä¸­æŠ½è±¡å‡ºæ¥äº¤ç»™å­ç±»å®ç°**
**æ¯ç§äº§å“æœ‰è‡ªå·±çš„å·¥å‚ï¼Œæ¯ä¸ªå·¥å‚åªè´Ÿè´£åˆ›å»ºä¸€ç§äº§å“**
```txt
      +-----------------+
      |  Product æ¥å£   |
      +-----------------+
             â–²
     +-------+--------+
     |                |
+-----------+   +-----------+
| ProductA  |   | ProductB  |
+-----------+   +-----------+

      +---------------------+
      | Factory æ¥å£        |
      +---------------------+
             â–²
     +-------+--------+
     |                |
+------------+  +-------------+
| FactoryA   |  | FactoryB    |
+------------+  +-------------+
```
```java
public interface CoffeeFactory {  
    Coffee createCoffee();  
}
```
```java
public class goodCoffeeFactory implements CoffeeFactory {  
    @Override  
    public Coffee createCoffee() {return new Coffee.goodCoffee("Good Coffee");  
    }  
}

public class badCoffeeFactory implements CoffeeFactory {  
    @Override  
    public simpleFactory.Coffee createCoffee() {  
        return new simpleFactory.Coffee.badCoffee("Bad Coffee");  
    }  
}
```
```java
public class CoffeeStore {  
  
    private final CoffeeFactory coffeeFactory;  
  
    public CoffeeStore(CoffeeFactory coffeeFactory) {  
        this.coffeeFactory = coffeeFactory;  
    }  
  
    public Coffee orderCoffee() {  
        return coffeeFactory.createCoffee();  
    }  
}
```
- æ¯ä¸ªäº§å“æœ‰è‡ªå·±çš„å·¥å‚ï¼Œ**æ¸…æ™°èŒè´£åˆ’åˆ†**
- æ–°å¢äº§å“æ—¶åªéœ€æ–°å¢å¯¹åº”å·¥å‚ç±»ï¼Œä¸æ”¹åŸæœ‰é€»è¾‘ï¼Œ**ç¬¦åˆå¼€é—­åŸåˆ™**
- æ˜“äºç»„åˆå…¶ä»–è®¾è®¡æ¨¡å¼ï¼ˆå¦‚æ¨¡æ¿æ–¹æ³•ã€ç­–ç•¥ï¼‰
- ç±»çš„æ•°é‡å¢åŠ 
- å®¢æˆ·ç«¯éœ€è¦çŸ¥é“å…·ä½“å·¥å‚ç±»ï¼ˆå¯é€šè¿‡é…ç½®ã€åå°„è§£è€¦ï¼‰
### 3.  æŠ½è±¡å·¥å‚æ¨¡å¼
**æŠ½è±¡å·¥å‚æ¨¡å¼ï¼ˆAbstract Factoryï¼‰** æä¾›ä¸€ä¸ªæ¥å£ï¼Œ**ç”¨äºåˆ›å»ºâ€œä¸€ç³»åˆ—ç›¸å…³/ä¾èµ–çš„å¯¹è±¡â€ï¼Œè€Œä¸æŒ‡å®šå®ƒä»¬å…·ä½“çš„ç±»**
```txt
        +--------------------------+
        | AbstractFactory æŠ½è±¡å·¥å‚ |
        +--------------------------+
              /           \
   +----------------+   +----------------+
   | MacFactory     |   | WindowsFactory |
   +----------------+   +----------------+
        |                      |
  ----------------      ------------------
  |              |      |                |
Button         Checkbox Button         Checkbox
```
```java
//äº§å“æ¥å£
public interface Button {
    void click();
}

public interface Checkbox {
    void check();
}
```
```java
//å…·ä½“äº§å“
public class MacButton implements Button {
    public void click() {
        System.out.println("MacæŒ‰é’®ç‚¹å‡»");
    }
}

public class WindowsButton implements Button {
    public void click() {
        System.out.println("WindowsæŒ‰é’®ç‚¹å‡»");
    }
}

public class MacCheckbox implements Checkbox {
    public void check() {
        System.out.println("Macå¤é€‰æ¡†å‹¾é€‰");
    }
}

public class WindowsCheckbox implements Checkbox {
    public void check() {
        System.out.println("Windowså¤é€‰æ¡†å‹¾é€‰");
    }
}
```
```java
//æŠ½è±¡å·¥å‚æ¥å£ï¼Œå®šä¹‰ç”Ÿäº§æ‰€æœ‰â€œç§ç±»â€ï¼ˆçˆ¶ç±»äº§å“æ¥å£ï¼‰çš„æ–¹æ³•
public interface GUIFactory {
    Button createButton();
    Checkbox createCheckbox();
}
```
```java
//äº§å“æ—å·¥å‚
public class MacFactory implements GUIFactory {
    public Button createButton() {
        return new MacButton();
    }
    public Checkbox createCheckbox() {
        return new MacCheckbox();
    }
}

public class WindowsFactory implements GUIFactory {
    public Button createButton() {
        return new WindowsButton();
    }
    public Checkbox createCheckbox() {
        return new WindowsCheckbox();
    }
}
```
## äºŒ. ç­–ç•¥æ¨¡å¼
### 1. ç­–ç•¥æ¨¡å¼
ç­–ç•¥æ¨¡å¼ï¼š**å®šä¹‰ä¸€ç³»åˆ—ç®—æ³•ï¼ˆç­–ç•¥ï¼‰ï¼ŒæŠŠå®ƒä»¬ä¸€ä¸ªä¸ªå°è£…èµ·æ¥ï¼Œå¹¶ä¸”ä½¿å®ƒä»¬å¯ä»¥äº’ç›¸æ›¿æ¢**
```txt
        +------------------+
        |   Strategy æ¥å£   |
        +------------------+
           â–²         â–²
           |         |
+----------------+  +----------------+
| ConcreteStrategyA | ConcreteStrategyB |
+----------------+  +----------------+

        +------------------+
        |    Contextç±»      |
        +------------------+
        | - strategy:Strategy |
        +------------------+
        | +setStrategy(...) |
        | +executeStrategy()|
        +------------------+
```
```java
//åˆ™ç•¥è§„åˆ™
public interface PaymentStrategy {
    void pay(double amount);
}
```
```java
//å…·ä½“ç­–ç•¥å®ç°
public class AlipayStrategy implements PaymentStrategy {
    public void pay(double amount) {
        System.out.println("ä½¿ç”¨æ”¯ä»˜å®æ”¯ä»˜ï¼š" + amount + "å…ƒ");
    }
}

public class WeChatStrategy implements PaymentStrategy {
    public void pay(double amount) {
        System.out.println("ä½¿ç”¨å¾®ä¿¡æ”¯ä»˜ï¼š" + amount + "å…ƒ");
    }
}
```
```java
//ä¸Šä¸‹æ–‡ç±»ï¼Œå¯ä»¥åˆ‡æ¢ç­–ç•¥
public class PaymentContext {
    private PaymentStrategy strategy;

    public void setStrategy(PaymentStrategy strategy) {
        this.strategy = strategy;
    }

    public void execute(double amount) {
        if (strategy == null) {
            throw new IllegalStateException("è¿˜æ²¡è®¾ç½®æ”¯ä»˜ç­–ç•¥");
        }
        strategy.pay(amount);
    }
}
```
```java
public class Client {
    public static void main(String[] args) {
        PaymentContext context = new PaymentContext();

        context.setStrategy(new AlipayStrategy());
        context.execute(100.0);  // æ”¯ä»˜å®æ”¯ä»˜

        context.setStrategy(new WeChatStrategy());
        context.execute(200.0);  // å¾®ä¿¡æ”¯ä»˜
    }
}
```
## ä¸‰. è´£ä»»é“¾æ¨¡å¼
æŠŠå¤šä¸ªå¯¹è±¡ç”¨é“¾æ¡ä¸²èµ·æ¥ï¼Œè®©è¯·æ±‚æ²¿ç€é“¾ä¼ é€’ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½å¯ä»¥é€‰æ‹©å¤„ç†è¯·æ±‚æˆ–æ”¾è¡Œ

| è§’è‰²                      | èŒè´£                           |
| ----------------------- | ---------------------------- |
| `Handler` æŠ½è±¡å¤„ç†è€…         | å®šä¹‰å¤„ç†è¯·æ±‚çš„æ¥å£ï¼Œé€šå¸¸åŒ…å«ä¸€ä¸ªæŒ‡å‘ä¸‹ä¸€ä¸ªå¤„ç†è€…çš„å¼•ç”¨ã€‚ |
| `ConcreteHandler` å…·ä½“å¤„ç†è€… | å®ç°å¤„ç†é€»è¾‘ï¼Œåˆ¤æ–­æ˜¯å¦å¤„ç†è¯·æ±‚ï¼Œæˆ–è€…ä¼ é€’ç»™ä¸‹ä¸€ä¸ªå¤„ç†è€…ã€‚ |
| `Client` è¯·æ±‚è€…            | åˆ›å»ºå¤„ç†é“¾å¹¶æäº¤è¯·æ±‚ã€‚                  |
```java
// æŠ½è±¡å¤„ç†è€…
abstract class Handler {
    protected Handler next;

    public void setNext(Handler next) {
        this.next = next;
    }

    public abstract void handleRequest(String request);
}

// å…·ä½“å¤„ç†è€…A
class ConcreteHandlerA extends Handler {
    public void handleRequest(String request) {
        if (request.contains("A")) {
            System.out.println("ConcreteHandlerA å¤„ç†äº†è¯·æ±‚: " + request);
        } else if (next != null) {
            next.handleRequest(request);
        }
    }
}

// å…·ä½“å¤„ç†è€…B
class ConcreteHandlerB extends Handler {
    public void handleRequest(String request) {
        if (request.contains("B")) {
            System.out.println("ConcreteHandlerB å¤„ç†äº†è¯·æ±‚: " + request);
        } else if (next != null) {
            next.handleRequest(request);
        }
    }
}

// å®¢æˆ·ç«¯
public class Main {
    public static void main(String[] args) {
        Handler h1 = new ConcreteHandlerA();
        Handler h2 = new ConcreteHandlerB();
        h1.setNext(h2);

        h1.handleRequest("åŒ…å«Açš„è¯·æ±‚");
        h1.handleRequest("åŒ…å«Bçš„è¯·æ±‚");
        h1.handleRequest("æœªçŸ¥è¯·æ±‚");
    }
}
```
# å®è·µ
## ä¸€. å•ç‚¹ç™»å½•
åœ¨å¤šä¸ªç³»ç»Ÿä¸­ï¼Œ**ç”¨æˆ·åªéœ€è¦ç™»å½•ä¸€æ¬¡**ï¼Œå°±å¯ä»¥è®¿é—®å…¶ä»–æ‰€æœ‰ç›¸äº’ä¿¡ä»»çš„ç³»ç»Ÿï¼Œè€Œæ— éœ€é‡å¤ç™»å½•
### 1. åŸºäº Cookie çš„ SSOï¼ˆåŒåŸŸåæˆ–çˆ¶å­åŸŸåï¼‰
- ç³»ç»Ÿä¹‹é—´å…±äº«ä¸€çº§åŸŸåï¼ˆå¦‚ `a.example.com`ã€`b.example.com`ï¼‰
- ç™»å½•æ—¶è®¾ç½®çˆ¶åŸŸå Cookieï¼ˆå¦‚ `.example.com`ï¼‰ï¼Œæ‰€æœ‰å­ç³»ç»Ÿéƒ½èƒ½å¸¦ä¸Šå®ƒ
- ä¾èµ–æµè§ˆå™¨è‡ªåŠ¨ä¼  Cookie çš„ç‰¹æ€§
- é¦–æ¬¡ç™»å½•æ—¶ä¿å­˜jsessionIdåˆ°å…¬å…±åŸŸåä¸‹ï¼Œè®¿é—®å­ç³»ç»Ÿæ—¶ï¼Œé€šè¿‡è¯·æ±‚æ‹¦æˆªå™¨åˆ¤æ–­æºå¸¦çš„cookieé‡Œæœ‰æ²¡æœ‰å¯¹åº”çš„jsessionId
- é€‚ç”¨äºå­ç³»ç»Ÿå¤„äºåŒä¸€åŸŸåä¸‹çš„æƒ…å†µ
```java
//é…ç½®jsessionIdçš„ä½œç”¨åŸŸå’Œåç§°
@Bean  
public CookieSerializer cookieSerializer() {  
    DefaultCookieSerializer defaultCookieSerializer = new DefaultCookieSerializer();  
    //æ”¾å¤§ä½œç”¨åŸŸï¼Œè®©ä¸åŒåŸŸåçš„å­˜å‚¨çš„cookieå¯ä»¥å…±äº«  
    defaultCookieSerializer.setDomainName(CookieConstant.JSESSIONID_DOMAIN);  
    defaultCookieSerializer.setCookieName(CookieConstant.JSESSIONID_NAME);  
    return defaultCookieSerializer;  
}  
  
/**  
 *é…ç½®rediså­˜å‚¨sessionçš„åºåˆ—åŒ–æ–¹å¼  
 */  
@Bean  
public RedisSerializer<Object> springSessionDefaultRedisSerializer() {  
    return new GenericJackson2JsonRedisSerializer();  
}
```
```java
@Override  
public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {  
  
    UserInfoVo userInfoVo = new UserInfoVo(); 
    //ä¼šè‡ªåŠ¨é€šè¿‡jsessionIdè·å–å¯¹åº”çš„sessionå¯¹è±¡ 
    HttpSession session = request.getSession();  
    MemberDTO loginUser = (MemberDTO)session.getAttribute(redisConstant.LOGIN_USER);  
    if (loginUser!= null){  
        //å¦‚æœç™»å½•ï¼Œç”¨æˆ·ä¿¡æ¯å°±åº”è¯¥åŒ…å«ç”¨æˆ·idï¼Œåé¢å°†æ ¹æ®ç”¨æˆ·idæŸ¥è¯¢è´­ç‰©è½¦ä¿¡æ¯  
        userInfoVo.setUserId(loginUser.getId());  
    }  
  
    //ä»cookieä¸­è·å–ç¦»çº¿çš„è´­ç‰©è½¦çš„cookie  
    Cookie[] cookies = request.getCookies();  
    if (cookies != null){  
        for (Cookie cookie : cookies){  
            if (cookie.getName().equals(CartConstant.TEMP_USER_COOKIE_NAME)){  
                userInfoVo.setUserKey(cookie.getValue());  
                userInfoVo.setTempUser(true);  
                break;  
            }  
        }  
    }  
  
    //å¦‚æœæ²¡æœ‰ç›¸å…³çš„ç¦»çº¿çŠ¶æ€çš„è´­ç‰©è½¦cookieï¼Œå°±åˆ›å»ºä¸€ä¸ªï¼Œ  
    // åˆå› ä¸ºcookieæ˜¯éšæœºçš„è€Œä¸”æ¯å°ç”µè„‘ä¸Šæµè§ˆå™¨ä¿å­˜çš„éƒ½ä¸ä¸€æ ·ï¼Œä¿è¯äº†ï¼Œæ¯ä¸ªæµè§ˆå™¨ä¸Šéƒ½æ˜¯è‡ªå·±çš„ç¦»çº¿è´­ç‰©è½¦  
    if(userInfoVo.getUserKey() == null){  
        userInfoVo.setUserKey(UUID.randomUUID().toString());  
    }  
  
    threadLocal.set(userInfoVo);  
  
    return HandlerInterceptor.super.preHandle(request, response, handler);  
}
```
### 2. åŸºäº Token + è®¤è¯ä¸­å¿ƒ çš„ SSOï¼ˆè·¨åŸŸæ”¯æŒï¼‰
|è§’è‰²|è¯´æ˜|
|---|---|
|ç”¨æˆ·ç³»ç»Ÿï¼ˆClientï¼‰|å„ä¸ªéœ€è¦ç™»å½•çš„å­ç³»ç»Ÿ|
|SSOè®¤è¯ä¸­å¿ƒ|è´Ÿè´£ç™»å½•æ ¡éªŒã€ç­¾å‘ä»¤ç‰Œï¼ˆå¦‚JWTæˆ–sessionIdï¼‰|
|Token/Cookie|ç”¨æˆ·ç™»å½•æˆåŠŸåçš„â€œé€šè¡Œè¯â€|
|å­˜å‚¨ä¸­å¿ƒï¼ˆå¯é€‰ï¼‰|å­˜æ”¾sessionã€tokené»‘åå•ç­‰ï¼ˆå¯é€‰ Redisã€JWTè‡ªèº«æºå¸¦ï¼‰|
```java
@Configuration  
@EnableWebSecurity  
public class AuthorizationConfig {  
  
    /**  
     * æ³¨å†Œå®¢æˆ·ç«¯ä¿¡æ¯  
     * @return RegisteredClientRepository  
     */    @Bean  
    public RegisteredClientRepository registeredClientRepository() {  
        RegisteredClient registeredClient = RegisteredClient.withId(UUID.randomUUID().toString())  
                .clientId("AuthorizationServer")  
                .clientSecret("{noop}123456")  
                .authorizationGrantType(AuthorizationGrantType.AUTHORIZATION_CODE)  
                .redirectUri("http://localhost:8080/login/oauth2/code/AuthorizationServer")  
                .scope("read")  
                .build();  
        return new InMemoryRegisteredClientRepository(registeredClient);  
    }  
  
    /**  
     * è‡ªå®šä¹‰ OAuth2UserService ä»¥å¤„ç†ç”¨æˆ·ä¿¡æ¯  
     * @return OAuth2UserService  
     */    @Bean  
    public OAuth2UserService<OAuth2UserRequest, OAuth2User> customOAuth2UserService() {  
        return userRequest -> (OidcUser) new DefaultOAuth2UserService().loadUser(userRequest);  
    }  
  
    /**  
     * é…ç½®å®‰å…¨è¿‡æ»¤é“¾  
     * @param http  HttpSecurity å¯¹è±¡  
     * @param customOAuth2UserService   è‡ªå®šä¹‰ OAuth2UserService  
     * @return  è¿‡æ»¤å™¨é“¾  
     */  
    @Bean  
    public SecurityFilterChain securityFilterChain(HttpSecurity http, OAuth2UserService<OAuth2UserRequest, OAuth2User> customOAuth2UserService) throws Exception {  
        http.authorizeHttpRequests(auth -> auth.requestMatchers("/public/**").permitAll().anyRequest().authenticated())  
                .oauth2Login(oath -> oath.loginPage("login").userInfoEndpoint(userInfo -> userInfo.userService(customOAuth2UserService)));  
        return http.build();  
    }  
  
    /**  
     * é…ç½®æˆæƒæœåŠ¡å™¨è®¾ç½®  
     * @return AuthorizationServerSettings  
     */    @Bean  
    public AuthorizationServerSettings authorizationServerSettings() {  
        return AuthorizationServerSettings.builder()  
                .issuer("http://localhost:9000") // è®¾ç½®æˆæƒæœåŠ¡å™¨çš„ issuer                .build();  
    }  
  
    /**  
     * ç”Ÿæˆ JWKSourceï¼Œç”¨äº JWT ç¼–ç å™¨  
     */  
    @Bean  
    public JWKSource<SecurityContext> jwkSource() throws NoSuchAlgorithmException {  
        KeyPair keyPair = KeyPairGenerator.getInstance("RSA").generateKeyPair();  
        RSAKey key = new RSAKey.Builder((RSAPublicKey) keyPair.getPublic())  
                .privateKey((RSAPrivateKey) keyPair.getPrivate())  
                .build();  
        return (jwkSelector, ctx) -> jwkSelector.select(new JWKSet(key));  
    }  
  
    /**  
     * JWT ç¼–ç å™¨ Bean  
     * @param jwkSource JWKSource<SecurityContext> ç”¨äºæä¾› JWK  
     * @return  
     */  
    @Bean  
    public JwtEncoder jwtEncoder(JWKSource<SecurityContext> jwkSource) {  
        return new NimbusJwtEncoder(jwkSource);  
    }  
}
```
## äºŒ. ä¸Šä¼ æ•°æ®å®‰å…¨æ€§